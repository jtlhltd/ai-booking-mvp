<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Client Dashboard - AI Booking Concierge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #5c6ac4;
            --secondary: #3a4a9f;
            --success: #1b5e20;
            --warning: #f5a623;
            --danger: #c62828;
            --light: #f7f9fc;
            --dark: #1f2234;
            --card-shadow: 0 8px 24px rgba(16, 26, 62, 0.08);
            --surface: #ffffff;
            --text: #2b2e3b;
            --muted: #6f7390;
        }

        body[data-theme="dark"] {
            --surface: #252b3d;
            --text: #ffffff;
            --muted: #d0d4e8;
            --light: #2a3145;
            background: radial-gradient(circle at top, #1f2640, #0f1324);
            color: var(--text);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: inherit;
        }
        
        body, html {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #eef2ff 0%, #e3ebff 40%, #fef9ff 100%);
            color: #2b2e3b;
            line-height: 1.5;
            font-feature-settings: 'cv02', 'cv03', 'cv04';
        }

        /* Ensure all text elements use Inter */
        h1, h2, h3, h4, h5, h6, p, span, div, a, button, input, textarea, select, label, li, td, th, strong, em, small, b, i, u, mark, del, ins, sub, sup {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px 72px;
        }
        
        .header {
            background: var(--surface);
            border-radius: 20px;
            padding: 28px 32px;
            box-shadow: var(--card-shadow);
            border-left: 6px solid var(--primary);
            border: 1px solid rgba(92,106,196,0.15);
        }
        
        .client-info {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .client-brand {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        
        .client-logo {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: #fff;
            background: var(--primary);
        }
        
        .client-details h1 {
            font-size: 2.3rem;
            color: var(--primary);
            margin-bottom: 6px;
        }
        
        .client-details p {
            color: var(--muted);
            font-size: 1rem;
            margin-top: 4px;
        }

        .status-chip {
            padding: 10px 20px;
            border-radius: 999px;
            font-weight: 600;
            background: rgba(92, 106, 196, 0.1);
            color: var(--primary);
        }

        body[data-theme="dark"] .status-chip {
            background: rgba(92,106,196,0.3);
            color: #d5d9ff;
        }

        .client-meta {
            margin-top: 18px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .meta-item {
            background: var(--light);
            border-radius: 12px;
            padding: 12px 16px;
        }

        .meta-label {
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            color: #8c8fab;
            margin-bottom: 4px;
        }

        .meta-value {
            font-weight: 600;
            color: #2f3147;
        }

        .demo-banner {
            margin-top: 18px;
            padding: 14px 18px;
            border-radius: 14px;
            background: #fff8e1;
            border-left: 4px solid #f5a623;
            color: #7a4f00;
            display: none;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 22px;
            margin: 30px 0;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            padding: 18px;
            box-shadow: var(--card-shadow);
            text-align: center;
            border: 1px solid rgba(92,106,196,0.1);
            position: relative;
            overflow: hidden;
        }

        .status-card h4 {
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-size: 0.75rem;
            color: #8c8fab;
            margin-bottom: 10px;
        }

        .status-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .status-hint {
            margin-top: 6px;
            font-size: 0.85rem;
            color: #8c8fab;
        }

        .dashboard-section {
            margin-bottom: 48px;
        }

        .section-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(92,106,196,0.15);
            position: relative;
        }

        .section-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), transparent);
            border-radius: 2px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 22px;
        }

        .card-chart {
            min-height: 280px;
        }

        .card-visual {
            min-height: 240px;
        }

        .card-list {
            min-height: 300px;
        }

        .card-metrics {
            min-height: 200px;
        }

        .card-fullwidth {
            grid-column: 1 / -1;
        }

        .priority-visual {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 8px 0;
        }

        .priority-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .priority-label {
            min-width: 120px;
            font-size: 0.9rem;
            color: #7a7fa4;
        }

        .priority-progress {
            flex: 1;
            height: 24px;
            background: rgba(92,106,196,0.08);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .priority-progress-fill {
            height: 100%;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            color: #fff;
        }

        .priority-progress-fill.high {
            background: linear-gradient(90deg, #1b5e20, #2e7d32);
        }

        .priority-progress-fill.medium {
            background: linear-gradient(90deg, #f5a623, #ff9800);
        }

        .priority-progress-fill.low {
            background: linear-gradient(90deg, #7a7fa4, #9ca3af);
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 8px 0;
        }

        .activity-metric {
            text-align: center;
            padding: 16px;
            background: rgba(92,106,196,0.06);
            border-radius: 12px;
            border: 1px solid rgba(92,106,196,0.12);
        }

        .activity-metric-label {
            font-size: 0.85rem;
            color: #7a7fa4;
            margin-bottom: 8px;
        }

        .activity-metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .status-compact {
            padding: 8px 0;
        }

        .data-freshness {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--muted);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(92,106,196,0.1);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-freshness-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #1b5e20;
            animation: pulse 2s ease-in-out infinite;
        }

        .data-freshness-dot.offline {
            background: #c62828;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(92,106,196,0.1) 25%, rgba(92,106,196,0.15) 50%, rgba(92,106,196,0.1) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 16px;
            margin: 8px 0;
        }

        .skeleton-card {
            padding: 20px;
            border-radius: 18px;
            background: var(--surface);
            border: 1px solid rgba(92,106,196,0.08);
        }

        .empty-state-cta {
            margin-top: 16px;
        }

        .empty-state-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .empty-state-btn:hover {
            background: var(--secondary);
            transform: translateY(-1px);
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 10px;
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .error-message-icon {
            font-size: 1.2rem;
        }

        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--surface);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            color: var(--muted);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(92,106,196,0.1);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .keyboard-hint.show {
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8c8fab;
        }

        .empty-state-icon {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 12px;
            display: block;
        }

        .empty-state-title {
            font-size: 1rem;
            font-weight: 600;
            color: #7a7fa4;
            margin-bottom: 6px;
        }

        .empty-state-message {
            font-size: 0.9rem;
            color: #8c8fab;
            line-height: 1.5;
        }

        .card-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #8c8fab;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(92,106,196,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            position: relative;
        }

        .section-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), transparent);
            border-radius: 2px;
        }
        
        .card {
            background: var(--surface);
            border-radius: 18px;
            padding: 22px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(92,106,196,0.08);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 1;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(16, 26, 62, 0.12);
        }
        
        .card h3 {
            margin-bottom: 18px;
            font-size: 1.2rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-subtitle {
            margin-top: -10px;
            margin-bottom: 16px;
            font-size: 0.92rem;
            color: #7a7da0;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f3fb;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: var(--muted);
        }
        
        .metric-value {
            font-weight: 600;
            color: var(--primary);
        }

        .leads-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 320px;
            overflow-y: auto;
        }

        .lead-item {
            border: 1px solid #eef0fb;
            border-radius: 12px;
            padding: 14px;
            background: #f9f9ff;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .lead-item:hover {
            transform: translateY(-2px);
            border-color: rgba(92,106,196,0.5);
        }

        .lead-name {
            font-weight: 600;
            color: #2f3147;
        }

        .lead-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #7b7f9f;
            margin-top: 6px;
        }

        .lead-status {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            background: rgba(92, 106, 196, 0.12);
            color: var(--primary);
        }
        .theme-toggle {
            border: 1px solid rgba(92,106,196,0.3);
            background: transparent;
            color: var(--primary);
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .theme-toggle:hover {
            background: rgba(92,106,196,0.1);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(7, 11, 30, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(6px);
        }

        .modal-backdrop.open {
            display: flex;
        }

        .lead-modal {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px 28px;
            width: min(480px, 90%);
            box-shadow: 0 30px 60px rgba(11, 14, 32, 0.35);
            border: 1px solid rgba(92,106,196,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .modal-header h4 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text);
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--muted);
        }

        .modal-body p {
            margin: 6px 0;
            color: var(--muted);
        }

        .modal-actions {
            margin-top: 18px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .modal-btn {
            flex: 1;
            min-width: 120px;
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(92,106,196,0.15);
            color: var(--primary);
        }

        .modal-btn.primary {
            background: var(--primary);
            color: #fff;
        }

        .import-dropzone {
            border: 1px dashed rgba(92,106,196,0.5);
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            color: var(--muted);
            cursor: pointer;
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        .import-dropzone.dragover {
            border-color: var(--primary);
            background: rgba(92,106,196,0.08);
        }

        .import-dropzone button {
            border: none;
            background: var(--primary);
            color: #fff;
            padding: 6px 12px;
            border-radius: 8px;
            margin-left: 6px;
            cursor: pointer;
        }

        .import-status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .import-status.success {
            color: #1b5e20;
        }

        .import-status.error {
            color: #c62828;
        }

        .mix-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .mix-item {
            border: 1px solid rgba(92,106,196,0.12);
            border-radius: 12px;
            padding: 12px 14px;
        }

        .mix-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            color: #2f3147;
            margin-bottom: 6px;
        }

        .mix-bar {
            height: 10px;
            border-radius: 999px;
            background: #eef0ff;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .mix-bar-fill {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .mix-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #7a7fa4;
        }

        .mix-tag {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(27, 94, 32, 0.12);
            color: var(--success);
        }

        .appt-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .appt-item {
            border: 1px solid rgba(92,106,196,0.12);
            border-radius: 12px;
            padding: 12px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .appt-name {
            font-weight: 600;
            color: #2f3147;
        }

        .appt-service {
            font-size: 0.85rem;
            color: #7a7fa4;
        }

        .appt-time {
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 600;
            text-align: right;
            min-width: 140px;
        }

        .roi-panel {
            margin-bottom: 24px;
            border-radius: 20px;
            padding: 22px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 18px;
            box-shadow: 0 15px 35px rgba(51, 65, 145, 0.4);
        }

        .roi-metric span {
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.75rem;
            opacity: 0.85;
        }

        .roi-metric strong {
            display: block;
            font-size: 2rem;
            margin-top: 6px;
        }

        .roi-metric small {
            display: block;
            margin-top: 4px;
            opacity: 0.85;
        }

        .integration-list {
            margin-top: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .integration-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(92,106,196,0.12);
            border-radius: 10px;
            padding: 8px 12px;
        }

        .integration-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #2f3147;
            font-weight: 600;
        }

        .integration-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .integration-status {
            font-weight: 600;
            text-transform: capitalize;
        }

        .integration-status.active {
            color: #1b5e20;
        }

        .integration-status.warning {
            color: #f5a623;
        }

        .integration-status.error {
            color: #c62828;
        }

        .chart {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            height: 180px;
            padding: 8px 6px;
        }

        .chart-bar {
            flex: 1;
            border-radius: 8px 8px 4px 4px;
            background: linear-gradient(180deg, rgba(92,106,196,0.85), rgba(58,74,159,0.85));
            position: relative;
        }

        .chart-bar::after {
            content: attr(data-label);
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.85rem;
            color: #8c8fab;
        }

        .chart-value {
            text-align: center;
            margin-top: 8px;
            font-size: 0.9rem;
            color: #616484;
        }

        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid #ecefff;
            background: #fbfbff;
        }

        .activity-item strong {
            color: #2f3147;
        }

        .activity-meta {
            margin-top: 4px;
            color: #8b8fb0;
            font-size: 0.9rem;
        }

        .workflow-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .workflow-step {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .workflow-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(92,106,196,0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }


        .funnel {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 8px 0;
        }

        .funnel-stage {
            position: relative;
            padding: 14px 18px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(92,106,196,0.08), rgba(58,74,159,0.08));
            border: 1px solid rgba(92,106,196,0.15);
        }

        .funnel-label {
            font-weight: 600;
            color: #2f3147;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .funnel-bar {
            height: 8px;
            background: rgba(92,106,196,0.12);
            border-radius: 999px;
            overflow: hidden;
            margin-top: 8px;
        }

        .funnel-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 999px;
            transition: width 0.6s ease;
        }

        .funnel-percent {
            font-size: 0.75rem;
            color: #7a7fa4;
            margin-left: 8px;
        }


        .transcript-btn {
            background: transparent;
            border: 1px solid rgba(92,106,196,0.3);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 6px;
            transition: all 0.2s;
        }

        .transcript-btn:hover {
            background: rgba(92,106,196,0.1);
            border-color: var(--primary);
        }

        .transcript-modal {
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .transcript-content {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.8;
            color: #2f3147;
            white-space: pre-wrap;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 12px;
        }

        .forecast-chart {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            height: 200px;
            padding: 12px 6px;
            margin-top: 16px;
        }

        .forecast-bar {
            flex: 1;
            border-radius: 6px 6px 0 0;
            background: linear-gradient(180deg, rgba(92,106,196,0.6), rgba(92,106,196,0.3));
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 4px;
            color: #fff;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .forecast-bar.predicted {
            background: linear-gradient(180deg, rgba(245,166,35,0.6), rgba(245,166,35,0.3));
            border: 1px dashed rgba(245,166,35,0.8);
        }

        .export-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .export-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .export-btn:hover {
            background: var(--secondary);
            transform: translateY(-1px);
        }

        .export-btn.secondary {
            background: rgba(92,106,196,0.1);
            color: var(--primary);
        }

        .export-btn.secondary:hover {
            background: rgba(92,106,196,0.2);
        }

        .active-indicator {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            color: #fff;
            padding: 12px 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(27,94,32,0.3);
        }

        .active-indicator.pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .active-indicator-dot {
            width: 12px;
            height: 12px;
            background: #4caf50;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .active-indicator-content {
            flex: 1;
        }

        .active-indicator-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .active-indicator-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .call-quality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            padding: 8px 0;
        }

        .quality-metric {
            text-align: center;
            padding: 12px;
            background: rgba(92,106,196,0.05);
            border-radius: 10px;
        }

        .quality-label {
            font-size: 0.75rem;
            color: #7a7fa4;
            margin-bottom: 6px;
        }

        .quality-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        .quality-badge {
            font-size: 0.7rem;
            color: #1b5e20;
            margin-top: 4px;
        }

        .retry-queue {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 8px 0;
        }

        .retry-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: rgba(245,166,35,0.1);
            border-radius: 8px;
            border-left: 3px solid #f5a623;
        }

        .retry-name {
            font-weight: 600;
            color: #2f3147;
            font-size: 0.9rem;
        }

        .retry-meta {
            font-size: 0.75rem;
            color: #7a7fa4;
            margin-top: 2px;
        }

        .retry-status {
            font-size: 0.75rem;
            color: #f5a623;
            font-weight: 600;
        }

        .timeline-modal {
            max-width: 600px;
        }

        .timeline {
            padding: 16px 0;
        }

        .timeline-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-left: 2px solid #e0e0e0;
            margin-left: 16px;
            padding-left: 20px;
            position: relative;
        }

        .timeline-item:last-child {
            border-left: none;
        }

        .timeline-dot {
            position: absolute;
            left: -8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            border: 3px solid #fff;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 600;
            color: #2f3147;
            margin-bottom: 4px;
        }

        .timeline-meta {
            font-size: 0.8rem;
            color: #7a7fa4;
        }


        .recording-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .recording-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: #fff;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .play-btn:hover {
            background: var(--secondary);
            transform: scale(1.1);
        }

        .recording-info {
            flex: 1;
        }

        .recording-name {
            font-weight: 600;
            color: #2f3147;
            font-size: 0.9rem;
        }

        .recording-meta {
            font-size: 0.75rem;
            color: #7a7fa4;
            margin-top: 2px;
        }

        .calendar-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 8px 0;
        }

        .calendar-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 12px;
            background: rgba(92,106,196,0.04);
            border-radius: 8px;
        }

        .calendar-detail-label {
            font-size: 0.85rem;
            color: #7a7fa4;
        }

        .calendar-detail-value {
            font-weight: 600;
            color: #2f3147;
            font-size: 0.85rem;
        }

        .calendar-detail-value.success {
            color: #1b5e20;
        }

        .calendar-detail-value.warning {
            color: #f5a623;
        }

        .timeline-btn {
            background: transparent;
            border: 1px solid rgba(92,106,196,0.3);
            color: var(--primary);
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-top: 4px;
            transition: all 0.2s;
        }

        .timeline-btn:hover {
            background: rgba(92,106,196,0.1);
            border-color: var(--primary);
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
            pointer-events: none;
        }

        .toast {
            background: var(--surface);
            border-radius: 12px;
            padding: 14px 18px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--primary);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            pointer-events: auto;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-in 2.7s;
            animation-fill-mode: forwards;
            min-width: 280px;
            max-width: 400px;
        }

        .toast.success {
            border-left-color: #1b5e20;
        }

        .toast.error {
            border-left-color: #c62828;
        }

        .toast.warning {
            border-left-color: #f5a623;
        }

        .toast.info {
            border-left-color: var(--primary);
        }

        .toast-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: #2f3147;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .toast-message {
            color: #7a7fa4;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .toast-close {
            background: transparent;
            border: none;
            color: #8c8fab;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: #2f3147;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        body[data-theme="dark"] .toast {
            background: #1f2335;
            border-left-color: var(--primary);
        }

        body[data-theme="dark"] .toast-title {
            color: #eef0ff;
        }

        body[data-theme="dark"] .toast-message {
            color: #b1b6d4;
        }

        body[data-theme="dark"] .toast-close {
            color: #b1b6d4;
        }

        body[data-theme="dark"] .toast-close:hover {
            color: #eef0ff;
        }

        /* Dark mode readability improvements - brighter text and better contrast */
        body[data-theme="dark"] .card {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        body[data-theme="dark"] .status-card {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .status-card h4 {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .status-hint {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .card-subtitle {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .lead-item {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .lead-name {
            color: #ffffff;
        }

        body[data-theme="dark"] .lead-meta {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .activity-item {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .activity-item strong {
            color: #ffffff;
        }

        body[data-theme="dark"] .activity-meta {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .meta-label {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .meta-value {
            color: #ffffff;
        }

        body[data-theme="dark"] .metric-label {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .metric-row {
            border-bottom-color: rgba(92,106,196,0.3);
        }

        body[data-theme="dark"] .section-header {
            color: #e8ebff;
            border-bottom-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .header {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .client-details h1 {
            color: #e8ebff;
        }

        body[data-theme="dark"] .client-details p {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .roi-panel {
            background: linear-gradient(135deg, #2f3650 0%, #252b3d 100%);
            border-color: rgba(92,106,196,0.6);
        }

        body[data-theme="dark"] .demo-banner {
            background: #2f3650;
            border-left-color: #f5a623;
            color: #ffd54f;
        }

        body[data-theme="dark"] .active-indicator {
            background: rgba(27, 94, 32, 0.4);
            border-color: rgba(27, 94, 32, 0.6);
        }

        body[data-theme="dark"] .integration-item {
            border-color: rgba(92,106,196,0.4);
        }

        body[data-theme="dark"] .integration-label {
            color: #ffffff;
        }

        body[data-theme="dark"] .integration-status {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .transcript-content {
            background: #252b3d;
            color: #ffffff;
            border: 1px solid rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .timeline-item {
            border-left-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .timeline-title {
            color: #ffffff;
        }

        body[data-theme="dark"] .timeline-meta {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .modal-backdrop {
            background: rgba(0, 0, 0, 0.85);
        }

        body[data-theme="dark"] .lead-modal {
            background: #252b3d;
            border-color: rgba(92,106,196,0.6);
        }

        body[data-theme="dark"] .lead-modal h4 {
            color: #ffffff;
        }

        body[data-theme="dark"] .lead-modal p {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .lead-modal strong {
            color: #ffffff;
        }

        body[data-theme="dark"] .card h3 {
            color: #ffffff;
        }

        body[data-theme="dark"] .status-value {
            color: #a8b4ff;
        }

        body[data-theme="dark"] .funnel-label {
            color: #ffffff;
        }

        body[data-theme="dark"] .funnel-value {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .retry-item {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .retry-item strong {
            color: #ffffff;
        }

        body[data-theme="dark"] .retry-name {
            color: #ffffff !important;
        }

        body[data-theme="dark"] .retry-meta {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .appt-item {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .appt-name {
            color: #ffffff !important;
        }

        body[data-theme="dark"] .appt-service {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .appt-time {
            color: #a8b4ff;
        }
        
        @media (max-width: 768px) {
            .section-header {
                font-size: 1.3rem;
                margin-bottom: 16px;
            }

            .dashboard-section {
                margin-bottom: 32px;
            }

            .activity-grid {
                grid-template-columns: 1fr;
            }
            
            .priority-visual {
                gap: 10px;
            }

            .priority-label {
                min-width: 100px;
                font-size: 0.85rem;
            }

            .toast-container {
                top: 12px;
                right: 12px;
                left: 12px;
                max-width: 100%;
            }

            .toast {
                min-width: auto;
                max-width: 100%;
            }
            .client-info {
                flex-direction: column;
                align-items: flex-start;
            }
            .status-bar {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .roi-panel {
                grid-template-columns: 1fr;
                padding: 16px;
            }
            .export-buttons {
                flex-direction: column;
            }
            .export-btn {
                width: 100%;
                justify-content: center;
            }
            .chart, .forecast-chart {
                height: 150px;
            }
            .funnel {
                gap: 12px;
            }
            .activity-item {
                padding: 12px;
            }
            .lead-item {
                padding: 10px;
            }
            .container {
                padding: 20px 12px 48px;
            }
            .header {
                padding: 20px 16px;
            }
            .card {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="client-info">
                <div class="client-brand">
                    <div class="client-logo" id="clientLogo">✨</div>
                    <div class="client-details">
                        <h1 id="clientName">Your Concierge Dashboard</h1>
                        <p id="clientDescription">See what we're doing for you - calls, follow-ups, and bookings</p>
                        <p id="clientTagline">We chase every lead you already paid for and land them on your calendar.</p>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:12px;">
                    <div class="status-chip" style="background: #1b5e20; color: #fff;" id="conciergeStatus">✓ Concierge Active</div>
                    <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle dark mode">Dark mode</button>
                    <div class="status-chip" id="clientStatus">Live</div>
                </div>
            </div>
            
            <div class="client-meta" id="clientMeta">
                <div class="meta-item">
                    <div class="meta-label">Phone</div>
                    <div class="meta-value" id="metaPhone">+44 20 3880 1234</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Timezone</div>
                    <div class="meta-value" id="metaTimezone">Europe/London</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Coverage</div>
                    <div class="meta-value" id="metaHours">8am - 8pm, 7 days/week</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Industry</div>
                    <div class="meta-value" id="metaIndustry">AI Booking Concierge</div>
            </div>
        </div>
        
            <div class="demo-banner" id="demoBanner">
                <strong>Demo environment:</strong> This sandbox mirrors the live dashboard your clients see. We just preload it with mock data for Looms.
            </div>
        </header>

        <div class="active-indicator pulse" id="activeIndicator">
            <div class="active-indicator-dot"></div>
            <div class="active-indicator-content">
                <div class="active-indicator-title" id="activeTitle">Your concierge is active</div>
                <div class="active-indicator-subtitle" id="activeSubtitle">Working on leads right now</div>
                </div>
            </div>
            
        <section class="status-bar" role="region" aria-label="Dashboard statistics">
            <div class="status-card" title="Total leads we're handling for you" role="article" aria-label="Leads we're managing">
                <h4>Leads We're Managing</h4>
                <div class="status-value" id="statusTotalLeads" aria-live="polite">48</div>
                <p class="status-hint" id="statusHintLeads">7 new in last 24h</p>
                </div>
            <div class="status-card" title="Calls your concierge has made" role="article" aria-label="Calls we've made">
                <h4>Calls We've Made</h4>
                <div class="status-value" id="statusTotalCalls" aria-live="polite">36</div>
                <p class="status-hint" id="statusHintCalls">12 bookings this week</p>
            </div>
            <div class="status-card" title="Conversion rate from our follow-up" role="article" aria-label="Our conversion rate">
                <h4>Our Conversion Rate</h4>
                <div class="status-value" id="statusConversionRate" aria-live="polite">63%</div>
                <p class="status-hint" id="statusHintConversion">84% success rate</p>
            </div>
            <div class="status-card" title="How fast we respond to your leads" role="article" aria-label="Our response time">
                <h4>Our Response Time</h4>
                <div class="status-value" id="statusFirstResponse" aria-live="polite">2m 58s</div>
                <p class="status-hint" id="statusHintResponse">Always under 5 min</p>
            </div>
        </section>

        <section class="roi-panel">
            <div class="roi-metric">
                <span>Your Investment (30d)</span>
                <strong id="roiSpend">£0</strong>
                <small>our service fee</small>
                </div>
            <div class="roi-metric">
                <span>Revenue We Generated</span>
                <strong id="roiRevenue">£0</strong>
                <small id="roiBookings">from bookings we made</small>
            </div>
            <div class="roi-metric">
                <span>Your ROI</span>
                <strong id="roiMultiplier">0x</strong>
                <small id="roiProfit">£0 profit</small>
            </div>
        </section>

        <!-- PERFORMANCE & ANALYTICS SECTION -->
        <section class="dashboard-section">
            <h2 class="section-header">📊 Performance & Analytics</h2>
            <div class="dashboard-grid">
                <article class="card card-chart">
                    <h3>🔄 Conversion Funnel</h3>
                    <p class="card-subtitle">How we convert your leads into bookings.</p>
                    <div id="lead-journey" class="funnel"></div>
                </article>

                <article class="card card-chart">
                    <h3>📊 Weekly Activity</h3>
                    <p class="card-subtitle">Calls and bookings we made this week.</p>
                    <div id="performance-chart">
                        <div class="chart" id="chartBars"></div>
                        <p class="chart-value" id="chartSummary">18 bookings we made this week</p>
                </div>
                    <div class="export-buttons">
                        <button class="export-btn secondary" onclick="exportData('calls')">📥 Export</button>
            </div>
                </article>


                <article class="card">
                    <h3>📊 Call Quality</h3>
                    <p class="card-subtitle">How effective our calls are.</p>
                    <div id="call-quality" class="call-quality-grid"></div>
                </article>
                </div>
        </section>

        <!-- LEAD MANAGEMENT SECTION -->
        <section class="dashboard-section">
            <h2 class="section-header">👥 Lead Management</h2>
            <div class="dashboard-grid">

                <article class="card card-list">
                    <h3>📋 Recent Leads</h3>
                    <p class="card-subtitle">Leads we're actively following up on.</p>
                    <div id="leads-list" class="leads-list"></div>
                    <div class="export-buttons">
                        <button class="export-btn secondary" onclick="exportData('leads')">📥 Export</button>
            </div>
                </article>

                <article class="card">
                    <h3>📤 Upload Leads</h3>
                    <p class="card-subtitle">Send us more leads to follow up on.</p>
                    <div class="import-dropzone" id="leadDropzone">
                        Drag & drop CSV or <button type="button" id="leadImportButton">browse</button>
                        <small style="display:block;margin-top:6px;">Columns: name, phone, service, source</small>
                </div>
                    <input type="file" id="leadImportInput" accept=".csv" style="display:none">
                    <div class="import-status" id="leadImportStatus"></div>
                </article>

                <article class="card">
                    <h3>🔄 Retry Queue</h3>
                    <p class="card-subtitle">Leads we're retrying after initial contact.</p>
                    <div id="retry-queue" class="retry-queue"></div>
                </article>
            </div>
        </section>

        <!-- OPERATIONS SECTION -->
        <section class="dashboard-section">
            <h2 class="section-header">⚡ Daily Operations</h2>
            <div class="dashboard-grid">
                <article class="card card-metrics">
                    <h3>📈 Today's Activity</h3>
                    <p class="card-subtitle">What we accomplished in the last 24 hours.</p>
                    <div id="recent-activity" class="activity-grid"></div>
                </article>

                <article class="card card-list">
                    <h3>📅 Upcoming Appointments</h3>
                    <p class="card-subtitle">Appointments we booked for you.</p>
                    <div id="upcoming-appointments" class="appt-list"></div>
                    <div class="export-buttons">
                        <button class="export-btn secondary" onclick="exportData('appointments')">📥 Export</button>
            </div>
                </article>

                <article class="card card-list">
                    <h3>🎙️ Call Recordings</h3>
                    <p class="card-subtitle">Listen to recent calls we made.</p>
                    <div id="call-recordings"></div>
                </article>
                </div>
        </section>

        <!-- SYSTEM STATUS SECTION -->
        <section class="dashboard-section">
            <h2 class="section-header">⚙️ System Status</h2>
            <div class="dashboard-grid">
                <article class="card">
                    <h3>🔌 Integrations</h3>
                    <p class="card-subtitle">Everything connected to handle your bookings.</p>
                    <div id="system-status" class="status-compact">
                        <div class="metric-row">
                            <span class="metric-label">Lead number</span>
                            <span class="metric-value" id="statusPhone">+44 20 3880 1234</span>
            </div>
                        <div class="metric-row">
                            <span class="metric-label">SMS & WhatsApp</span>
                            <span class="metric-value">✓ Active</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Calendar</span>
                            <span class="metric-value">✓ Connected</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Coverage</span>
                            <span class="metric-value" id="statusCoverage">7 days/week, 24/7</span>
                        </div>
                    </div>
                    <div id="integration-health" class="integration-list"></div>
                    <div id="calendar-details" class="calendar-details"></div>
                </article>
            </div>
        </section>

        <!-- LIVE ACTIVITY SECTION -->
        <section class="dashboard-section">
            <article class="card card-fullwidth">
                <h3>🗓️ Live Activity Feed</h3>
                <p class="card-subtitle">Real-time conversations your concierge is having with your leads.</p>
                <div id="recent-calls" class="activity-feed"></div>
            </article>
        </section>

        <!-- WORKFLOW SECTION -->
        <section class="dashboard-section">
            <article class="card card-fullwidth">
                <h3>📋 How We Handle Everything For You</h3>
                <p class="card-subtitle">Your done-for-you workflow - this is what we do automatically every day.</p>
                <ul id="workflow" class="workflow-list"></ul>
            </article>
        </section>
                </div>

    <div class="data-freshness" id="dataFreshness" role="status" aria-live="polite">
        <span class="data-freshness-dot" id="freshnessDot"></span>
        <span id="freshnessText">Data syncing...</span>
            </div>

    <div class="keyboard-hint" id="keyboardHint" role="tooltip" aria-hidden="true">
        Press <kbd>?</kbd> for keyboard shortcuts
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <div class="modal-backdrop" id="leadModal" role="dialog" aria-labelledby="modalLeadName" aria-modal="true">
        <div class="lead-modal">
            <div class="modal-header">
                <h4 id="modalLeadName">Lead Name</h4>
                <button class="modal-close" id="modalCloseBtn" aria-label="Close lead modal">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Service:</strong> <span id="modalLeadService">—</span></p>
                <p><strong>Source:</strong> <span id="modalLeadSource">—</span></p>
                <p><strong>Status:</strong> <span id="modalLeadStatus">—</span></p>
                <p><strong>Last message:</strong></p>
                <p id="modalLeadNotes">—</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn" id="modalSnoozeBtn" aria-label="Snooze lead for 1 day">Snooze 1 day</button>
                <button type="button" class="modal-btn primary" id="modalEscalateBtn" aria-label="Escalate lead to operator">Escalate</button>
            </div>
        </div>
    </div>
    
    <div class="modal-backdrop" id="transcriptModal" role="dialog" aria-labelledby="transcriptModalTitle" aria-modal="true">
        <div class="lead-modal transcript-modal">
            <div class="modal-header">
                <h4 id="transcriptModalTitle">Call Transcript</h4>
                <button class="modal-close" id="transcriptCloseBtn" aria-label="Close transcript modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="transcript-content" id="transcriptContent" role="region" aria-live="polite">Loading transcript...</div>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="timelineModal" role="dialog" aria-labelledby="timelineModalTitle" aria-modal="true">
        <div class="lead-modal timeline-modal">
            <div class="modal-header">
                <h4 id="timelineModalTitle">Lead Journey Timeline</h4>
                <button class="modal-close" id="timelineCloseBtn" aria-label="Close timeline modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="timeline" id="timelineContent" role="region" aria-live="polite">Loading timeline...</div>
            </div>
        </div>
    </div>
    
    <script>
        const DEMO_CLIENT_KEY = 'demo_client';
        const BASE_URL = window.location.origin;
        const THEME_KEY = 'dashboard_theme';
        
        const CLIENT_CONFIG = {
            demo_client: {
                name: 'Demo Booking Partner',
                description: 'Live sandbox showing the AI concierge following up + booking',
                tagline: 'Upload existing leads → AI calls in minutes → appointments land in your calendar.',
                logo: '✨',
                status: 'Demo Live',
                phone: '+44 20 3880 1234',
                timezone: 'Europe/London',
                businessHours: '8am - 8pm, 7 days/week',
                industry: 'AI Booking Concierge',
                workflow: [
                    { icon: '📥', title: 'Import leads', desc: 'We pull directly from your CRM, forms, or spreadsheets.' },
                    { icon: '🤖', title: 'AI speed-to-lead', desc: 'Calls + SMS go out within minutes (24/7 coverage).' },
                    { icon: '📅', title: 'Bookings land in calendar', desc: 'Confirmed appointments drop straight into your calendar.' },
                    { icon: '📊', title: 'Daily digest', desc: 'Slack/email summary with leads touched and outcomes.' }
                ],
                chart: [5, 7, 6, 9, 8, 10, 7]
            }
        };

        const DEMO_DATA = {
            totalLeads: 48,
            totalCalls: 36,
            last24hLeads: 7,
            conversionRate: 63,
            successRate: 84,
            firstResponse: '2m 58s',
            bookingsThisWeek: 18,
            avgLeadScore: 87,
            highPriorityLeads: 9,
            mediumPriorityLeads: 14,
            lowPriorityLeads: 7,
            touchpoints: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                data: [5, 7, 6, 9, 8, 10, 7]
            },
            recentLeads: [
                { id: 1, name: 'Jordan Hale', phone: '+44 7700 900451', service: 'AI Strategy Session', status: 'Booked • calendar invite sent', source: 'Facebook Lead Ad', timeAgo: '2 min ago', lastMessage: '“Got the confirmation, see you Tuesday.”' },
                { id: 2, name: 'Priya Desai', phone: '+44 7700 900512', service: 'Follow-up Call', status: 'Awaiting reply • wants afternoon slot', source: 'Website form', timeAgo: '9 min ago', lastMessage: 'Asked for 4-6pm slot; AI sent options.' },
                { id: 3, name: 'Lewis Grant', phone: '+44 7700 900623', service: 'Pricing Review', status: 'Engaged • asked for case study', source: 'Referral', timeAgo: '25 min ago', lastMessage: 'Shared case study + queued callback tomorrow.' },
                { id: 4, name: 'Emily Carr', phone: '+44 7700 900734', service: 'Calendar Integration', status: 'Left voicemail • SMS reminder queued', source: 'CRM import', timeAgo: '40 min ago', lastMessage: 'Voicemail dropped, SMS reminder scheduled at 9am.' },
                { id: 5, name: 'Tom Osei', phone: '+44 7700 900845', service: 'AI Concierge Setup', status: 'Nurture • waiting on partner approval', source: 'Google Ads', timeAgo: '58 min ago', lastMessage: 'Sent partner-friendly explainer PDF.' }
            ],
            serviceMix: [
                { name: 'Lead Follow-Up', percent: 35, notes: 'Speed-to-lead flows' },
                { name: 'Appointment Booking', percent: 45, notes: 'AI calendar concierge' },
                { name: 'Calendar Integration', percent: 20, notes: 'Multi-calendar sync' }
            ],
            recentCalls: [
                { id: 'demo-1', name: 'Sarah Patel', summary: 'Booked Tuesday 2:30pm via AI call', channel: 'Phone', timeAgo: '2 min ago' },
                { id: 'demo-2', name: 'Marcus Flynn', summary: 'Requested reschedule • SMS follow-up sent', channel: 'SMS → Call', timeAgo: '9 min ago' },
                { id: 'demo-3', name: 'Laura Chen', summary: 'Synced with Google Calendar • reminder scheduled', channel: 'Webhook sync', timeAgo: '25 min ago' },
                { id: 'demo-4', name: 'Rick Alvarez', summary: 'Moved to Thursday • calendar updated', channel: 'Phone', timeAgo: '42 min ago' }
            ],
            appointments: [
                { id: 101, name: 'Isla Brown', service: 'AI Strategy Session', start: new Date(Date.now() + 60 * 60 * 1000).toISOString(), status: 'booked' },
                { id: 102, name: 'Liam Wright', service: 'Calendar Integration', start: new Date(Date.now() + 3 * 60 * 60 * 1000).toISOString(), status: 'booked' },
                { id: 103, name: 'Maya Reyes', service: 'Follow-up Call', start: new Date(Date.now() + 6 * 60 * 60 * 1000).toISOString(), status: 'pending' }
            ],
            roi: {
                costs: { total: 612.4, perCall: 12.4 },
                revenue: { total: 6280, bookings: 18, avgDealValue: 349 },
                roi: { profit: 5667.6, multiplier: 10.3, percentage: 930 }
            }
        };

        const DEMO_INTEGRATIONS = [
            { name: 'Vapi Voice', status: 'active', detail: 'Assistant + phone number connected' },
            { name: 'Twilio SMS', status: 'active', detail: 'Messaging service verified' },
            { name: 'Google Calendar', status: 'active', detail: 'Auto-booking in sync' },
            { name: 'Slack Digest', status: 'warning', detail: 'Add webhook to enable daily summary' }
        ];
        
        let currentClient = null;
        let dashboardData = { ...DEMO_DATA };
        let currentLeads = [];
        let liveEventSource = null;
        
        function getClientFromURL() {
            const params = new URLSearchParams(window.location.search);
            const clientParam = params.get('client');
            // If no client param or it's a demo variant, use DEMO_CLIENT_KEY
            if (!clientParam || clientParam.includes('demo') || clientParam.includes('booking')) {
                return DEMO_CLIENT_KEY;
            }
            return clientParam.replace(/-/g, '_');
        }

        let lastDataUpdate = new Date();
        async function fetchLiveData(clientKey) {
            if (clientKey !== DEMO_CLIENT_KEY) {
                try {
                    const res = await fetch(`${BASE_URL}/api/demo-dashboard/${clientKey}`);
                    if (res.ok) {
                        const payload = await res.json();
                        if (payload.ok) {
                            lastDataUpdate = new Date();
                            return payload;
                        }
                    }
                } catch (err) {
                    console.warn('Live data unavailable', err.message);
                    throw err;
                }
            } else {
                lastDataUpdate = new Date();
            }
            return null;
        }

        function mergeData(base = {}, livePayload) {
            if (!livePayload) return base;
            const metrics = livePayload.metrics || {};
            
            // In demo mode, preserve imported leads by merging arrays intelligently
            // Keep imported leads (marked with "New (demo)" status) at the front
            const baseLeads = Array.isArray(base.recentLeads) ? base.recentLeads : [];
            const importedLeads = baseLeads.filter(lead => lead.status && lead.status.includes('(demo)'));
            const existingLeads = baseLeads.filter(lead => !lead.status || !lead.status.includes('(demo)'));
            const newLeads = Array.isArray(livePayload.leads) && livePayload.leads.length ? livePayload.leads : [];
            
            // Merge: imported leads first, then new API leads, then existing non-imported leads
            // Remove duplicates by phone number
            const seenPhones = new Set();
            const mergedLeads = [];
            
            // Add imported leads first
            importedLeads.forEach(lead => {
                if (lead.phone && !seenPhones.has(lead.phone)) {
                    seenPhones.add(lead.phone);
                    mergedLeads.push(lead);
                }
            });
            
            // Add new API leads
            newLeads.forEach(lead => {
                if (lead.phone && !seenPhones.has(lead.phone)) {
                    seenPhones.add(lead.phone);
                    mergedLeads.push(lead);
                }
            });
            
            // Add existing non-imported leads (if not already added)
            existingLeads.forEach(lead => {
                if (lead.phone && !seenPhones.has(lead.phone)) {
                    seenPhones.add(lead.phone);
                    mergedLeads.push(lead);
                }
            });
            
            return {
                ...base,
                totalLeads: metrics.totalLeads ?? base.totalLeads,
                totalCalls: metrics.totalCalls ?? base.totalCalls,
                last24hLeads: metrics.last24hLeads ?? base.last24hLeads,
                conversionRate: metrics.conversionRate ?? base.conversionRate,
                successRate: metrics.successRate ?? base.successRate,
                firstResponse: metrics.firstResponse ?? base.firstResponse,
                bookingsThisWeek: metrics.bookingsThisWeek ?? base.bookingsThisWeek,
                avgLeadScore: metrics.avgLeadScore ?? base.avgLeadScore,
                highPriorityLeads: metrics.highPriorityLeads ?? base.highPriorityLeads,
                mediumPriorityLeads: metrics.mediumPriorityLeads ?? base.mediumPriorityLeads,
                lowPriorityLeads: metrics.lowPriorityLeads ?? base.lowPriorityLeads,
                recentLeads: mergedLeads.slice(0, 10), // Keep top 10
                serviceMix: Array.isArray(livePayload.serviceMix) && livePayload.serviceMix.length ? livePayload.serviceMix : base.serviceMix,
                recentCalls: Array.isArray(livePayload.recentCalls) && livePayload.recentCalls.length ? livePayload.recentCalls : base.recentCalls,
                touchpoints: livePayload.touchpoints && Array.isArray(livePayload.touchpoints.data)
                    ? livePayload.touchpoints
                    : base.touchpoints,
                appointments: Array.isArray(livePayload.appointments) && livePayload.appointments.length
                    ? livePayload.appointments
                    : base.appointments,
                roi: livePayload.roi ? livePayload.roi : base.roi
            };
        }

        function updateHeader(config) {
            document.getElementById('clientLogo').textContent = config.logo || '🏢';
            document.getElementById('clientName').textContent = config.name;
            document.getElementById('clientDescription').textContent = config.description || '';
            document.getElementById('clientTagline').textContent = config.tagline || '';
            document.getElementById('clientStatus').textContent = config.status || 'Live';
            document.getElementById('metaPhone').textContent = config.phone || '—';
            document.getElementById('metaTimezone').textContent = config.timezone || '—';
            document.getElementById('metaHours').textContent = config.businessHours || '—';
            document.getElementById('metaIndustry').textContent = config.industry || '—';

            const banner = document.getElementById('demoBanner');
            if (banner) {
                if (config.key === DEMO_CLIENT_KEY) {
                    banner.style.display = 'block';
                    banner.innerHTML = `<strong>Demo environment:</strong> ${config.name} shows exactly what your live dashboard will look like. When we onboard you we simply plug in your data.`;
                } else {
                    banner.style.display = 'none';
                }
            }
        }

        function formatNumber(value) {
            if (value === undefined || value === null) return '—';
            return Number(value).toLocaleString('en-GB');
        }

        function formatPercent(value) {
            if (value === undefined || value === null) return '—';
            const numeric = Number(value);
            return Number.isFinite(numeric) ? `${numeric}%` : `${value}`;
        }

        function formatCurrency(value) {
            const numeric = Number(value);
            if (!Number.isFinite(numeric)) return '£0';
            return new Intl.NumberFormat('en-GB', {
                style: 'currency',
                currency: 'GBP',
                maximumFractionDigits: 0
            }).format(numeric);
        }

        function updateStatusBar(data) {
            const totalLeads = formatNumber(data.totalLeads);
            const totalCalls = formatNumber(data.totalCalls);
            const conversion = formatPercent(data.conversionRate);
            const firstResponse = data.firstResponse || '—';

            document.getElementById('statusTotalLeads').textContent = totalLeads;
            document.getElementById('statusTotalCalls').textContent = totalCalls;
            document.getElementById('statusConversionRate').textContent = conversion;
            document.getElementById('statusFirstResponse').textContent = firstResponse;

            const last24 = formatNumber(data.last24hLeads ?? 0);
            const bookings = formatNumber(data.bookingsThisWeek ?? 0);
            const winRate = formatPercent(data.successRate ?? 0);

            document.getElementById('statusHintLeads').textContent = `Last 24h: ${last24} new`;
            document.getElementById('statusHintCalls').textContent = `${bookings} bookings locked in`;
            document.getElementById('statusHintConversion').textContent = `Win rate: ${winRate}`;
            document.getElementById('statusHintResponse').textContent = firstResponse === '—'
                ? 'Goal: under 5 min'
                : `Current: ${firstResponse}`;
        }

        function renderRecentActivity(data) {
            const container = document.getElementById('recent-activity');
            if (!container) return;
            container.innerHTML = `
                <div class="activity-metric">
                    <div class="activity-metric-label">New Leads</div>
                    <div class="activity-metric-value">${formatNumber(data.last24hLeads || 0)}</div>
                    </div>
                <div class="activity-metric">
                    <div class="activity-metric-label">Calls Made</div>
                    <div class="activity-metric-value">${formatNumber(data.totalCalls || 0)}</div>
                    </div>
                <div class="activity-metric">
                    <div class="activity-metric-label">Bookings</div>
                    <div class="activity-metric-value">${formatNumber(data.bookingsThisWeek ?? 18)}</div>
                    </div>
                <div class="activity-metric">
                    <div class="activity-metric-label">Response Time</div>
                    <div class="activity-metric-value" style="font-size: 1.3rem;">${data.firstResponse || '—'}</div>
                    </div>
            `;
        }

        function renderROI(roi = {}) {
            document.getElementById('roiSpend').textContent = formatCurrency(roi.costs?.total);
            document.getElementById('roiRevenue').textContent = formatCurrency(roi.revenue?.total);
            document.getElementById('roiBookings').textContent = `${formatNumber(roi.revenue?.bookings ?? 0)} bookings`;
            document.getElementById('roiMultiplier').textContent = `${(roi.roi?.multiplier ?? 0).toFixed(1)}x`;
            document.getElementById('roiProfit').textContent = `${formatCurrency(roi.roi?.profit ?? 0)} profit`;
        }


        function renderLeads(leads = []) {
            const container = document.getElementById('leads-list');
            if (!container) return;
            if (!leads.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-state-icon">👥</span>
                        <div class="empty-state-title">No leads yet</div>
                        <div class="empty-state-message">Leads we receive will appear here as we start following up.</div>
                    </div>
                `;
                currentLeads = [];
                return;
            }
            dashboardData.recentLeads = leads;
            currentLeads = leads.slice(0, 5);
            container.innerHTML = currentLeads.map((lead, index) => `
                <div class="lead-item" data-lead-index="${index}" role="button" tabindex="0">
                    <div class="lead-name">${lead.name || 'Prospect'}</div>
                    <div class="lead-meta">
                        <span>${lead.phone || lead.email || ''}</span>
                        <span>${lead.service || 'General'}</span>
                    </div>
                    <div class="lead-status">${lead.status || 'In follow-up'}</div>
                    <button class="timeline-btn" onclick="event.stopPropagation(); viewLeadTimeline('${lead.id || lead.phone || index}', '${lead.name || 'Prospect'}')">📊 View Timeline</button>
                </div>
            `).join('');
            attachLeadModalEvents();
        }


        function renderAppointments(appointments = []) {
            const container = document.getElementById('upcoming-appointments');
            if (!container) return;
            if (!Array.isArray(appointments) || !appointments.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-state-icon">📅</span>
                        <div class="empty-state-title">No upcoming appointments</div>
                        <div class="empty-state-message">Appointments we book will appear here automatically.</div>
                        <div class="empty-state-cta">
                            <button class="empty-state-btn" onclick="document.getElementById('leadImportButton')?.click()" aria-label="Upload leads to get started">
                                📤 Send Us Leads to Book
                            </button>
                    </div>
                    </div>
                `;
                return;
            }
            container.innerHTML = appointments.map(appt => `
                <div class="appt-item">
                    <div>
                        <div class="appt-name">${appt.name || 'Prospect'}</div>
                        <div class="appt-service">${appt.service || 'Consultation'}</div>
                    </div>
                    <div class="appt-time">${formatAppointmentTime(appt.start)}</div>
                </div>
            `).join('');
        }

        function renderChart(config, data) {
            const fallbackLabels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            const chartSource = data?.touchpoints && Array.isArray(data.touchpoints.data) && data.touchpoints.data.length
                ? data.touchpoints
                : { labels: fallbackLabels, data: config.chart || fallbackLabels.map(() => 0) };
            const totals = chartSource.data;
            const labels = chartSource.labels?.length === totals.length ? chartSource.labels : fallbackLabels;
            const max = Math.max(...totals, 1);
            const bars = totals.map((value, idx) => `
                <div class="chart-bar" style="height:${(value / max) * 100}%;" data-label="${labels[idx] || ''}"></div>
            `).join('');
            document.getElementById('chartBars').innerHTML = bars;
            document.getElementById('chartSummary').textContent = `${totals.reduce((sum,v)=>sum+v,0)} calls we made for you this week`;
        }

        function formatAppointmentTime(isoDate) {
            if (!isoDate) return '—';
            const date = new Date(isoDate);
            if (Number.isNaN(date.getTime())) return '—';
            return date.toLocaleString('en-GB', {
                weekday: 'short',
                day: 'numeric',
                month: 'short',
                hour: 'numeric',
                minute: '2-digit'
            });
        }


        function renderSystemStatus(config) {
            document.getElementById('statusPhone').textContent = config.phone || '—';
            document.getElementById('statusCoverage').textContent = config.businessHours || '—';
        }

        function renderIntegrationStatus(list = []) {
            const container = document.getElementById('integration-health');
            if (!container) return;
            if (!Array.isArray(list) || !list.length) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <span class="empty-state-icon">🔌</span>
                        <div class="empty-state-title">No integrations</div>
                        <div class="empty-state-message">Connect channels to monitor health.</div>
                    </div>
                `;
                return;
            }
            container.innerHTML = list.map(item => `
                <div class="integration-item" title="${item.detail || ''}">
                    <div class="integration-label">
                        <span class="integration-dot" style="background:${item.status === 'active' ? '#1b5e20' : item.status === 'warning' ? '#f5a623' : '#c62828'};"></span>
                        ${item.name}
                    </div>
                    <div class="integration-status ${item.status || 'inactive'}">${item.status || 'unknown'}</div>
                </div>
            `).join('');
        }

        function renderCalls(calls = []) {
            const container = document.getElementById('recent-calls');
            if (!calls.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-state-icon">📞</span>
                        <div class="empty-state-title">No calls yet</div>
                        <div class="empty-state-message">Your concierge will start calling leads as soon as you send them to us.</div>
                        <div class="empty-state-cta">
                            <button class="empty-state-btn" onclick="document.getElementById('leadImportButton')?.click()" aria-label="Upload leads">
                                📤 Upload Leads to Get Started
                            </button>
                    </div>
                    </div>
                `;
                return;
            }
            container.innerHTML = calls.map((call, index) => {
                const timeAgo = call.timeAgo || formatTimeAgo(call.timestamp || call.created_at);
                const callId = call.id || call.timestamp || index;
                return `
                    <div class="activity-item">
                        <strong>${call.name || 'Prospect'}</strong> • ${call.channel || 'AI call'}
                        <div class="activity-meta">${call.summary || 'Conversation logged'} • ${timeAgo}</div>
                        <button class="transcript-btn" onclick="viewTranscript('${callId}', '${call.name || 'Prospect'}')">📄 View Transcript</button>
                    </div>
                `;
            }).join('');
        }

        function renderWorkflow(steps = []) {
            const container = document.getElementById('workflow');
            container.innerHTML = steps.map(step => `
                <li class="workflow-step">
                    <div class="workflow-icon">${step.icon}</div>
                    <div>
                        <strong>${step.title}</strong>
                        <p style="color:#6f7390; margin-top:4px;">${step.desc}</p>
                    </div>
                </li>
            `).join('');
        }

        function renderLeadJourney(data) {
            const container = document.getElementById('lead-journey');
            if (!container) return;
            const totalLeads = data.totalLeads || 0;
            const contacted = data.totalCalls || 0;
            const engaged = Math.round(contacted * 0.75);
            const booked = data.bookingsThisWeek || 0;

            const stages = [
                { label: 'Leads', value: totalLeads, color: '#5c6ac4' },
                { label: 'Contacted', value: contacted, color: '#764ba2' },
                { label: 'Engaged', value: engaged, color: '#667eea' },
                { label: 'Booked', value: booked, color: '#1b5e20' }
            ];

            const maxValue = Math.max(...stages.map(s => s.value), 1);
            container.innerHTML = stages.map(stage => {
                const percent = maxValue > 0 ? Math.round((stage.value / maxValue) * 100) : 0;
                const stagePercent = totalLeads > 0 ? Math.round((stage.value / totalLeads) * 100) : 0;
                return `
                    <div class="funnel-stage">
                        <div class="funnel-label">
                            <span>${stage.label}</span>
                            <span>${formatNumber(stage.value)} <span class="funnel-percent">(${stagePercent}%)</span></span>
                    </div>
                        <div class="funnel-bar">
                            <div class="funnel-fill" style="width:${percent}%; background:linear-gradient(90deg, ${stage.color}, ${stage.color}dd);"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }



        function showToast(title, message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;

            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        async function viewTranscript(callId, name) {
            const modal = document.getElementById('transcriptModal');
            const titleEl = document.getElementById('transcriptModalTitle');
            const contentEl = document.getElementById('transcriptContent');
            if (!modal || !titleEl || !contentEl) return;

            titleEl.textContent = `Call Transcript: ${name}`;
            contentEl.textContent = 'Loading transcript...';
            modal.classList.add('open');

            if (currentClient === DEMO_CLIENT_KEY) {
                contentEl.textContent = `[DEMO TRANSCRIPT]\n\nAI: Hello! This is ${name || 'the AI concierge'}. How can I help you book an appointment today?\n\nCustomer: I'd like to schedule a consultation.\n\nAI: Absolutely! I'd be happy to help you schedule a consultation. What day works best for you?\n\nCustomer: How about next Tuesday?\n\nAI: Let me check availability for next Tuesday. I have slots at 10am, 2pm, and 4pm. Which time works for you?\n\nCustomer: 2pm sounds good.\n\nAI: Perfect! I've booked you for next Tuesday at 2pm. You'll receive a confirmation email shortly. Is there anything else I can help you with?\n\nCustomer: No, that's all. Thank you!\n\nAI: You're welcome! We look forward to seeing you next Tuesday at 2pm. Have a great day!\n\n[Call ended - Outcome: Booked]`;
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/calls/${callId}/transcript`);
                const payload = await response.json();
                if (response.ok && payload?.ok && payload.transcript) {
                    contentEl.textContent = payload.transcript;
                } else {
                    contentEl.textContent = 'Transcript not available for this call.';
                }
            } catch (error) {
                console.error('Failed to load transcript', error);
                contentEl.innerHTML = `
                    <div class="error-message" role="alert">
                        <span class="error-message-icon">⚠️</span>
                        <div>
                            <strong>Unable to load transcript</strong>
                            <div style="font-size: 0.9rem; margin-top: 4px;">${error.message || 'Please try again later.'}</div>
                            <button class="empty-state-btn" style="margin-top: 8px; font-size: 0.85rem; padding: 6px 12px;" onclick="viewTranscript('${callId}', '${name}')">Retry</button>
                        </div>
                    </div>
                `;
            }
        }

        function closeTranscriptModal() {
            const modal = document.getElementById('transcriptModal');
            if (modal) modal.classList.remove('open');
        }

        async function renderActiveIndicator(data) {
            const titleEl = document.getElementById('activeTitle');
            const subtitleEl = document.getElementById('activeSubtitle');
            if (!titleEl || !subtitleEl) return;

            if (currentClient === DEMO_CLIENT_KEY) {
                const activeCalls = Math.floor((data.totalCalls || 0) * 0.1) || 0;
                const activeFollowups = Math.floor((data.totalLeads || 0) * 0.3) || 0;
                
                if (activeCalls > 0 || activeFollowups > 0) {
                    titleEl.textContent = `Your concierge is active`;
                    subtitleEl.textContent = `Currently calling ${activeCalls} lead${activeCalls !== 1 ? 's' : ''}, following up with ${activeFollowups}`;
                } else {
                    titleEl.textContent = `Your concierge is monitoring`;
                    subtitleEl.textContent = `Ready to handle leads as they come in`;
                }
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}/api/active-indicator/${currentClient}`);
                const payload = await response.json();
                if (response.ok && payload?.ok) {
                    titleEl.textContent = payload.title;
                    subtitleEl.textContent = payload.subtitle;
                }
            } catch (error) {
                console.error('Failed to load active indicator', error);
                // Gracefully degrade - don't show error for this non-critical feature
            }
        }

        async function renderCallQuality(data) {
            const container = document.getElementById('call-quality');
            if (!container) return;

            if (currentClient === DEMO_CLIENT_KEY) {
                const totalCalls = data.totalCalls || 0;
                const bookings = data.bookingsThisWeek || 0;
                const avgDuration = Math.floor((totalCalls * 2.5) + Math.random() * 1.5);
                const successRate = totalCalls > 0 ? Math.round((bookings / totalCalls) * 100) : 0;
                const bestHour = '2-4pm';

                container.innerHTML = `
                    <div class="quality-metric">
                        <div class="quality-label">Avg Duration</div>
                        <div class="quality-value">${avgDuration}m</div>
                        <div class="quality-badge">per call</div>
                    </div>
                    <div class="quality-metric">
                        <div class="quality-label">Success Rate</div>
                        <div class="quality-value">${successRate}%</div>
                        <div class="quality-badge">bookings</div>
                    </div>
                    <div class="quality-metric">
                        <div class="quality-label">Best Time</div>
                        <div class="quality-value">${bestHour}</div>
                        <div class="quality-badge">to call</div>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/call-quality/${currentClient}`);
                const payload = await response.json();
                if (response.ok && payload?.ok) {
                    container.innerHTML = `
                        <div class="quality-metric">
                            <div class="quality-label">Avg Duration</div>
                            <div class="quality-value">${payload.avgDuration || 0}m</div>
                            <div class="quality-badge">per call</div>
                        </div>
                        <div class="quality-metric">
                            <div class="quality-label">Success Rate</div>
                            <div class="quality-value">${payload.successRate || 0}%</div>
                            <div class="quality-badge">bookings</div>
                        </div>
                        <div class="quality-metric">
                            <div class="quality-label">Best Time</div>
                            <div class="quality-value">${payload.bestTime || '2-4pm'}</div>
                            <div class="quality-badge">to call</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load call quality', error);
                showError(container, 'Unable to load call quality metrics. Please refresh the page.', () => location.reload());
            }
        }

        async function renderRetryQueue(data) {
            const container = document.getElementById('retry-queue');
            if (!container) return;

            if (currentClient === DEMO_CLIENT_KEY) {
                const totalCalls = data.totalCalls || 0;
                const failedCalls = Math.floor(totalCalls * 0.15);
                
                if (failedCalls === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <span class="empty-state-icon">✅</span>
                            <div class="empty-state-title">All caught up!</div>
                            <div class="empty-state-message">No retries needed - all calls successful!</div>
                            </div>
                    `;
                    return;
                }

                const retryLeads = currentLeads.slice(0, Math.min(failedCalls, 3)).map((lead, idx) => ({
                    name: lead.name || 'Prospect',
                    phone: lead.phone,
                    attempts: 2 + idx,
                    nextRetry: idx === 0 ? 'Today, 2pm' : idx === 1 ? 'Today, 4pm' : 'Tomorrow, 10am'
                }));

                container.innerHTML = retryLeads.map(lead => `
                    <div class="retry-item">
                        <div>
                            <div class="retry-name">${lead.name}</div>
                            <div class="retry-meta">Attempt ${lead.attempts} • ${lead.phone || ''}</div>
                            </div>
                        <div class="retry-status">Retrying ${lead.nextRetry}</div>
                    </div>
                `).join('');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/retry-queue/${currentClient}`);
                const payload = await response.json();
                if (response.ok && payload?.ok) {
                    if (!payload.retries || payload.retries.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state" style="padding: 20px;">
                                <span class="empty-state-icon">✅</span>
                                <div class="empty-state-title">All caught up!</div>
                                <div class="empty-state-message">No retries needed - all calls successful!</div>
                            </div>
                        `;
                        return;
                    }
                    container.innerHTML = payload.retries.map(lead => `
                        <div class="retry-item">
                            <div>
                                <div class="retry-name">${lead.name}</div>
                                <div class="retry-meta">Attempt ${lead.attempts}/${lead.maxAttempts} • ${lead.phone || ''}</div>
                        </div>
                            <div class="retry-status">Retrying ${lead.nextRetry}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load retry queue', error);
                showError(container, 'Unable to load retry queue. Please refresh the page.', () => location.reload());
            }
        }

        async function viewLeadTimeline(leadId, name) {
            const modal = document.getElementById('timelineModal');
            const titleEl = document.getElementById('timelineModalTitle');
            const contentEl = document.getElementById('timelineContent');
            if (!modal || !titleEl || !contentEl) return;

            titleEl.textContent = `Journey: ${name}`;
            contentEl.innerHTML = 'Loading timeline...';
            modal.classList.add('open');

            // Check if we're in demo mode (fallback if currentClient not set)
            const isDemo = !currentClient || currentClient === DEMO_CLIENT_KEY || !currentClient.includes('_');
            if (isDemo) {
                const now = new Date();
                const timeline = [
                    { event: 'Lead received', time: new Date(now - 2 * 60 * 60 * 1000), icon: '📥', detail: 'Added via CSV import' },
                    { event: 'AI call initiated', time: new Date(now - 100 * 60 * 1000), icon: '📞', detail: 'Called within 5 minutes' },
                    { event: 'SMS follow-up sent', time: new Date(now - 90 * 60 * 1000), icon: '💬', detail: 'Scheduled for tomorrow' },
                    { event: 'Engagement detected', time: new Date(now - 60 * 60 * 1000), icon: '✨', detail: 'Showed interest in consultation' },
                    { event: 'Appointment booked', time: new Date(now - 30 * 60 * 1000), icon: '📅', detail: 'Booked for next Tuesday, 2pm' }
                ];

                contentEl.innerHTML = timeline.map(item => `
                    <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                            <div class="timeline-title">${item.icon} ${item.event}</div>
                            <div class="timeline-meta">${item.detail} • ${formatTimeAgo(item.time.toISOString())}</div>
                            </div>
                            </div>
                `).join('');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/leads/${leadId}/timeline`);
                const payload = await response.json();
                if (response.ok && payload?.ok && payload.timeline) {
                    contentEl.innerHTML = payload.timeline.map(item => `
                        <div class="timeline-item">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <div class="timeline-title">${item.icon || '📋'} ${item.event}</div>
                                <div class="timeline-meta">${item.detail || ''} • ${formatTimeAgo(item.time)}</div>
                        </div>
                        </div>
                    `).join('');
                } else {
                    contentEl.innerHTML = '<p>Timeline not available for this lead.</p>';
                }
            } catch (error) {
                console.error('Failed to load timeline', error);
                contentEl.innerHTML = `
                    <div class="error-message" role="alert">
                        <span class="error-message-icon">⚠️</span>
                        <div>
                            <strong>Unable to load timeline</strong>
                            <div style="font-size: 0.9rem; margin-top: 4px;">${error.message || 'Please try again later.'}</div>
                            <button class="empty-state-btn" style="margin-top: 8px; font-size: 0.85rem; padding: 6px 12px;" onclick="viewLeadTimeline('${leadId}', '${name}')">Retry</button>
                        </div>
                    </div>
                `;
            }
        }
        
        function closeTimelineModal() {
            const modal = document.getElementById('timelineModal');
            if (modal) modal.classList.remove('open');
        }


        async function renderCallRecordings(calls = []) {
            const container = document.getElementById('call-recordings');
            if (!container) return;

            if (currentClient === DEMO_CLIENT_KEY) {
                if (!calls.length) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <span class="empty-state-icon">🎙️</span>
                            <div class="empty-state-title">No recordings yet</div>
                            <div class="empty-state-message">Call recordings will appear here after calls are made.</div>
                            </div>
                    `;
                    return;
                }

                container.innerHTML = calls.slice(0, 3).map((call, index) => `
                    <div class="recording-item">
                        <div class="recording-controls">
                            <button class="play-btn" onclick="playRecording('${call.id || index}', '${call.name || 'Prospect'}')" title="Play recording">▶</button>
                            </div>
                        <div class="recording-info">
                            <div class="recording-name">${call.name || 'Prospect'}</div>
                            <div class="recording-meta">${call.summary || 'Call completed'} • ${call.timeAgo || formatTimeAgo(call.created_at || '')} • ${Math.floor(Math.random() * 3 + 2)} min</div>
                                </div>
                            </div>
                `).join('');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/call-recordings/${currentClient}`);
                const payload = await response.json();
                if (response.ok && payload?.ok) {
                    if (!payload.recordings || payload.recordings.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state" style="padding: 20px;">
                                <span class="empty-state-icon">🎙️</span>
                                <div class="empty-state-title">No recordings yet</div>
                                <div class="empty-state-message">Call recordings will appear here after calls are made.</div>
                                </div>
                        `;
                        return;
                    }
                    container.innerHTML = payload.recordings.map(recording => {
                        const durationMin = Math.floor((recording.duration || 0) / 60);
                        const durationSec = (recording.duration || 0) % 60;
                        return `
                            <div class="recording-item">
                                <div class="recording-controls">
                                    <button class="play-btn" onclick="playRecording('${recording.id}', '${recording.name}', '${recording.recordingUrl || ''}')" title="Play recording">▶</button>
                            </div>
                                <div class="recording-info">
                                    <div class="recording-name">${recording.name}</div>
                                    <div class="recording-meta">${recording.outcome || 'Call completed'} • ${recording.timeAgo || 'Recently'} • ${durationMin}:${String(durationSec).padStart(2, '0')}</div>
                        </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Failed to load call recordings', error);
            }
        }

        function playRecording(callId, name, recordingUrl) {
            if (currentClient === DEMO_CLIENT_KEY) {
                showToast('Recording Playback', `Demo recording for ${name} would play here`, 'info');
                return;
            }
            
            if (recordingUrl) {
                window.open(recordingUrl, '_blank');
                showToast('Playing Recording', `Opening recording for ${name}...`, 'info');
            } else {
                showToast('Recording Unavailable', `Recording URL not found for ${name}`, 'warning');
            }
        }

        async function renderCalendarDetails(data) {
            const container = document.getElementById('calendar-details');
            if (!container) return;

            if (currentClient === DEMO_CLIENT_KEY) {
                const lastSync = new Date(Date.now() - 5 * 60 * 1000);
                const conflictsResolved = Math.floor((data.bookingsThisWeek || 0) * 0.1);
                const appointmentsBooked = data.bookingsThisWeek || 0;

                container.innerHTML = `
                    <div class="calendar-detail-item">
                        <span class="calendar-detail-label">Last sync</span>
                        <span class="calendar-detail-value success">${formatTimeAgo(lastSync.toISOString())}</span>
                                </div>
                    <div class="calendar-detail-item">
                        <span class="calendar-detail-label">Conflicts resolved</span>
                        <span class="calendar-detail-value">${conflictsResolved} this week</span>
                                </div>
                    <div class="calendar-detail-item">
                        <span class="calendar-detail-label">Appointments booked</span>
                        <span class="calendar-detail-value success">${appointmentsBooked} this week</span>
                                </div>
                    <div class="calendar-detail-item">
                        <span class="calendar-detail-label">Calendar status</span>
                        <span class="calendar-detail-value success">✓ Synced and active</span>
                                </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/calendar-sync/${currentClient}`);
                const payload = await response.json();
                if (response.ok && payload?.ok) {
                    const lastSyncTime = formatTimeAgo(payload.lastSync);
                    container.innerHTML = `
                        <div class="calendar-detail-item">
                            <span class="calendar-detail-label">Last sync</span>
                            <span class="calendar-detail-value ${payload.connected ? 'success' : 'warning'}">${lastSyncTime}</span>
                                    </div>
                        <div class="calendar-detail-item">
                            <span class="calendar-detail-label">Conflicts resolved</span>
                            <span class="calendar-detail-value">${payload.conflictsResolved || 0} this week</span>
                            </div>
                        <div class="calendar-detail-item">
                            <span class="calendar-detail-label">Appointments booked</span>
                            <span class="calendar-detail-value success">${payload.appointmentsBooked || 0} this week</span>
                        </div>
                        <div class="calendar-detail-item">
                            <span class="calendar-detail-label">Calendar status</span>
                            <span class="calendar-detail-value ${payload.connected ? 'success' : 'warning'}">${payload.connected ? '✓ Synced and active' : '⚠ Not connected'}</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load calendar details', error);
            }
        }

        async function exportData(type) {
            if (currentClient === DEMO_CLIENT_KEY) {
                showToast('Export Ready', `Demo data export for ${type} would download here.`, 'info');
                return;
            }

            try {
                showToast('Exporting', `Preparing ${type} export...`, 'info');
                const response = await fetch(`${BASE_URL}/api/export/${type}?clientKey=${currentClient}`);
                if (!response.ok) throw new Error('Export failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${type}-export-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showToast('Export Complete', `Downloaded ${type} data.`, 'success');
            } catch (error) {
                console.error('Export failed', error);
                const errorMsg = error.message || 'Unable to export data. Please check your connection and try again.';
                showToast('Export Failed', errorMsg, 'error');
            }
        }

        function attachLeadModalEvents() {
            document.querySelectorAll('.lead-item').forEach(item => {
                item.addEventListener('click', () => openLeadModal(item.dataset.leadIndex));
                item.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        openLeadModal(item.dataset.leadIndex);
                    }
                });
            });
        }

        function openLeadModal(index) {
            const lead = currentLeads[Number(index)];
            if (!lead) return;
            const modal = document.getElementById('leadModal');
            if (!modal) return;
            document.getElementById('modalLeadName').textContent = lead.name || lead.phone || 'Lead';
            document.getElementById('modalLeadService').textContent = lead.service || 'General';
            document.getElementById('modalLeadSource').textContent = lead.source || 'Unknown';
            document.getElementById('modalLeadStatus').textContent = lead.status || 'In follow-up';
            document.getElementById('modalLeadNotes').textContent = lead.lastMessage || lead.notes || 'No notes yet.';
            modal.dataset.currentIndex = index;
            modal.classList.add('open');
        }

        function closeLeadModal() {
            const modal = document.getElementById('leadModal');
            if (!modal) return;
            modal.classList.remove('open');
            modal.dataset.currentIndex = '';
        }

        function startLiveEvents(clientKey) {
            if (!window.EventSource || clientKey === DEMO_CLIENT_KEY) {
                stopLiveEvents();
                return;
            }
            if (liveEventSource) liveEventSource.close();
            liveEventSource = new EventSource(`${BASE_URL}/api/events/${clientKey}`);
            liveEventSource.onmessage = (event) => {
                if (!event.data) return;
                try {
                    const payload = JSON.parse(event.data);
                    handleLiveEvent(payload);
                } catch (err) {
                    console.warn('Failed to parse event payload', err);
                }
            };
            liveEventSource.onerror = () => {
                stopLiveEvents();
                setTimeout(() => startLiveEvents(clientKey), 10000);
            };
        }

        function stopLiveEvents() {
            if (liveEventSource) {
                liveEventSource.close();
                liveEventSource = null;
            }
        }

        function handleLiveEvent(call) {
            if (!call) return;
            call.timeAgo = formatTimeAgo(call.timestamp || call.created_at);
            dashboardData.recentCalls = [call, ...(dashboardData.recentCalls || [])].slice(0, 5);
            renderCalls(dashboardData.recentCalls);
            showToast('New Call Logged', `${call.name || 'Prospect'}: ${call.summary || 'Call completed'}`, 'info');
        }

        async function initDashboard() {
            currentClient = getClientFromURL();
            const config = { ...CLIENT_CONFIG[currentClient] } || CLIENT_CONFIG[DEMO_CLIENT_KEY];
            config.key = currentClient;
            updateHeader(config);
            initThemeToggle();
            initModalControls();
            initImporter();
            initAccessibility();
            initKeyboardShortcuts();
            initOfflineDetection();
            initDataFreshness();

            dashboardData = { ...DEMO_DATA };
            if (currentClient === DEMO_CLIENT_KEY) {
                document.getElementById('demoBanner').style.display = 'block';
                stopLiveEvents();
            } else {
                const banner = document.getElementById('demoBanner');
                if (banner) banner.style.display = 'none';
            }

            // Show loading skeletons
            const loadingContainers = ['leads-list', 'upcoming-appointments', 'recent-calls', 'recent-activity'];
            loadingContainers.forEach(id => {
                const container = document.getElementById(id);
                if (container) showSkeleton(container, id === 'recent-activity' ? 'metrics' : 'list');
            });

            try {
                const livePayload = await fetchLiveData(currentClient);
                dashboardData = mergeData(dashboardData, livePayload);
            } catch (error) {
                console.error('Failed to load dashboard data', error);
                const leadsContainer = document.getElementById('leads-list');
                if (leadsContainer) {
                    showError(leadsContainer, 'Unable to load dashboard data. Please refresh the page.', () => location.reload());
                }
            }

            updateStatusBar(dashboardData);
            renderRecentActivity(dashboardData);
            renderROI(dashboardData.roi || DEMO_DATA.roi);
            await renderActiveIndicator(dashboardData);
            renderLeadJourney(dashboardData);
            renderLeads(dashboardData.recentLeads || []);
            renderAppointments(dashboardData.appointments || []);
            renderChart(config, dashboardData);
            renderSystemStatus(config);
            await renderCallQuality(dashboardData);
            await renderRetryQueue(dashboardData);
            await renderCalendarDetails(dashboardData);
            // Ensure calls render - use DEMO_DATA if empty or undefined
            const callsToRender = (dashboardData.recentCalls && Array.isArray(dashboardData.recentCalls) && dashboardData.recentCalls.length > 0)
                ? dashboardData.recentCalls 
                : (DEMO_DATA.recentCalls || []);
            renderCalls(callsToRender);
            await renderCallRecordings(callsToRender);
            renderWorkflow(config.workflow || CLIENT_CONFIG.demo_client.workflow);
            loadIntegrationHealth(currentClient);

            startLiveEvents(currentClient);

            // Add fade-in animation to cards
            setTimeout(() => {
                document.querySelectorAll('.card').forEach((card, index) => {
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.classList.add('fade-in');
                });
            }, 100);

            setInterval(async () => {
                try {
                    const refreshPayload = await fetchLiveData(currentClient);
                    // Update freshness timestamp even in demo mode
                    lastDataUpdate = new Date();
                    if (refreshPayload) {
                        dashboardData = mergeData(dashboardData, refreshPayload);
                        updateStatusBar(dashboardData);
                        renderRecentActivity(dashboardData);
                        renderROI(dashboardData.roi || DEMO_DATA.roi);
                        await renderActiveIndicator(dashboardData);
                        renderLeadJourney(dashboardData);
                        renderLeads(dashboardData.recentLeads || []);
                        renderAppointments(dashboardData.appointments || []);
                        const callsToRender = dashboardData.recentCalls && dashboardData.recentCalls.length 
                            ? dashboardData.recentCalls 
                            : DEMO_DATA.recentCalls;
                        renderCalls(callsToRender);
                        await renderCallRecordings(callsToRender);
                        await renderCallQuality(dashboardData);
                        await renderRetryQueue(dashboardData);
                        await renderCalendarDetails(dashboardData);
                        renderChart(config, dashboardData);
                    }
                } catch (error) {
                    console.error('Failed to refresh dashboard data', error);
                    // Silent fail for background refresh - don't interrupt user
                }
            }, 30000);
        }

        // Accessibility improvements
        function initAccessibility() {
            // Add ARIA labels to interactive elements
            document.querySelectorAll('button').forEach(btn => {
                if (!btn.getAttribute('aria-label') && !btn.textContent.trim()) {
                    btn.setAttribute('aria-label', btn.title || 'Button');
                }
            });

            // Add ARIA labels to cards
            document.querySelectorAll('.card').forEach(card => {
                const title = card.querySelector('h3');
                if (title && !card.getAttribute('aria-label')) {
                    card.setAttribute('aria-label', title.textContent);
                }
            });

            // Improve keyboard navigation
            document.querySelectorAll('.lead-item, .appt-item, .activity-item').forEach(item => {
                if (!item.getAttribute('tabindex')) {
                    item.setAttribute('tabindex', '0');
                }
                item.setAttribute('role', 'button');
            });
        }

        // Keyboard shortcuts
        function initKeyboardShortcuts() {
            const hint = document.getElementById('keyboardHint');
            let hintTimeout;

            document.addEventListener('keydown', (e) => {
                // Show hint on first keypress
                if (hint && !hint.classList.contains('show')) {
                    hint.classList.add('show');
                    clearTimeout(hintTimeout);
                    hintTimeout = setTimeout(() => hint.classList.remove('show'), 3000);
                }

                // ? - Show keyboard shortcuts
                if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    showKeyboardShortcuts();
                }

                // Escape - Close modals
                if (e.key === 'Escape') {
                    closeLeadModal();
                    closeTranscriptModal();
                    closeTimelineModal();
                }

                // u - Upload leads (when not in input)
                if (e.key === 'u' && !e.ctrlKey && !e.metaKey && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    document.getElementById('leadImportButton')?.click();
                }

                // t - Toggle theme
                if (e.key === 't' && !e.ctrlKey && !e.metaKey && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    document.getElementById('themeToggle')?.click();
                }
            });
        }

        function showKeyboardShortcuts() {
            const shortcuts = [
                { key: '?', desc: 'Show keyboard shortcuts' },
                { key: 'Esc', desc: 'Close modals' },
                { key: 'u', desc: 'Upload leads' },
                { key: 't', desc: 'Toggle theme' }
            ];

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop open';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-label', 'Keyboard shortcuts');
            modal.innerHTML = `
                <div class="lead-modal">
                    <div class="modal-header">
                        <h4>⌨️ Keyboard Shortcuts</h4>
                        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()" aria-label="Close">&times;</button>
                            </div>
                    <div class="modal-body">
                        ${shortcuts.map(s => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(92,106,196,0.1);">
                                <span><kbd style="background: rgba(92,106,196,0.1); padding: 4px 8px; border-radius: 4px; font-weight: 600;">${s.key}</kbd></span>
                                <span style="color: var(--muted);">${s.desc}</span>
                            </div>
                        `).join('')}
                        </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Offline detection
        function initOfflineDetection() {
            const freshnessDot = document.getElementById('freshnessDot');
            const freshnessText = document.getElementById('freshnessText');

            function updateOnlineStatus() {
                if (navigator.onLine) {
                    freshnessDot?.classList.remove('offline');
                    if (freshnessText) freshnessText.textContent = 'Online';
                } else {
                    freshnessDot?.classList.add('offline');
                    if (freshnessText) freshnessText.textContent = 'Offline';
                    showToast('Connection Lost', 'You are currently offline. Data will sync when connection is restored.', 'warning');
                }
            }

            window.addEventListener('online', () => {
                updateOnlineStatus();
                showToast('Connection Restored', 'You are back online. Syncing data...', 'success');
                // Refresh data
                setTimeout(async () => {
                    try {
                        const refreshPayload = await fetchLiveData(currentClient);
                        if (refreshPayload) {
                            dashboardData = mergeData(dashboardData, refreshPayload);
                            updateStatusBar(dashboardData);
                            renderRecentActivity(dashboardData);
                            renderLeads(dashboardData.recentLeads || []);
                            renderAppointments(dashboardData.appointments || []);
                }
            } catch (error) {
                        console.error('Failed to refresh after coming online', error);
                    }
                }, 1000);
            });

            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }

        // Data freshness indicator
        function initDataFreshness() {
            const freshnessText = document.getElementById('freshnessText');
            if (!freshnessText) return;

            function updateFreshness() {
                const now = new Date();
                const diffMs = now - lastDataUpdate;
                const diffMins = Math.floor(diffMs / 60000);
                const diffSecs = Math.floor((diffMs % 60000) / 1000);

                if (diffMins < 1) {
                    freshnessText.textContent = `Updated ${diffSecs}s ago`;
                } else if (diffMins < 60) {
                    freshnessText.textContent = `Updated ${diffMins}m ago`;
                } else {
                    const diffHours = Math.floor(diffMins / 60);
                    freshnessText.textContent = `Updated ${diffHours}h ago`;
                }
            }

            // Update freshness every second
            setInterval(updateFreshness, 1000);
            updateFreshness();
        }

        // Better error handling
        function showError(container, message, retryFn = null) {
            if (!container) return;
            const errorId = `error-${Date.now()}`;
            const errorHtml = `
                <div class="error-message" role="alert" id="${errorId}">
                    <span class="error-message-icon">⚠️</span>
                    <div style="flex: 1;">
                        <strong>Error loading data</strong>
                        <div style="font-size: 0.9rem; margin-top: 4px;">${message}</div>
                        ${retryFn ? `<button class="empty-state-btn" style="margin-top: 8px; font-size: 0.85rem; padding: 6px 12px;" id="retry-${errorId}">Retry</button>` : ''}
                    </div>
                    </div>
                `;
            container.innerHTML = errorHtml;
            if (retryFn) {
                const retryBtn = document.getElementById(`retry-${errorId}`);
                if (retryBtn) {
                    retryBtn.addEventListener('click', retryFn);
                }
            }
        }

        // Loading skeleton
        function showSkeleton(container, type = 'list') {
            if (!container) return;
            if (type === 'list') {
                container.innerHTML = `
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-text" style="width: 60%;"></div>
                        <div class="skeleton skeleton-text" style="width: 80%;"></div>
                        <div class="skeleton skeleton-text" style="width: 70%;"></div>
                    </div>
                `;
            } else if (type === 'metrics') {
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div class="skeleton skeleton-text" style="height: 60px;"></div>
                        <div class="skeleton skeleton-text" style="height: 60px;"></div>
                        <div class="skeleton skeleton-text" style="height: 60px;"></div>
                        <div class="skeleton skeleton-text" style="height: 60px;"></div>
                    </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', initDashboard);
        window.addEventListener('beforeunload', stopLiveEvents);

        function initThemeToggle() {
            const toggle = document.getElementById('themeToggle');
            if (!toggle) return;
            const saved = localStorage.getItem(THEME_KEY) || 'light';
            applyTheme(saved);
            toggle.textContent = saved === 'dark' ? 'Light mode' : 'Dark mode';
            toggle.addEventListener('click', () => {
                const nextMode = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
                applyTheme(nextMode);
                toggle.textContent = nextMode === 'dark' ? 'Light mode' : 'Dark mode';
                localStorage.setItem(THEME_KEY, nextMode);
            });
        }

        function applyTheme(mode) {
            if (mode === 'dark') {
                document.body.dataset.theme = 'dark';
            } else {
                document.body.dataset.theme = '';
            }
        }

        async function handleLeadAction(action) {
            const modal = document.getElementById('leadModal');
            if (!modal) return;
            const index = modal.dataset.currentIndex;
            if (index === undefined || index === '') return;
            const lead = currentLeads[Number(index)];
            if (!lead) return;

            if (currentClient === DEMO_CLIENT_KEY || !lead.id) {
                applyLocalLeadAction(lead, action);
                dashboardData.recentLeads = dashboardData.recentLeads?.map((item, idx) =>
                    idx === Number(index) ? lead : item
                ) || currentLeads;
                renderLeads(dashboardData.recentLeads || currentLeads);
                closeLeadModal();
                showToast('Lead Updated', `Lead ${action === 'snooze' ? 'snoozed' : 'escalated'} successfully`, 'success');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/leads/${lead.id}/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const payload = await response.json();
                if (!response.ok || !payload?.ok) {
                    throw new Error(payload?.error || 'Action failed');
                }
                if (payload.lead) {
                    dashboardData.recentLeads = (dashboardData.recentLeads || []).map(item =>
                        item.id === lead.id ? { ...item, ...payload.lead } : item
                    );
                    renderLeads(dashboardData.recentLeads);
                }
                closeLeadModal();
                showToast('Lead Updated', `Lead ${action === 'snooze' ? 'snoozed' : 'escalated'} successfully`, 'success');
            } catch (error) {
                console.error('Lead action failed', error);
                showToast('Action Failed', error.message || 'Unable to update lead', 'error');
                alert(`Unable to ${action} lead. ${error.message || ''}`);
            }
        }

        function applyLocalLeadAction(lead, action) {
            if (action === 'snooze') {
                lead.status = 'Snoozed (demo)';
                lead.lastMessage = 'Lead snoozed for 1 day (demo).';
            } else {
                lead.status = 'Priority (demo)';
                lead.lastMessage = 'Escalated to operator (demo).';
            }
        }

        function initModalControls() {
            const backdrop = document.getElementById('leadModal');
            const closeBtn = document.getElementById('modalCloseBtn');
            if (closeBtn) closeBtn.addEventListener('click', closeLeadModal);
            if (backdrop) {
                backdrop.addEventListener('click', (event) => {
                    if (event.target === backdrop) closeLeadModal();
                });
            }
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeLeadModal();
                    closeTranscriptModal();
                    closeTimelineModal();
                }
            });
            const snoozeBtn = document.getElementById('modalSnoozeBtn');
            if (snoozeBtn) snoozeBtn.addEventListener('click', () => handleLeadAction('snooze'));
            const escalateBtn = document.getElementById('modalEscalateBtn');
            if (escalateBtn) escalateBtn.addEventListener('click', () => handleLeadAction('escalate'));

            const transcriptBackdrop = document.getElementById('transcriptModal');
            const transcriptCloseBtn = document.getElementById('transcriptCloseBtn');
            if (transcriptCloseBtn) transcriptCloseBtn.addEventListener('click', closeTranscriptModal);
            if (transcriptBackdrop) {
                transcriptBackdrop.addEventListener('click', (event) => {
                    if (event.target === transcriptBackdrop) closeTranscriptModal();
                });
            }

            const timelineBackdrop = document.getElementById('timelineModal');
            const timelineCloseBtn = document.getElementById('timelineCloseBtn');
            if (timelineCloseBtn) timelineCloseBtn.addEventListener('click', closeTimelineModal);
            if (timelineBackdrop) {
                timelineBackdrop.addEventListener('click', (event) => {
                    if (event.target === timelineBackdrop) closeTimelineModal();
                });
            }
        }

        function initImporter() {
            const input = document.getElementById('leadImportInput');
            const button = document.getElementById('leadImportButton');
            const dropzone = document.getElementById('leadDropzone');
            if (button && input) button.addEventListener('click', () => input.click());
            if (input) {
                input.addEventListener('change', (event) => {
                    const file = event.target.files?.[0];
                    if (file) handleLeadImportFile(file);
                    event.target.value = '';
                });
            }
            if (dropzone) {
                ['dragenter', 'dragover'].forEach(evt =>
                    dropzone.addEventListener(evt, e => {
                        e.preventDefault();
                        dropzone.classList.add('dragover');
                    })
                );
                ['dragleave', 'drop'].forEach(evt =>
                    dropzone.addEventListener(evt, e => {
                        e.preventDefault();
                        dropzone.classList.remove('dragover');
                    })
                );
                dropzone.addEventListener('drop', e => {
                    const file = e.dataTransfer.files?.[0];
                    if (file) handleLeadImportFile(file);
                });
            }
        }

        function handleLeadImportFile(file) {
            setImportStatus(`Processing ${file.name}...`);
            const reader = new FileReader();
            reader.onload = () => {
                const leads = parseCsv(reader.result);
                submitLeadImport(leads);
            };
            reader.onerror = () => setImportStatus('Unable to read file', 'error');
            reader.readAsText(file);
        }

        function parseCsv(text) {
            if (!text) return [];
            const lines = text.trim().split(/\r?\n/);
            if (lines.length < 2) return [];
            const headers = lines.shift().split(',').map(h => h.trim().toLowerCase());
            return lines
                .map(line => {
                    if (!line.trim()) return null;
                    const cells = line.split(',').map(cell => cell.trim());
                    const row = {};
                    headers.forEach((header, idx) => {
                        row[header] = cells[idx] || '';
                    });
                    return {
                        name: row.name,
                        phone: row.phone,
                        service: row.service,
                        source: row.source
                    };
                })
                .filter(lead => lead && lead.phone);
        }

        async function submitLeadImport(leads = []) {
            if (!Array.isArray(leads) || !leads.length) {
                setImportStatus('No valid rows found in CSV', 'error');
                return;
            }
            if (currentClient === DEMO_CLIENT_KEY) {
                const demoLeads = leads.map((lead, idx) => ({
                    id: Date.now() + idx,
                    name: lead.name || lead.phone,
                    phone: lead.phone,
                    service: lead.service || 'Lead Follow-Up',
                    source: lead.source || 'Import',
                    status: 'New (demo)',
                    lastMessage: 'Added via CSV import.',
                    timeAgo: 'Just now'
                }));
                // Merge imported leads with existing, keeping imported at top
                const existingLeads = (dashboardData.recentLeads || []).filter(lead => 
                    !lead.phone || !demoLeads.some(dl => dl.phone === lead.phone)
                );
                dashboardData.recentLeads = [...demoLeads, ...existingLeads].slice(0, 10);
                renderLeads(dashboardData.recentLeads);
                setImportStatus(`${demoLeads.length} leads staged (demo)`, 'success');
                showToast('Leads Imported', `${demoLeads.length} leads added (demo mode)`, 'success');
                return;
            }
            try {
                setImportStatus('Uploading leads...');
                showToast('Uploading', 'Importing leads...', 'info');
                const response = await fetch(`${BASE_URL}/api/leads/import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clientKey: currentClient, leads })
                });
                const payload = await response.json();
                if (!response.ok || !payload?.ok) {
                    throw new Error(payload?.error || 'Import failed');
                }
                if (Array.isArray(payload.leads) && payload.leads.length) {
                    dashboardData.recentLeads = [...payload.leads, ...(dashboardData.recentLeads || [])].slice(0, 5);
                    renderLeads(dashboardData.recentLeads);
                }
                setImportStatus(`Imported ${payload.inserted} leads`, 'success');
                showToast('Import Complete', `Successfully imported ${payload.inserted} leads`, 'success');
            } catch (error) {
                console.error('Import failed', error);
                const errorMsg = error.message || 'Unable to import leads. Please check your CSV format and try again.';
                setImportStatus(errorMsg, 'error');
                showToast('Import Failed', errorMsg, 'error');
            }
        }

        function setImportStatus(message, type) {
            const statusEl = document.getElementById('leadImportStatus');
            if (!statusEl) return;
            statusEl.textContent = message;
            statusEl.className = `import-status ${type || ''}`;
        }

        async function loadIntegrationHealth(clientKey) {
            if (clientKey === DEMO_CLIENT_KEY) {
                renderIntegrationStatus(DEMO_INTEGRATIONS);
                return;
            }
            try {
                const response = await fetch(`${BASE_URL}/api/integration-health/${clientKey}`);
                const payload = await response.json();
                if (payload?.ok && Array.isArray(payload.integrations)) {
                    renderIntegrationStatus(payload.integrations);
                }
            } catch (error) {
                console.warn('Failed to load integration health', error);
            }
        }
    </script>
</body>
</html>

