<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Client Dashboard - AI Booking Concierge</title>
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <link rel="alternate icon" href="/icon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #5c6ac4;
            --secondary: #3a4a9f;
            --success: #1b5e20;
            --warning: #f5a623;
            --danger: #c62828;
            --light: #f7f9fc;
            --dark: #1f2234;
            --card-shadow: 0 8px 24px rgba(16, 26, 62, 0.08);
            --surface: #ffffff;
            --text: #2b2e3b;
            --muted: #6f7390;
            --brand-font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body[data-theme="dark"] {
            --surface: #252b3d;
            --text: #ffffff;
            --muted: #d0d4e8;
            --light: #2a3145;
            background: radial-gradient(circle at top, #1f2640, #0f1324);
            color: var(--text);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: inherit;
        }
        
        body, html {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #eef2ff 0%, #e3ebff 40%, #fef9ff 100%);
            color: #2b2e3b;
            line-height: 1.5;
            font-feature-settings: 'cv02', 'cv03', 'cv04';
        }

        /* Ensure all text elements use Inter */
        h1, h2, h3, h4, h5, h6, p, span, div, a, button, input, textarea, select, label, li, td, th, strong, em, small, b, i, u, mark, del, ins, sub, sup {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px 72px;
        }
        
        .header {
            background: var(--surface);
            border-radius: 20px;
            padding: 28px 32px;
            box-shadow: var(--card-shadow);
            border-left: 6px solid var(--primary);
            border: 1px solid rgba(92,106,196,0.15);
        }
        
        .client-info {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .client-brand {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        
        .client-logo {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: #fff;
            background: var(--primary);
        }
        
        .client-details h1 {
            font-size: 2.3rem;
            color: var(--primary);
            margin-bottom: 6px;
        }
        
        .client-details p {
            color: var(--muted);
            font-size: 1rem;
            margin-top: 4px;
        }

        .status-chip {
            padding: 10px 20px;
            border-radius: 999px;
            font-weight: 600;
            background: rgba(92, 106, 196, 0.1);
            color: var(--primary);
        }

        body[data-theme="dark"] .status-chip {
            background: rgba(92,106,196,0.3);
            color: #d5d9ff;
        }

        .client-meta {
            margin-top: 18px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .meta-item {
            background: var(--light);
            border-radius: 12px;
            padding: 12px 16px;
        }

        .meta-label {
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            color: #8c8fab;
            margin-bottom: 4px;
        }

        .meta-value {
            font-weight: 600;
            color: #2f3147;
        }

        .demo-banner {
            margin-top: 18px;
            padding: 14px 18px;
            border-radius: 14px;
            background: #fff8e1;
            border-left: 4px solid #f5a623;
            color: #7a4f00;
            display: none;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 22px;
            margin: 30px 0;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            padding: 18px;
            box-shadow: var(--card-shadow);
            text-align: center;
            border: 1px solid rgba(92,106,196,0.1);
            position: relative;
            overflow: hidden;
        }

        .status-card h4 {
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-size: 0.75rem;
            color: #8c8fab;
            margin-bottom: 10px;
        }

        .status-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .status-hint {
            margin-top: 6px;
            font-size: 0.85rem;
            color: #8c8fab;
        }

        .dashboard-section {
            margin-bottom: 48px;
        }

        .section-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid rgba(92,106,196,0.15);
            position: relative;
        }

        .section-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), transparent);
            border-radius: 2px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 22px;
        }

        .card-chart {
            min-height: 280px;
        }

        .card-visual {
            min-height: 240px;
        }

        .card-list {
            min-height: 300px;
        }

        .card-metrics {
            min-height: 200px;
        }

        .card-fullwidth {
            grid-column: 1 / -1;
        }

        .priority-visual {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 8px 0;
        }

        .priority-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .priority-label {
            min-width: 120px;
            font-size: 0.9rem;
            color: #7a7fa4;
        }

        .priority-progress {
            flex: 1;
            height: 24px;
            background: rgba(92,106,196,0.08);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .priority-progress-fill {
            height: 100%;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            color: #fff;
        }

        .priority-progress-fill.high {
            background: linear-gradient(90deg, #1b5e20, #2e7d32);
        }

        .priority-progress-fill.medium {
            background: linear-gradient(90deg, #f5a623, #ff9800);
        }

        .priority-progress-fill.low {
            background: linear-gradient(90deg, #7a7fa4, #9ca3af);
        }

        .activity-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 8px 0;
        }

        .activity-metric {
            text-align: center;
            padding: 16px;
            background: rgba(92,106,196,0.06);
            border-radius: 12px;
            border: 1px solid rgba(92,106,196,0.12);
        }

        .activity-metric-label {
            font-size: 0.85rem;
            color: #7a7fa4;
            margin-bottom: 8px;
        }

        .activity-metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .status-compact {
            padding: 8px 0;
        }

        .data-freshness {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--surface);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--muted);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(92,106,196,0.1);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-freshness-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #1b5e20;
            animation: pulse 2s ease-in-out infinite;
        }

        .data-freshness-dot.offline {
            background: #c62828;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .skeleton {
            background: linear-gradient(90deg, rgba(92,106,196,0.1) 25%, rgba(92,106,196,0.15) 50%, rgba(92,106,196,0.1) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 16px;
            margin: 8px 0;
        }

        .skeleton-card {
            padding: 20px;
            border-radius: 18px;
            background: var(--surface);
            border: 1px solid rgba(92,106,196,0.08);
        }

        .empty-state-cta {
            margin-top: 16px;
        }

        .empty-state-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .empty-state-btn:hover {
            background: var(--secondary);
            transform: translateY(-1px);
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 12px 16px;
            border-radius: 10px;
            margin: 12px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .error-message-icon {
            font-size: 1.2rem;
        }

        .keyboard-hint {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--surface);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            color: var(--muted);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(92,106,196,0.1);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .keyboard-hint.show {
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #8c8fab;
        }

        .empty-state-icon {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 12px;
            display: block;
        }

        .empty-state-title {
            font-size: 1rem;
            font-weight: 600;
            color: #7a7fa4;
            margin-bottom: 6px;
        }

        .empty-state-message {
            font-size: 0.9rem;
            color: #8c8fab;
            line-height: 1.5;
        }

        .card-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: #8c8fab;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(92,106,196,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            position: relative;
        }

        .section-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), transparent);
            border-radius: 2px;
        }
        
        .card {
            background: var(--surface);
            border-radius: 18px;
            padding: 22px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(92,106,196,0.08);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover::before {
            opacity: 1;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(16, 26, 62, 0.12);
        }
        
        .card h3 {
            margin-bottom: 18px;
            font-size: 1.2rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-subtitle {
            margin-top: -10px;
            margin-bottom: 16px;
            font-size: 0.92rem;
            color: #7a7da0;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f3fb;
        }
        
        .metric-row:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: var(--muted);
        }
        
        .metric-value {
            font-weight: 600;
            color: var(--primary);
        }

        .leads-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 320px;
            overflow-y: auto;
        }

        .lead-item {
            border: 1px solid #eef0fb;
            border-radius: 12px;
            padding: 14px;
            background: #f9f9ff;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .lead-item:hover {
            transform: translateY(-2px);
            border-color: rgba(92,106,196,0.5);
        }

        .lead-name {
            font-weight: 600;
            color: #2f3147;
        }

        .lead-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #7b7f9f;
            margin-top: 6px;
        }

        .lead-status {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            background: rgba(92, 106, 196, 0.12);
            color: var(--primary);
        }
        .theme-toggle {
            border: 1px solid rgba(92,106,196,0.3);
            background: transparent;
            color: var(--primary);
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .theme-toggle:hover {
            background: rgba(92,106,196,0.1);
        }

        .test-call-btn {
            border: 1px solid rgba(27, 94, 32, 0.3);
            background: rgba(27, 94, 32, 0.1);
            color: #1b5e20;
            padding: 8px 16px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .test-call-btn:hover {
            background: rgba(27, 94, 32, 0.2);
            border-color: rgba(27, 94, 32, 0.5);
            transform: translateY(-1px);
        }

        .test-call-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        body[data-theme="dark"] .test-call-btn {
            border-color: rgba(76, 175, 80, 0.4);
            background: rgba(76, 175, 80, 0.15);
            color: #81c784;
        }

        body[data-theme="dark"] .test-call-btn:hover {
            background: rgba(76, 175, 80, 0.25);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(7, 11, 30, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(6px);
        }

        .modal-backdrop.open {
            display: flex;
        }

        .lead-modal {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px 28px;
            width: min(480px, 90%);
            box-shadow: 0 30px 60px rgba(11, 14, 32, 0.35);
            border: 1px solid rgba(92,106,196,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .modal-header h4 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text);
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--muted);
        }

        .modal-body p {
            margin: 6px 0;
            color: var(--muted);
        }

        .modal-actions {
            margin-top: 18px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .modal-btn {
            flex: 1;
            min-width: 120px;
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer;
            background: rgba(92,106,196,0.15);
            color: var(--primary);
        }

        .modal-btn.primary {
            background: var(--primary);
            color: #fff;
        }

        .import-dropzone {
            border: 1px dashed rgba(92,106,196,0.5);
            border-radius: 14px;
            padding: 18px;
            text-align: center;
            color: var(--muted);
            cursor: pointer;
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        .import-dropzone.dragover {
            border-color: var(--primary);
            background: rgba(92,106,196,0.08);
        }

        .import-dropzone button {
            border: none;
            background: var(--primary);
            color: #fff;
            padding: 6px 12px;
            border-radius: 8px;
            margin-left: 6px;
            cursor: pointer;
        }

        .import-status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .import-status.success {
            color: #1b5e20;
        }

        .import-status.error {
            color: #c62828;
        }

        .mix-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .mix-item {
            border: 1px solid rgba(92,106,196,0.12);
            border-radius: 12px;
            padding: 12px 14px;
        }

        .mix-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            color: #2f3147;
            margin-bottom: 6px;
        }

        .mix-bar {
            height: 10px;
            border-radius: 999px;
            background: #eef0ff;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .mix-bar-fill {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .mix-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #7a7fa4;
        }

        .mix-tag {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(27, 94, 32, 0.12);
            color: var(--success);
        }

        .appt-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .appt-item {
            border: 1px solid rgba(92,106,196,0.12);
            border-radius: 12px;
            padding: 12px 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .appt-name {
            font-weight: 600;
            color: #2f3147;
        }

        .appt-service {
            font-size: 0.85rem;
            color: #7a7fa4;
        }

        .appt-time {
            font-size: 0.9rem;
            color: var(--primary);
            font-weight: 600;
            text-align: right;
            min-width: 140px;
        }

        .roi-panel {
            margin-bottom: 24px;
            border-radius: 20px;
            padding: 22px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 18px;
            box-shadow: 0 15px 35px rgba(51, 65, 145, 0.4);
        }

        .roi-metric span {
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-size: 0.75rem;
            opacity: 0.85;
        }

        .roi-metric strong {
            display: block;
            font-size: 2rem;
            margin-top: 6px;
        }

        .roi-metric small {
            display: block;
            margin-top: 4px;
            opacity: 0.85;
        }

        .integration-list {
            margin-top: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .integration-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px solid rgba(92,106,196,0.12);
            border-radius: 10px;
            padding: 10px 12px;
        }

        .integration-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .integration-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #2f3147;
            font-weight: 600;
        }

        .integration-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .integration-detail {
            font-size: 0.75rem;
            color: #7a7fa4;
            line-height: 1.4;
            margin-top: 4px;
            padding-top: 8px;
            border-top: 1px solid rgba(92,106,196,0.1);
        }

        body[data-theme="dark"] .integration-detail {
            color: #a0a4c8;
            border-top-color: rgba(92,106,196,0.3);
        }

        .integration-status {
            font-weight: 600;
            text-transform: capitalize;
        }

        .integration-status.active {
            color: #1b5e20;
        }

        .integration-status.warning {
            color: #f5a623;
        }

        .integration-status.error {
            color: #c62828;
        }

        .chart {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            height: 180px;
            padding: 8px 6px;
        }

        .chart-bar {
            flex: 1;
            border-radius: 8px 8px 4px 4px;
            background: linear-gradient(180deg, rgba(92,106,196,0.85), rgba(58,74,159,0.85));
            position: relative;
        }

        .chart-bar::after {
            content: attr(data-label);
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.85rem;
            color: #8c8fab;
        }

        .chart-value {
            text-align: center;
            margin-top: 8px;
            font-size: 0.9rem;
            color: #616484;
        }

        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid #ecefff;
            background: #fbfbff;
        }

        .activity-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .activity-pill {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid rgba(148,163,184,0.5);
            background: #f4f4ff;
            color: #475569;
        }

        .activity-pill.outcome-booked {
            border-color: rgba(22,163,74,0.3);
            background: rgba(22,163,74,0.06);
            color: #166534;
        }

        .activity-pill.outcome-failed,
        .activity-pill.outcome-no-answer,
        .activity-pill.outcome_declined,
        .activity-pill.outcome-rejected {
            border-color: rgba(248,113,113,0.4);
            background: rgba(248,113,113,0.06);
            color: #b91c1c;
        }

        .activity-pill.outcome-voicemail {
            border-color: rgba(234,179,8,0.4);
            background: rgba(234,179,8,0.06);
            color: #92400e;
        }

        .activity-pill.status-in-progress {
            border-style: dashed;
            border-color: rgba(59,130,246,0.5);
            background: rgba(59,130,246,0.04);
            color: #1d4ed8;
        }

        .activity-pill.pickup-yes {
            border-color: rgba(22,163,74,0.3);
            background: rgba(22,163,74,0.06);
            color: #166534;
        }

        .activity-pill.pickup-no {
            border-color: rgba(148,163,184,0.7);
            background: rgba(148,163,184,0.08);
            color: #4b5563;
        }

        .activity-item strong {
            color: #2f3147;
        }

        .activity-meta {
            margin-top: 4px;
            color: #8b8fb0;
            font-size: 0.9rem;
        }

        .workflow-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .workflow-step {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .workflow-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(92,106,196,0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }


        .funnel {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 8px 0;
        }

        .funnel-stage {
            position: relative;
            padding: 14px 18px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(92,106,196,0.08), rgba(58,74,159,0.08));
            border: 1px solid rgba(92,106,196,0.15);
        }

        .funnel-label {
            font-weight: 600;
            color: #2f3147;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .funnel-bar {
            height: 8px;
            background: rgba(92,106,196,0.12);
            border-radius: 999px;
            overflow: hidden;
            margin-top: 8px;
        }

        .funnel-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 999px;
            transition: width 0.6s ease;
        }

        .funnel-percent {
            font-size: 0.75rem;
            color: #7a7fa4;
            margin-left: 8px;
        }


        .transcript-btn {
            background: transparent;
            border: 1px solid rgba(92,106,196,0.3);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 6px;
            transition: all 0.2s;
        }

        .transcript-btn:hover {
            background: rgba(92,106,196,0.1);
            border-color: var(--primary);
        }

        .transcript-modal {
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .transcript-content {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.8;
            color: #2f3147;
            white-space: pre-wrap;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 12px;
        }

        .forecast-chart {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            height: 200px;
            padding: 12px 6px;
            margin-top: 16px;
        }

        .forecast-bar {
            flex: 1;
            border-radius: 6px 6px 0 0;
            background: linear-gradient(180deg, rgba(92,106,196,0.6), rgba(92,106,196,0.3));
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 4px;
            color: #fff;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .forecast-bar.predicted {
            background: linear-gradient(180deg, rgba(245,166,35,0.6), rgba(245,166,35,0.3));
            border: 1px dashed rgba(245,166,35,0.8);
        }

        .export-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .export-btn {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .export-btn:hover {
            background: var(--secondary);
            transform: translateY(-1px);
        }

        .export-btn.secondary {
            background: rgba(92,106,196,0.1);
            color: var(--primary);
        }

        .export-btn.secondary:hover {
            background: rgba(92,106,196,0.2);
        }

        .active-indicator {
            background: linear-gradient(135deg, #1b5e20, #2e7d32);
            color: #fff;
            padding: 12px 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(27,94,32,0.3);
        }

        .active-indicator.pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .active-indicator-dot {
            width: 12px;
            height: 12px;
            background: #4caf50;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .active-indicator-content {
            flex: 1;
        }

        .active-indicator-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .active-indicator-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .call-quality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            padding: 8px 0;
        }

        .quality-metric {
            text-align: center;
            padding: 12px;
            background: rgba(92,106,196,0.05);
            border-radius: 10px;
        }

        .quality-label {
            font-size: 0.75rem;
            color: #7a7fa4;
            margin-bottom: 6px;
        }

        .quality-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
        }

        .quality-badge {
            font-size: 0.7rem;
            color: #7a7fa4;
            margin-top: 4px;
        }

        .retry-queue {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 8px 0;
        }

        .retry-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: rgba(245,166,35,0.1);
            border-radius: 8px;
            border-left: 3px solid #f5a623;
        }

        .retry-name {
            font-weight: 600;
            color: #2f3147;
            font-size: 0.9rem;
        }

        .retry-meta {
            font-size: 0.75rem;
            color: #7a7fa4;
            margin-top: 2px;
        }

        .retry-status {
            font-size: 0.75rem;
            color: #f5a623;
            font-weight: 600;
        }

        .timeline-modal {
            max-width: 600px;
        }

        .timeline {
            padding: 16px 0;
        }

        .timeline-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-left: 2px solid #e0e0e0;
            margin-left: 16px;
            padding-left: 20px;
            position: relative;
        }

        .timeline-item:last-child {
            border-left: none;
        }

        .timeline-dot {
            position: absolute;
            left: -8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            border: 3px solid #fff;
            box-shadow: 0 0 0 2px var(--primary);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 600;
            color: #2f3147;
            margin-bottom: 4px;
        }

        .timeline-meta {
            font-size: 0.8rem;
            color: #7a7fa4;
        }


        .recording-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .recording-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: #fff;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .play-btn:hover {
            background: var(--secondary);
            transform: scale(1.1);
        }

        .recording-info {
            flex: 1;
        }

        .recording-name {
            font-weight: 600;
            color: #2f3147;
            font-size: 0.9rem;
        }

        .recording-meta {
            font-size: 0.75rem;
            color: #7a7fa4;
            margin-top: 2px;
        }

        .calendar-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 8px 0;
        }

        .calendar-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 12px;
            background: rgba(92,106,196,0.04);
            border-radius: 8px;
        }

        .calendar-detail-label {
            font-size: 0.85rem;
            color: #7a7fa4;
        }

        .calendar-detail-value {
            font-weight: 600;
            color: #2f3147;
            font-size: 0.85rem;
        }

        .calendar-detail-value.success {
            color: #1b5e20;
        }

        .calendar-detail-value.warning {
            color: #f5a623;
        }

        .timeline-btn {
            background: transparent;
            border: 1px solid rgba(92,106,196,0.3);
            color: var(--primary);
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-top: 4px;
            transition: all 0.2s;
        }

        .timeline-btn:hover {
            background: rgba(92,106,196,0.1);
            border-color: var(--primary);
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
            pointer-events: none;
        }

        .toast {
            background: var(--surface);
            border-radius: 12px;
            padding: 14px 18px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--primary);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            pointer-events: auto;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-in 2.7s;
            animation-fill-mode: forwards;
            min-width: 280px;
            max-width: 400px;
        }

        .toast.success {
            border-left-color: #1b5e20;
        }

        .toast.error {
            border-left-color: #c62828;
        }

        .toast.warning {
            border-left-color: #f5a623;
        }

        .toast.info {
            border-left-color: var(--primary);
        }

        .toast-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            color: #2f3147;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .toast-message {
            color: #7a7fa4;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .toast-close {
            background: transparent;
            border: none;
            color: #8c8fab;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: color 0.2s;
        }

        .toast-close:hover {
            color: #2f3147;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        body[data-theme="dark"] .toast {
            background: #1f2335;
            border-left-color: var(--primary);
        }

        body[data-theme="dark"] .toast-title {
            color: #eef0ff;
        }

        body[data-theme="dark"] .toast-message {
            color: #b1b6d4;
        }

        body[data-theme="dark"] .toast-close {
            color: #b1b6d4;
        }

        body[data-theme="dark"] .toast-close:hover {
            color: #eef0ff;
        }

        /* Dark mode readability improvements - brighter text and better contrast */
        body[data-theme="dark"] .card {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        body[data-theme="dark"] .status-card {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .status-card h4 {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .status-hint {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .card-subtitle {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .lead-item {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .lead-name {
            color: #ffffff;
        }

        body[data-theme="dark"] .lead-meta {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .activity-item {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .activity-item strong {
            color: #ffffff;
        }

        body[data-theme="dark"] .activity-meta {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .meta-label {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .meta-value {
            color: #ffffff;
        }

        body[data-theme="dark"] .metric-label {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .metric-row {
            border-bottom-color: rgba(92,106,196,0.3);
        }

        body[data-theme="dark"] .section-header {
            color: #e8ebff;
            border-bottom-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .header {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .client-details h1 {
            color: #e8ebff;
        }

        body[data-theme="dark"] .client-details p {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .roi-panel {
            background: linear-gradient(135deg, #2f3650 0%, #252b3d 100%);
            border-color: rgba(92,106,196,0.6);
        }

        body[data-theme="dark"] .demo-banner {
            background: #2f3650;
            border-left-color: #f5a623;
            color: #ffd54f;
        }

        body[data-theme="dark"] .active-indicator {
            background: rgba(27, 94, 32, 0.4);
            border-color: rgba(27, 94, 32, 0.6);
        }

        body[data-theme="dark"] .integration-item {
            border-color: rgba(92,106,196,0.4);
        }

        body[data-theme="dark"] .integration-label {
            color: #ffffff;
        }

        body[data-theme="dark"] .integration-status {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .transcript-content {
            background: #252b3d;
            color: #ffffff;
            border: 1px solid rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .timeline-item {
            border-left-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .timeline-title {
            color: #ffffff;
        }

        body[data-theme="dark"] .timeline-meta {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .modal-backdrop {
            background: rgba(0, 0, 0, 0.85);
        }

        body[data-theme="dark"] .lead-modal {
            background: #252b3d;
            border-color: rgba(92,106,196,0.6);
        }

        body[data-theme="dark"] .lead-modal h4 {
            color: #ffffff;
        }

        body[data-theme="dark"] .lead-modal p {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .lead-modal strong {
            color: #ffffff;
        }

        body[data-theme="dark"] .card h3 {
            color: #ffffff;
        }

        body[data-theme="dark"] .status-value {
            color: #a8b4ff;
        }

        body[data-theme="dark"] .funnel-label {
            color: #ffffff;
        }

        body[data-theme="dark"] .funnel-value {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .retry-item {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .retry-item strong {
            color: #ffffff;
        }

        body[data-theme="dark"] .retry-name {
            color: #ffffff !important;
        }

        body[data-theme="dark"] .retry-meta {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .appt-item {
            background: #252b3d;
            border-color: rgba(92,106,196,0.5);
        }

        body[data-theme="dark"] .appt-name {
            color: #ffffff !important;
        }

        body[data-theme="dark"] .recording-item {
            background: #2a3145 !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body[data-theme="dark"] .recording-name {
            color: #ffffff !important;
        }

        body[data-theme="dark"] .recording-meta {
            color: #d0d4e8 !important;
        }

        body[data-theme="dark"] .appt-service {
            color: #d0d4e8;
        }

        body[data-theme="dark"] .appt-time {
            color: #a8b4ff;
        }
        
        @media (max-width: 768px) {
            .section-header {
                font-size: 1.3rem;
                margin-bottom: 16px;
            }

            .dashboard-section {
                margin-bottom: 32px;
            }

            .activity-grid {
                grid-template-columns: 1fr;
            }
            
            .priority-visual {
                gap: 10px;
            }

            .priority-label {
                min-width: 100px;
                font-size: 0.85rem;
            }

            .toast-container {
                top: 12px;
                right: 12px;
                left: 12px;
                max-width: 100%;
            }

            .toast {
                min-width: auto;
                max-width: 100%;
            }
            .client-info {
                flex-direction: column;
                align-items: flex-start;
            }
            .status-bar {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .roi-panel {
                grid-template-columns: 1fr;
                padding: 16px;
            }
            .export-buttons {
                flex-direction: column;
            }
            .export-btn {
                width: 100%;
                justify-content: center;
            }
            .chart, .forecast-chart {
                height: 150px;
            }
            .funnel {
                gap: 12px;
            }
            .activity-item {
                padding: 12px;
            }
            .lead-item {
                padding: 10px;
            }
            .container {
                padding: 20px 12px 48px;
            }
            .header {
                padding: 20px 16px;
            }
            .card {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="client-info">
                <div class="client-brand">
                    <div class="client-logo" id="clientLogo">âœ¨</div>
                    <div class="client-details">
                        <h1 id="clientName">Your Concierge Dashboard</h1>
                        <p id="clientDescription">See what we're doing for you - calls, follow-ups, and bookings</p>
                        <p id="clientTagline">We chase every lead you already paid for and land them on your calendar.</p>
                        <p id="clientSubtitle" style="font-size: 0.95rem; color: var(--muted); margin-top: 8px; display: none;"></p>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:12px;">
                    <div class="status-chip" style="background: #1b5e20; color: #fff;" id="conciergeStatus">âœ“ Concierge Active</div>
                    <button class="test-call-btn" id="testCallBtn" type="button" aria-label="Test call" style="display: none;">ðŸ“ž Test Call</button>
                    <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle dark mode">Dark mode</button>
                    <div class="status-chip" id="clientStatus">Live</div>
                </div>
            </div>
            
            <div class="client-meta" id="clientMeta">
                <div class="meta-item">
                    <div class="meta-label">Phone</div>
                    <div class="meta-value" id="metaPhone">â€”</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Timezone</div>
                    <div class="meta-value" id="metaTimezone">â€”</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Business Hours</div>
                    <div class="meta-value" id="metaHours">â€”</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Industry</div>
                    <div class="meta-value" id="metaIndustry">â€”</div>
            </div>
        </div>
        
            <div class="demo-banner" id="demoBanner">
                <strong>Demo environment:</strong> This sandbox mirrors the live dashboard your clients see. We just preload it with mock data for Looms.
            </div>
        </header>

        <div class="active-indicator pulse" id="activeIndicator">
            <div class="active-indicator-dot"></div>
            <div class="active-indicator-content">
                <div class="active-indicator-title" id="activeTitle">Your concierge is active</div>
                <div class="active-indicator-subtitle" id="activeSubtitle">Working on leads right now</div>
                </div>
            </div>
            
        <section class="status-bar" role="region" aria-label="Dashboard statistics">
            <div class="status-card" title="Total leads we're handling for you" role="article" aria-label="Leads we're managing">
                <h4 id="statusCardLeads">Leads We're Managing</h4>
                <div class="status-value" id="statusTotalLeads" aria-live="polite">â€”</div>
                <p class="status-hint" id="statusHintLeads">Loading...</p>
                </div>
            <div class="status-card" title="Calls your concierge has made" role="article" aria-label="Calls we've made">
                <h4 id="statusCardCalls">Calls We've Made</h4>
                <div class="status-value" id="statusTotalCalls" aria-live="polite">â€”</div>
                <p class="status-hint" id="statusHintCalls">Loading...</p>
            </div>
            <div class="status-card" title="Conversion rate from our follow-up" role="article" aria-label="Our conversion rate">
                <h4 id="statusCardConversion">Our Conversion Rate</h4>
                <div class="status-value" id="statusConversionRate" aria-live="polite">â€”</div>
                <p class="status-hint" id="statusHintConversion">Loading...</p>
            </div>
            <div class="status-card" title="How fast we respond to your leads" role="article" aria-label="Our response time">
                <h4 id="statusCardResponse">Our Response Time</h4>
                <div class="status-value" id="statusFirstResponse" aria-live="polite">â€”</div>
                <p class="status-hint" id="statusHintResponse">Loading...</p>
            </div>
        </section>

        <section class="roi-panel">
            <div class="roi-metric">
                <span>Your Investment (30d)</span>
                <strong id="roiSpend">Â£0</strong>
                <small>our service fee</small>
                </div>
            <div class="roi-metric">
                <span>Revenue We Generated</span>
                <strong id="roiRevenue">Â£0</strong>
                <small id="roiBookings">from bookings we made</small>
            </div>
            <div class="roi-metric">
                <span>Your ROI</span>
                <strong id="roiMultiplier">0x</strong>
                <small id="roiProfit">Â£0 profit</small>
            </div>
        </section>

        <!-- PERFORMANCE & ANALYTICS SECTION -->
        <section class="dashboard-section">
            <h2 class="section-header">ðŸ“Š Performance & Analytics</h2>
            <div class="dashboard-grid">
                <article class="card card-chart">
                    <h3>ðŸ”„ Conversion Funnel</h3>
                    <p class="card-subtitle" id="conversionFunnelSubtitle">How we convert your leads into bookings.</p>
                    <div id="lead-journey" class="funnel"></div>
                </article>

                <article class="card card-chart">
                    <h3>ðŸ“Š Weekly Activity</h3>
                    <p class="card-subtitle" id="weeklyActivitySubtitle">Calls and bookings we made this week.</p>
                    <div id="performance-chart">
                        <div class="chart" id="chartBars"></div>
                        <p class="chart-value" id="chartSummary">18 bookings we made this week</p>
                </div>
                    <div class="export-buttons">
                        <button class="export-btn secondary" onclick="exportData('calls')">ðŸ“¥ Export</button>
            </div>
                </article>


                <article class="card">
                    <h3>ðŸ“Š Call Quality</h3>
                    <p class="card-subtitle">How effective our calls are.</p>
                    <div id="call-quality" class="call-quality-grid"></div>
                </article>
                </div>
        </section>

        <!-- LEAD MANAGEMENT SECTION -->
        <section class="dashboard-section">
            <h2 class="section-header">ðŸ‘¥ Lead Management</h2>
            <div class="dashboard-grid">

                <article class="card card-list">
                    <h3>ðŸ“‹ Recent Leads</h3>
                    <p class="card-subtitle" id="recentLeadsSubtitle">Leads we're actively following up on.</p>
                    <div id="leads-list" class="leads-list"></div>
                    <div class="export-buttons">
                        <button class="export-btn secondary" onclick="exportData('leads')">ðŸ“¥ Export</button>
            </div>
                </article>

                <article class="card">
                    <h3>ðŸ“¤ Upload Leads</h3>
                    <p class="card-subtitle">Send us more leads to follow up on.</p>
                    <div class="import-dropzone" id="leadDropzone">
                        Drag & drop CSV or <button type="button" id="leadImportButton">browse</button>
                        <small style="display:block;margin-top:6px;">Columns: name, phone, service, source</small>
                    </div>
                    <div style="margin-top:10px;">
                        <button type="button" id="leadPasteToggle" class="export-btn secondary" style="font-size:12px;padding:4px 8px;">
                            Or paste numbers instead
                        </button>
                    </div>
                    <div id="leadPasteContainer" style="display:none;margin-top:10px;">
                        <label for="leadPasteInput" style="display:block;font-size:12px;margin-bottom:4px;">
                            Paste one lead per line (phone only, or name, phone, service, source)
                        </label>
                        <textarea
                            id="leadPasteInput"
                            rows="4"
                            style="width:100%;border-radius:8px;padding:8px;font-size:12px;resize:vertical;"
                            placeholder="+447700900123&#10;John Smith, +447700900124&#10;Jane Doe, +447700900125, Boiler service, Facebook Ads"></textarea>
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
                            <button type="button" id="leadPasteSubmit" class="export-btn" style="font-size:12px;padding:6px 10px;">
                                Upload pasted leads
                            </button>
                            <small style="font-size:11px;color:var(--muted-text, #6b7280);">Weâ€™ll add them to your call queue immediately.</small>
                        </div>
                    </div>
                    <input type="file" id="leadImportInput" accept=".csv" style="display:none">
                    <div class="import-status" id="leadImportStatus"></div>
                </article>

                <article class="card">
                    <h3>ðŸ”„ Retry Queue</h3>
                    <p class="card-subtitle" id="retryQueueSubtitle">Leads we're retrying after initial contact.</p>
                    <div id="retry-queue" class="retry-queue"></div>
                </article>
            </div>
        </section>

        <!-- OPERATIONS SECTION -->
        <section class="dashboard-section">
            <h2 class="section-header">âš¡ Daily Operations</h2>
            <div class="dashboard-grid">
                <article class="card card-metrics">
                    <h3>ðŸ“ˆ Today's Activity</h3>
                    <p class="card-subtitle" id="todaysActivitySubtitle">What we accomplished in the last 24 hours.</p>
                    <div id="recent-activity" class="activity-grid"></div>
                </article>

                <article class="card card-list">
                    <h3>ðŸ“… Upcoming Appointments</h3>
                    <p class="card-subtitle" id="appointmentsSubtitle">Appointments we booked for you.</p>
                    <div id="upcoming-appointments" class="appt-list"></div>
                    <div class="export-buttons">
                        <button class="export-btn secondary" onclick="exportData('appointments')">ðŸ“¥ Export</button>
            </div>
                </article>

                <article class="card card-list">
                    <h3>ðŸŽ™ï¸ Call Recordings</h3>
                    <p class="card-subtitle" id="callRecordingsSubtitle">Listen to recent calls we made.</p>
                    <div id="call-recordings"></div>
                </article>
                </div>
        </section>

        <!-- SYSTEM STATUS SECTION -->
        <section class="dashboard-section">
            <h2 class="section-header">âš™ï¸ System Status</h2>
            <div class="dashboard-grid">
                <article class="card">
                    <h3>ðŸ”Œ Integrations</h3>
                    <p class="card-subtitle">Everything connected to handle your bookings.</p>
                    <div id="system-status" class="status-compact">
                        <div class="metric-row">
                            <span class="metric-label">Lead number</span>
                            <span class="metric-value" id="statusPhone">â€”</span>
            </div>
                        <div class="metric-row">
                            <span class="metric-label">SMS</span>
                            <span class="metric-value" id="statusSMS">â€”</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Calendar</span>
                            <span class="metric-value" id="statusCalendar">â€”</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Business Hours</span>
                            <span class="metric-value" id="statusCoverage">â€”</span>
                        </div>
                    </div>
                    <div id="integration-health" class="integration-list"></div>
                    <div id="calendar-details" class="calendar-details"></div>
                </article>
            </div>
        </section>

        <!-- LIVE ACTIVITY SECTION -->
        <section class="dashboard-section">
            <article class="card card-fullwidth">
                <h3>ðŸ—“ï¸ Live Activity Feed</h3>
                <p class="card-subtitle">Real-time conversations your concierge is having with your leads.</p>
                <div id="recent-calls" class="activity-feed"></div>
            </article>
        </section>

        <!-- WORKFLOW SECTION -->
        <section class="dashboard-section">
            <article class="card card-fullwidth">
                <h3>ðŸ“‹ How We Handle Everything For You</h3>
                <p class="card-subtitle">Your done-for-you workflow - this is what we do automatically every day.</p>
                <ul id="workflow" class="workflow-list"></ul>
            </article>
        </section>
                </div>

    <div class="data-freshness" id="dataFreshness" role="status" aria-live="polite">
        <span class="data-freshness-dot" id="freshnessDot"></span>
        <span id="freshnessText">Data syncing...</span>
            </div>

    <div class="keyboard-hint" id="keyboardHint" role="tooltip" aria-hidden="true">
        Press <kbd>?</kbd> for keyboard shortcuts
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <div class="modal-backdrop" id="leadModal" role="dialog" aria-labelledby="modalLeadName" aria-modal="true">
        <div class="lead-modal">
            <div class="modal-header">
                <h4 id="modalLeadName">Lead Name</h4>
                <button class="modal-close" id="modalCloseBtn" aria-label="Close lead modal">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Service:</strong> <span id="modalLeadService">â€”</span></p>
                <p><strong>Source:</strong> <span id="modalLeadSource">â€”</span></p>
                <p><strong>Status:</strong> <span id="modalLeadStatus">â€”</span></p>
                <p><strong>Last message:</strong></p>
                <p id="modalLeadNotes">â€”</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn" id="modalSnoozeBtn" aria-label="Snooze lead for 1 day">Snooze 1 day</button>
                <button type="button" class="modal-btn primary" id="modalEscalateBtn" aria-label="Escalate lead to operator">Escalate</button>
            </div>
        </div>
    </div>
    
    <div class="modal-backdrop" id="transcriptModal" role="dialog" aria-labelledby="transcriptModalTitle" aria-modal="true">
        <div class="lead-modal transcript-modal">
            <div class="modal-header">
                <h4 id="transcriptModalTitle">Call Transcript</h4>
                <button class="modal-close" id="transcriptCloseBtn" aria-label="Close transcript modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="transcript-content" id="transcriptContent" role="region" aria-live="polite">Loading transcript...</div>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="timelineModal" role="dialog" aria-labelledby="timelineModalTitle" aria-modal="true">
        <div class="lead-modal timeline-modal">
            <div class="modal-header">
                <h4 id="timelineModalTitle">Lead Journey Timeline</h4>
                <button class="modal-close" id="timelineCloseBtn" aria-label="Close timeline modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="timeline" id="timelineContent" role="region" aria-live="polite">Loading timeline...</div>
            </div>
        </div>
    </div>
    
    <script>
        const DEMO_CLIENT_KEY = 'demo_client';
        const BASE_URL = window.location.origin;
        const THEME_KEY = 'dashboard_theme';
        
        // Global client name for personalization
        let clientBusinessName = 'Your Business';
        
        // XSS Protection: Escape HTML to prevent XSS attacks
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }
        
        // Industry-specific color schemes
        function getIndustryColors(industry) {
            const colors = {
                dental: { primary: '#2e7d32', secondary: '#1b5e20', accent: '#4caf50' },
                fitness: { primary: '#d32f2f', secondary: '#b71c1c', accent: '#f44336' },
                beauty: { primary: '#c2185b', secondary: '#880e4f', accent: '#e91e63' },
                legal: { primary: '#1565c0', secondary: '#0d47a1', accent: '#2196f3' },
                medical: { primary: '#0277bd', secondary: '#01579b', accent: '#03a9f4' },
                default: { primary: '#5c6ac4', secondary: '#3a4a9f', accent: '#10b981' }
            };
            return colors[industry?.toLowerCase()] || colors.default;
        }
        
        // Industry-specific messaging
        function getIndustryMessaging(industry, businessName, services) {
            const industryLower = (industry || '').toLowerCase();
            const serviceList = Array.isArray(services) ? services.join(', ') : (services || 'services');
            
            const messaging = {
                dental: {
                    tagline: `We're calling every lead you've already paid for and booking them into your calendar.`,
                    description: `Your AI receptionist is following up on leads and booking appointments 24/7.`,
                    workflow: [
                        { icon: 'ðŸ“¥', title: 'Import leads', desc: 'We pull directly from your CRM, forms, or spreadsheets.' },
                        { icon: 'ðŸ¤–', title: 'AI speed-to-lead', desc: 'Calls go out within minutes to convert inquiries into appointments.' },
                        { icon: 'ðŸ“…', title: 'Appointments land in calendar', desc: 'Confirmed bookings drop straight into your practice calendar.' },
                        { icon: 'ðŸ“Š', title: 'Daily digest', desc: 'Email summary with leads touched and appointments booked.' }
                    ]
                },
                fitness: {
                    tagline: `We're calling every lead you've already paid for and booking them into your calendar.`,
                    description: `Your AI booking assistant is following up on leads and scheduling sessions 24/7.`,
                    workflow: [
                        { icon: 'ðŸ“¥', title: 'Import leads', desc: 'We pull directly from your CRM, forms, or spreadsheets.' },
                        { icon: 'ðŸ¤–', title: 'AI speed-to-lead', desc: 'Calls go out within minutes to convert inquiries into sessions.' },
                        { icon: 'ðŸ“…', title: 'Sessions land in calendar', desc: 'Confirmed bookings drop straight into your training calendar.' },
                        { icon: 'ðŸ“Š', title: 'Daily digest', desc: 'Email summary with leads touched and sessions booked.' }
                    ]
                },
                beauty: {
                    tagline: `We're calling every lead you've already paid for and booking them into your calendar.`,
                    description: `Your AI booking assistant is following up on leads and scheduling appointments 24/7.`,
                    workflow: [
                        { icon: 'ðŸ“¥', title: 'Import leads', desc: 'We pull directly from your CRM, forms, or spreadsheets.' },
                        { icon: 'ðŸ¤–', title: 'AI speed-to-lead', desc: 'Calls go out within minutes to convert inquiries into bookings.' },
                        { icon: 'ðŸ“…', title: 'Appointments land in calendar', desc: 'Confirmed bookings drop straight into your salon calendar.' },
                        { icon: 'ðŸ“Š', title: 'Daily digest', desc: 'Email summary with leads touched and appointments booked.' }
                    ]
                },
                legal: {
                    tagline: `We're calling every lead you've already paid for and booking them into your calendar.`,
                    description: `Your AI receptionist is following up on leads and scheduling consultations 24/7.`,
                    workflow: [
                        { icon: 'ðŸ“¥', title: 'Import leads', desc: 'We pull directly from your CRM, forms, or spreadsheets.' },
                        { icon: 'ðŸ¤–', title: 'AI speed-to-lead', desc: 'Calls go out within minutes to convert inquiries into consultations.' },
                        { icon: 'ðŸ“…', title: 'Consultations land in calendar', desc: 'Confirmed bookings drop straight into your practice calendar.' },
                        { icon: 'ðŸ“Š', title: 'Daily digest', desc: 'Email summary with leads touched and consultations booked.' }
                    ]
                },
                medical: {
                    tagline: `We're calling every lead you've already paid for and booking them into your calendar.`,
                    description: `Your AI receptionist is following up on leads and scheduling appointments 24/7.`,
                    workflow: [
                        { icon: 'ðŸ“¥', title: 'Import leads', desc: 'We pull directly from your CRM, forms, or spreadsheets.' },
                        { icon: 'ðŸ¤–', title: 'AI speed-to-lead', desc: 'Calls go out within minutes to convert inquiries into appointments.' },
                        { icon: 'ðŸ“…', title: 'Appointments land in calendar', desc: 'Confirmed bookings drop straight into your practice calendar.' },
                        { icon: 'ðŸ“Š', title: 'Daily digest', desc: 'Email summary with leads touched and appointments booked.' }
                    ]
                }
            };
            
            const match = messaging[industryLower] || messaging.dental;
            return {
                tagline: match.tagline.replace('[Business]', businessName || 'Your Business'),
                description: match.description,
                workflow: match.workflow
            };
        }
        
        // Apply client branding (colors, logo, fonts)
        function applyClientBranding(config) {
            console.log('[applyClientBranding] Config:', {
                hasWhiteLabel: !!config.whiteLabel,
                hasBranding: !!config.whiteLabel?.branding,
                primaryColor: config.primaryColor || config.whiteLabel?.branding?.primaryColor,
                secondaryColor: config.secondaryColor || config.whiteLabel?.branding?.secondaryColor,
                accentColor: config.accentColor || config.whiteLabel?.branding?.accentColor
            });
            
            // Get branding from whiteLabel.branding or top-level config
            const branding = config.whiteLabel?.branding || {};
            const industry = config.industry || '';
            const industryColors = getIndustryColors(industry);
            
            // Try multiple sources for colors: whiteLabel.branding, top-level config, or industry defaults
            const primaryColor = branding.primaryColor || config.primaryColor || industryColors.primary;
            const secondaryColor = branding.secondaryColor || config.secondaryColor || industryColors.secondary;
            const accentColor = branding.accentColor || config.accentColor || industryColors.accent;
            const fontFamily = branding.fontFamily || config.fontFamily || "'Inter', sans-serif";
            
            console.log('[applyClientBranding] Applying colors:', { primaryColor, secondaryColor, accentColor });
            
            // Apply CSS variables dynamically (always apply, even if using defaults)
            if (primaryColor) {
            document.documentElement.style.setProperty('--primary', primaryColor);
                console.log('[applyClientBranding] Set --primary to', primaryColor);
            }
            if (secondaryColor) {
            document.documentElement.style.setProperty('--secondary', secondaryColor);
                console.log('[applyClientBranding] Set --secondary to', secondaryColor);
            }
            if (accentColor) {
            document.documentElement.style.setProperty('--success', accentColor);
                console.log('[applyClientBranding] Set --success to', accentColor);
            }
            if (fontFamily) {
            document.documentElement.style.setProperty('--brand-font', fontFamily);
            }
            
            // Apply custom logo (image or emoji)
            const logoEl = document.getElementById('clientLogo');
            if (logoEl) {
                if (branding.logo) {
                    if (branding.logo.startsWith('http') || branding.logo.startsWith('/')) {
                        logoEl.innerHTML = `<img src="${escapeHtml(branding.logo)}" alt="${escapeHtml(config.displayName || 'Logo')}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 12px;">`;
                    } else {
                        logoEl.textContent = branding.logo;
                    }
                } else {
                    // Industry-specific default logos
                    const industryLogos = {
                        dental: 'ðŸ¦·',
                        fitness: 'ðŸ’ª',
                        beauty: 'ðŸ’…',
                        legal: 'âš–ï¸',
                        medical: 'ðŸ¥',
                        default: 'ðŸ¢'
                    };
                    logoEl.textContent = config.logo || industryLogos[industry?.toLowerCase()] || industryLogos.default;
                }
            }
        }
        
        const CLIENT_CONFIG = {
            demo_client: {
                name: 'Demo Booking Partner',
                description: 'Live sandbox showing the AI concierge following up + booking',
                tagline: 'Upload existing leads â†’ AI calls in minutes â†’ appointments land in your calendar.',
                logo: 'âœ¨',
                status: 'Demo Live',
                phone: '+44 20 3880 1234',
                timezone: 'Europe/London',
                businessHours: '8am - 8pm, 7 days/week',
                industry: 'AI Booking Concierge',
                workflow: [
                    { icon: 'ðŸ“¥', title: 'Import leads', desc: 'We pull directly from your CRM, forms, or spreadsheets.' },
                    { icon: 'ðŸ¤–', title: 'AI speed-to-lead', desc: 'Calls + SMS go out within minutes (24/7 coverage).' },
                    { icon: 'ðŸ“…', title: 'Bookings land in calendar', desc: 'Confirmed appointments drop straight into your calendar.' },
                    { icon: 'ðŸ“Š', title: 'Daily digest', desc: 'Slack/email summary with leads touched and outcomes.' }
                ],
                chart: [5, 7, 6, 9, 8, 10, 7]
            }
        };

        function generatePersonalizedDemoData(clientConfig) {
            const businessName = clientConfig.displayName || 'Business';
            const services = clientConfig.services || ['Service'];
            const primaryService = services[0];
            const industry = clientConfig.industry || 'business';
            
            // Generate service-specific lead names and scenarios
            const leadNames = ['Jordan Hale', 'Priya Desai', 'Lewis Grant', 'Emily Carr', 'Tom Osei'];
            const statuses = [
                `Booked â€¢ ${primaryService} confirmed`,
                `Awaiting reply â€¢ interested in ${primaryService}`,
                `Engaged â€¢ asked about ${primaryService}`,
                `Left voicemail â€¢ SMS reminder sent`,
                `Nurture â€¢ considering ${primaryService}`
            ];
            
            return {
                totalLeads: 48,
                totalCalls: 36,
                last24hLeads: 7,
                conversionRate: 63,
                successRate: 84,
                firstResponse: '2m 58s',
                bookingsThisWeek: 18,
                avgLeadScore: 87,
                highPriorityLeads: 9,
                mediumPriorityLeads: 14,
                lowPriorityLeads: 7,
                touchpoints: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    data: [5, 7, 6, 9, 8, 10, 7]
                },
                recentLeads: [
                    { id: 1, name: leadNames[0], phone: '+44 7700 900451', service: primaryService, status: statuses[0], source: 'Website form', timeAgo: '2 min ago', lastMessage: `"Got the confirmation, see you Tuesday."` },
                    { id: 2, name: leadNames[1], phone: '+44 7700 900512', service: primaryService, status: statuses[1], source: 'Referral', timeAgo: '9 min ago', lastMessage: `Asked about ${primaryService}; AI sent options.` },
                    { id: 3, name: leadNames[2], phone: '+44 7700 900623', service: primaryService, status: statuses[2], source: 'Google Ads', timeAgo: '25 min ago', lastMessage: `Shared information + queued callback tomorrow.` },
                    { id: 4, name: leadNames[3], phone: '+44 7700 900734', service: primaryService, status: statuses[3], source: 'Facebook Lead', timeAgo: '40 min ago', lastMessage: 'Voicemail dropped, SMS reminder scheduled at 9am.' },
                    { id: 5, name: leadNames[4], phone: '+44 7700 900845', service: primaryService, status: statuses[4], source: 'Website form', timeAgo: '58 min ago', lastMessage: 'Sent information PDF.' }
                ],
                serviceMix: services.map((service, i) => ({
                    name: service,
                    percent: i === 0 ? 45 : Math.floor(55 / (services.length - 1)),
                    notes: `${service} bookings`
                })),
                recentCalls: [
                    { id: 'demo-1', name: 'Sarah Patel', summary: `Booked ${primaryService} via AI call`, channel: 'Phone', timeAgo: '2 min ago' },
                    { id: 'demo-2', name: 'Marcus Flynn', summary: `Requested reschedule â€¢ SMS follow-up sent`, channel: 'SMS â†’ Call', timeAgo: '9 min ago' },
                    { id: 'demo-3', name: 'Laura Chen', summary: `Synced with calendar â€¢ reminder scheduled`, channel: 'Webhook sync', timeAgo: '25 min ago' },
                    { id: 'demo-4', name: 'Rick Alvarez', summary: `Moved appointment â€¢ calendar updated`, channel: 'Phone', timeAgo: '42 min ago' }
                ],
                appointments: [
                    { id: 101, name: 'Isla Brown', service: primaryService, start: new Date(Date.now() + 60 * 60 * 1000).toISOString(), status: 'booked' },
                    { id: 102, name: 'Liam Wright', service: primaryService, start: new Date(Date.now() + 3 * 60 * 60 * 1000).toISOString(), status: 'booked' },
                    { id: 103, name: 'Maya Reyes', service: primaryService, start: new Date(Date.now() + 6 * 60 * 60 * 1000).toISOString(), status: 'pending' }
                ],
                roi: {
                    costs: { total: 612.4, perCall: 12.4 },
                    revenue: { total: 6280, bookings: 18, avgDealValue: 349 },
                    roi: { profit: 5667.6, multiplier: 10.3, percentage: 930 }
                }
            };
        }

        const DEMO_DATA = {
            totalLeads: 48,
            totalCalls: 36,
            last24hLeads: 7,
            conversionRate: 63,
            successRate: 84,
            firstResponse: '2m 58s',
            bookingsThisWeek: 18,
            avgLeadScore: 87,
            highPriorityLeads: 9,
            mediumPriorityLeads: 14,
            lowPriorityLeads: 7,
            touchpoints: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                data: [5, 7, 6, 9, 8, 10, 7]
            },
            recentLeads: [
                { id: 1, name: 'Jordan Hale', phone: '+44 7700 900451', service: 'AI Strategy Session', status: 'Booked â€¢ calendar invite sent', source: 'Facebook Lead Ad', timeAgo: '2 min ago', lastMessage: 'â€œGot the confirmation, see you Tuesday.â€' },
                { id: 2, name: 'Priya Desai', phone: '+44 7700 900512', service: 'Follow-up Call', status: 'Awaiting reply â€¢ wants afternoon slot', source: 'Website form', timeAgo: '9 min ago', lastMessage: 'Asked for 4-6pm slot; AI sent options.' },
                { id: 3, name: 'Lewis Grant', phone: '+44 7700 900623', service: 'Pricing Review', status: 'Engaged â€¢ asked for case study', source: 'Referral', timeAgo: '25 min ago', lastMessage: 'Shared case study + queued callback tomorrow.' },
                { id: 4, name: 'Emily Carr', phone: '+44 7700 900734', service: 'Calendar Integration', status: 'Left voicemail â€¢ SMS reminder queued', source: 'CRM import', timeAgo: '40 min ago', lastMessage: 'Voicemail dropped, SMS reminder scheduled at 9am.' },
                { id: 5, name: 'Tom Osei', phone: '+44 7700 900845', service: 'AI Concierge Setup', status: 'Nurture â€¢ waiting on partner approval', source: 'Google Ads', timeAgo: '58 min ago', lastMessage: 'Sent partner-friendly explainer PDF.' }
            ],
            serviceMix: [
                { name: 'Lead Follow-Up', percent: 35, notes: 'Speed-to-lead flows' },
                { name: 'Appointment Booking', percent: 45, notes: 'AI calendar concierge' },
                { name: 'Calendar Integration', percent: 20, notes: 'Multi-calendar sync' }
            ],
            recentCalls: [
                { id: 'demo-1', name: 'Sarah Patel', summary: 'Booked Tuesday 2:30pm via AI call', channel: 'Phone', timeAgo: '2 min ago' },
                { id: 'demo-2', name: 'Marcus Flynn', summary: 'Requested reschedule â€¢ SMS follow-up sent', channel: 'SMS â†’ Call', timeAgo: '9 min ago' },
                { id: 'demo-3', name: 'Laura Chen', summary: 'Synced with Google Calendar â€¢ reminder scheduled', channel: 'Webhook sync', timeAgo: '25 min ago' },
                { id: 'demo-4', name: 'Rick Alvarez', summary: 'Moved to Thursday â€¢ calendar updated', channel: 'Phone', timeAgo: '42 min ago' }
            ],
            appointments: [
                { id: 101, name: 'Isla Brown', service: 'AI Strategy Session', start: new Date(Date.now() + 60 * 60 * 1000).toISOString(), status: 'booked' },
                { id: 102, name: 'Liam Wright', service: 'Calendar Integration', start: new Date(Date.now() + 3 * 60 * 60 * 1000).toISOString(), status: 'booked' },
                { id: 103, name: 'Maya Reyes', service: 'Follow-up Call', start: new Date(Date.now() + 6 * 60 * 60 * 1000).toISOString(), status: 'pending' }
            ],
            roi: {
                costs: { total: 612.4, perCall: 12.4 },
                revenue: { total: 6280, bookings: 18, avgDealValue: 349 },
                roi: { profit: 5667.6, multiplier: 10.3, percentage: 930 }
            }
        };

        const DEMO_INTEGRATIONS = [
            { name: 'Vapi Voice', status: 'active', detail: 'Assistant + phone number connected' },
            { name: 'Twilio SMS', status: 'active', detail: 'Messaging service verified' },
            { name: 'Google Calendar', status: 'active', detail: 'Auto-booking in sync' },
            { name: 'Slack Digest', status: 'warning', detail: 'Add webhook to enable daily summary' }
        ];
        
        let currentClient = null;
        let dashboardData = { ...DEMO_DATA };
        let currentLeads = [];
        let liveEventSource = null;
        
        function getClientFromURL() {
            const params = new URLSearchParams(window.location.search);
            const clientParam = params.get('client');
            // If no client param or it's a demo variant, use DEMO_CLIENT_KEY
            if (!clientParam || clientParam.includes('demo') || clientParam.includes('booking')) {
                return DEMO_CLIENT_KEY;
            }
            // Keep dashes - database keys use dashes, not underscores
            return clientParam;
        }

        let lastDataUpdate = new Date();
        async function fetchLiveData(clientKey) {
            if (clientKey !== DEMO_CLIENT_KEY) {
                try {
                    // Add timeout to prevent hanging
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                    
                    const res = await fetch(`${BASE_URL}/api/demo-dashboard/${clientKey}`, {
                        signal: controller.signal
                    });
                    clearTimeout(timeoutId);
                    
                    if (res.ok) {
                        const payload = await res.json();
                        if (payload && payload.ok) {
                            lastDataUpdate = new Date();
                            return payload;
                        }
                        // Return null if API returns error
                        return null;
                    }
                } catch (err) {
                    if (err.name === 'AbortError') {
                        console.warn('Data fetch timeout - server may be slow');
                    } else {
                        console.warn('Live data unavailable', err.message);
                    }
                    // Don't throw - return null to allow dashboard to continue with existing data
                    return null;
                }
            } else {
                lastDataUpdate = new Date();
            }
            return null;
        }

        function mergeData(base = {}, livePayload, isDemoClient = false) {
            if (!livePayload) return base;
            
            // For real clients, use live payload data directly (don't merge with demo data)
            // Only merge if we're in demo mode and want to preserve imported leads
            const isDemoMode = isDemoClient || (base.totalLeads > 0 && base.recentLeads && base.recentLeads.length > 0 && base.recentLeads.some(l => l.status && l.status.includes('(demo)')));
            
            if (!isDemoMode) {
                // Real client - use API data directly from livePayload
                const metrics = livePayload.metrics || {};
                const recentCalls = livePayload.recentCalls || [];
                console.log('[DASHBOARD MERGE] Real client mode - recentCalls from API:', {
                    count: recentCalls.length,
                    calls: recentCalls,
                    livePayloadKeys: Object.keys(livePayload),
                    hasRecentCalls: !!livePayload.recentCalls,
                    recentCallsType: Array.isArray(recentCalls) ? 'array' : typeof recentCalls
                });
                return {
                    totalLeads: metrics.totalLeads || livePayload.totalLeads || 0,
                    totalCalls: metrics.totalCalls || livePayload.totalCalls || 0,
                    last24hLeads: metrics.last24hLeads || livePayload.last24hLeads || 0,
                    conversionRate: metrics.conversionRate || livePayload.conversionRate || 0,
                    successRate: metrics.successRate || livePayload.successRate || 0,
                    firstResponse: metrics.firstResponse || livePayload.firstResponse || 'â€”',
                    bookingsThisWeek: metrics.bookingsThisWeek || livePayload.bookingsThisWeek || 0,
                    avgLeadScore: metrics.avgLeadScore || livePayload.avgLeadScore || 0,
                    highPriorityLeads: metrics.highPriorityLeads || livePayload.highPriorityLeads || 0,
                    mediumPriorityLeads: metrics.mediumPriorityLeads || livePayload.mediumPriorityLeads || 0,
                    lowPriorityLeads: metrics.lowPriorityLeads || livePayload.lowPriorityLeads || 0,
                    recentLeads: livePayload.leads || [],
                    recentCalls: recentCalls,
                    appointments: livePayload.appointments || [],
                    serviceMix: livePayload.serviceMix || [],
                    touchpoints: livePayload.touchpoints || { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], data: [0, 0, 0, 0, 0, 0, 0] },
                    roi: livePayload.roi || { costs: { total: 0, perCall: 0 }, revenue: { total: 0, bookings: 0, avgDealValue: 0 }, roi: { profit: 0, multiplier: 0, percentage: 0 } }
                };
            }
            
            // Demo mode: merge with imported leads
            const metrics = livePayload.metrics || {};
            const baseLeads = Array.isArray(base.recentLeads) ? base.recentLeads : [];
            const importedLeads = baseLeads.filter(lead => lead.status && lead.status.includes('(demo)'));
            const existingLeads = baseLeads.filter(lead => !lead.status || !lead.status.includes('(demo)'));
            const newLeads = Array.isArray(livePayload.leads) && livePayload.leads.length ? livePayload.leads : [];
            
            // Merge: imported leads first, then new API leads, then existing non-imported leads
            // Remove duplicates by phone number
            const seenPhones = new Set();
            const mergedLeads = [];
            
            // Add imported leads first
            importedLeads.forEach(lead => {
                if (lead.phone && !seenPhones.has(lead.phone)) {
                    seenPhones.add(lead.phone);
                    mergedLeads.push(lead);
                }
            });
            
            // Add new API leads
            newLeads.forEach(lead => {
                if (lead.phone && !seenPhones.has(lead.phone)) {
                    seenPhones.add(lead.phone);
                    mergedLeads.push(lead);
                }
            });
            
            // Add existing non-imported leads (if not already added)
            existingLeads.forEach(lead => {
                if (lead.phone && !seenPhones.has(lead.phone)) {
                    seenPhones.add(lead.phone);
                    mergedLeads.push(lead);
                }
            });
            
            return {
                ...base,
                totalLeads: metrics.totalLeads ?? base.totalLeads,
                totalCalls: metrics.totalCalls ?? base.totalCalls,
                last24hLeads: metrics.last24hLeads ?? base.last24hLeads,
                conversionRate: metrics.conversionRate ?? base.conversionRate,
                successRate: metrics.successRate ?? base.successRate,
                firstResponse: metrics.firstResponse ?? base.firstResponse,
                bookingsThisWeek: metrics.bookingsThisWeek ?? base.bookingsThisWeek,
                avgLeadScore: metrics.avgLeadScore ?? base.avgLeadScore,
                highPriorityLeads: metrics.highPriorityLeads ?? base.highPriorityLeads,
                mediumPriorityLeads: metrics.mediumPriorityLeads ?? base.mediumPriorityLeads,
                lowPriorityLeads: metrics.lowPriorityLeads ?? base.lowPriorityLeads,
                recentLeads: mergedLeads.slice(0, 10), // Keep top 10
                serviceMix: Array.isArray(livePayload.serviceMix) && livePayload.serviceMix.length ? livePayload.serviceMix : base.serviceMix,
                recentCalls: Array.isArray(livePayload.recentCalls) && livePayload.recentCalls.length ? livePayload.recentCalls : base.recentCalls,
                touchpoints: livePayload.touchpoints && Array.isArray(livePayload.touchpoints.data)
                    ? livePayload.touchpoints
                    : base.touchpoints,
                appointments: Array.isArray(livePayload.appointments) && livePayload.appointments.length
                    ? livePayload.appointments
                    : base.appointments,
                roi: livePayload.roi ? livePayload.roi : base.roi
            };
        }

        function updateHeader(config, hasClientConfig = false) {
            console.log('[updateHeader] Called with:', {
                hasClientConfig,
                name: config.name || config.displayName,
                description: config.description,
                tagline: config.tagline,
                industry: config.industry,
                phone: config.phone,
                businessHours: config.businessHours
            });
            
            // Apply branding first (colors, logo) - always apply if available, regardless of hasClientConfig
            // This ensures colors and branding work even with partial data
            applyClientBranding(config);
            
            // Get industry-specific messaging
            // Only use industry if it's actually configured (not from CLIENT_CONFIG mock data)
            // But allow industry from whiteLabel even if hasClientConfig is false
            const industry = (hasClientConfig && config.industry) 
                ? config.industry 
                : (config.whiteLabel?.industry || config.industry || null);
            // Use 'dental' as fallback only for messaging/UI purposes, not for display
            const industryForMessaging = industry || 'dental';
            // Only use business name from actual client config
            const businessName = (hasClientConfig && (config.name || config.displayName || config.display_name)) 
                ? (config.name || config.displayName || config.display_name) 
                : 'Your Business';
            const services = config.services || config.serviceMap || [];
            const messaging = getIndustryMessaging(industryForMessaging, businessName, services);
            
            // Update header content (with null checks)
            // Only use values from actual client config, not CLIENT_CONFIG mock data
            const clientNameEl = document.getElementById('clientName');
            const clientDescEl = document.getElementById('clientDescription');
            const clientTaglineEl = document.getElementById('clientTagline');
            const clientStatusEl = document.getElementById('clientStatus');
            
            // Only set name if it's from actual client config
            if (clientNameEl) {
                if (hasClientConfig && (config.name || config.displayName || config.display_name)) {
                    clientNameEl.textContent = businessName;
                } else {
                    clientNameEl.textContent = 'Your Concierge Dashboard';
                }
            }
            if (clientDescEl) {
                if (hasClientConfig && config.description) {
                    clientDescEl.textContent = config.description;
                    clientDescEl.dataset.fromConfig = 'true'; // Mark as set from config
                } else {
                    clientDescEl.textContent = messaging.description;
                }
            }
            if (clientTaglineEl) {
                if (hasClientConfig && config.tagline) {
                    clientTaglineEl.textContent = config.tagline;
                } else {
                    clientTaglineEl.textContent = messaging.tagline;
                }
            }
            if (clientStatusEl) {
                if (hasClientConfig && config.status) {
                    clientStatusEl.textContent = config.status;
                } else {
                    clientStatusEl.textContent = 'Live';
                }
            }
            
            // Add industry-specific subtitle (only if industry is actually configured)
            const subtitleEl = document.getElementById('clientSubtitle');
            if (subtitleEl && industry && industry !== 'demo' && hasClientConfig) {
                const industryNames = {
                    dental: 'Dental Practice',
                    fitness: 'Fitness & Training',
                    beauty: 'Beauty Salon',
                    legal: 'Legal Practice',
                    medical: 'Medical Practice'
                };
                subtitleEl.textContent = industryNames[industry.toLowerCase()] || industry;
                subtitleEl.style.display = 'block';
            }
            
            // Store messaging for workflow rendering
            config.customWorkflow = messaging.workflow;
            
            // Personalize all dashboard text with business name
            personalizeDashboard(businessName);
            
            // Map client config fields to meta fields
            // Only show what's actually configured, use "Not supplied" for missing
            // Only use values if hasClientConfig is true (not from CLIENT_CONFIG mock data)
            // Also check whiteLabel as a fallback source
            const phone = (hasClientConfig && (config.phone || 
                         config.numbers?.primary || 
                         config.numbers_json?.primary ||
                         config.twilio_json?.fromNumber ||
                         config.sms?.fromNumber ||
                         config.whiteLabel?.phone)) || null;
            
            // Timezone: from timezone or booking.timezone
            const timezone = (hasClientConfig && (config.timezone || 
                           config.booking?.timezone ||
                           config.calendar_json?.booking?.timezone)) || null;
            
            // Business Hours: from businessHours or booking config
            const businessHours = (hasClientConfig && (config.businessHours ||
                                 config.booking?.businessHours ||
                                 config.calendar_json?.booking?.businessHours ||
                                 config.whiteLabel?.businessHours)) || null;
            
            // Industry display: from industry or services (for meta field)
            // Map industry codes to display names
            const industryMap = {
              'dental': 'Dental Practice',
              'dentist': 'Dental Practice',
              'fitness': 'Fitness & Training',
              'health & fitness': 'Personal Training Studio',
              'health and fitness': 'Personal Training Studio',
              'beauty': 'Beauty Salon',
              'salon': 'Beauty Salon',
              'legal': 'Legal Practice',
              'lawyer': 'Legal Practice',
              'medical': 'Medical Practice',
              'vet': 'Veterinary Practice',
              'accounting': 'Accounting Services',
              'real estate': 'Real Estate',
              'home': 'Home Services',
              'restaurant': 'Restaurant',
              'shipping': 'Shipping & Logistics',
              'logistics': 'Shipping & Logistics',
              'delivery': 'Delivery Services'
            };
            
            // Helper to capitalize words properly
            function capitalizeIndustry(industry) {
              if (!industry) return null;
              // If it's already in the map, use that
              const industryLower = industry.toLowerCase();
              if (industryMap[industryLower]) {
                return industryMap[industryLower];
              }
              // Otherwise capitalize each word
              return industry.split(/[\s&]+/).map(word => 
                word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
              ).join(' & ');
            }
            
            let industryDisplay = null;
            // Check industry from multiple sources
            const industryValue = config.industry || config.whiteLabel?.industry;
            if (hasClientConfig && industryValue) {
              const industryLower = industryValue.toLowerCase();
              industryDisplay = industryMap[industryLower] || capitalizeIndustry(industryValue);
            } else if (hasClientConfig && config.services && Array.isArray(config.services) && config.services.length > 0) {
              industryDisplay = config.services.join(', ');
            } else if (hasClientConfig && config.whiteLabel?.services && Array.isArray(config.whiteLabel.services) && config.whiteLabel.services.length > 0) {
              industryDisplay = config.whiteLabel.services.join(', ');
            } else if (hasClientConfig && config.services && typeof config.services === 'object' && Object.keys(config.services).length > 0) {
              industryDisplay = Object.keys(config.services).join(', ');
            }
            
            const metaPhone = document.getElementById('metaPhone');
            const metaTimezone = document.getElementById('metaTimezone');
            const metaHours = document.getElementById('metaHours');
            const metaIndustry = document.getElementById('metaIndustry');
            
            // Only show what's configured, show "Not supplied" for missing
            if (metaPhone) metaPhone.textContent = phone || 'Not supplied';
            if (metaTimezone) metaTimezone.textContent = timezone || 'Not supplied';
            if (metaHours) metaHours.textContent = businessHours || 'Not supplied';
            if (metaIndustry) metaIndustry.textContent = industryDisplay || 'Not supplied';

            const banner = document.getElementById('demoBanner');
            if (banner) {
                if (config.key === DEMO_CLIENT_KEY) {
                    banner.style.display = 'block';
                    banner.innerHTML = `<strong>Demo environment:</strong> ${escapeHtml(config.name || config.displayName || 'Demo')} shows exactly what your live dashboard will look like. When we onboard you we simply plug in your data.`;
                } else {
                    banner.style.display = 'none';
                }
            }
        }

        function personalizeDashboard(businessName) {
            // Update global clientBusinessName variable
            clientBusinessName = businessName;
            
            // Update status cards
            const statusCardLeads = document.getElementById('statusCardLeads');
            if (statusCardLeads) statusCardLeads.textContent = `Leads We're Managing for ${businessName}`;
            
            const statusCardCalls = document.getElementById('statusCardCalls');
            if (statusCardCalls) statusCardCalls.textContent = `Calls We've Made for ${businessName}`;
            
            const statusCardConversion = document.getElementById('statusCardConversion');
            if (statusCardConversion) statusCardConversion.textContent = `${businessName}'s Conversion Rate`;
            
            const statusCardResponse = document.getElementById('statusCardResponse');
            if (statusCardResponse) statusCardResponse.textContent = `${businessName}'s Response Time`;
            
            // Update ROI panel
            const roiRevenueLabel = document.getElementById('roiRevenueLabel');
            if (roiRevenueLabel) roiRevenueLabel.textContent = `Revenue We Generated for ${businessName}`;
            
            // Update active indicator
            const activeTitle = document.getElementById('activeTitle');
            if (activeTitle) activeTitle.textContent = `${businessName}'s concierge is active`;
            
            const activeSubtitle = document.getElementById('activeSubtitle');
            if (activeSubtitle) activeSubtitle.textContent = `Working on ${businessName}'s leads right now`;
            
            // Update card subtitles
            const callQualitySubtitle = document.getElementById('callQualitySubtitle');
            if (callQualitySubtitle) callQualitySubtitle.textContent = `How effective our calls are for ${businessName}.`;
            
            const recentLeadsSubtitle = document.getElementById('recentLeadsSubtitle');
            if (recentLeadsSubtitle) recentLeadsSubtitle.textContent = `Leads we're actively following up on for ${businessName}.`;
            
            const appointmentsSubtitle = document.getElementById('appointmentsSubtitle');
            if (appointmentsSubtitle) appointmentsSubtitle.textContent = `Appointments we booked for ${businessName}.`;
            
            const activityFeedSubtitle = document.getElementById('activityFeedSubtitle');
            if (activityFeedSubtitle) activityFeedSubtitle.textContent = `Real-time conversations ${businessName}'s concierge is having with leads.`;
            
            // Update more card subtitles
            const conversionFunnelSubtitle = document.getElementById('conversionFunnelSubtitle');
            if (conversionFunnelSubtitle) conversionFunnelSubtitle.textContent = `How we convert ${businessName}'s leads into bookings.`;
            
            const weeklyActivitySubtitle = document.getElementById('weeklyActivitySubtitle');
            if (weeklyActivitySubtitle) weeklyActivitySubtitle.textContent = `Calls and bookings we made for ${businessName} this week.`;
            
            const todaysActivitySubtitle = document.getElementById('todaysActivitySubtitle');
            if (todaysActivitySubtitle) todaysActivitySubtitle.textContent = `What we accomplished for ${businessName} in the last 24 hours.`;
            
            const retryQueueSubtitle = document.getElementById('retryQueueSubtitle');
            if (retryQueueSubtitle) retryQueueSubtitle.textContent = `Leads we're retrying for ${businessName} after initial contact.`;
            
            const callRecordingsSubtitle = document.getElementById('callRecordingsSubtitle');
            if (callRecordingsSubtitle) callRecordingsSubtitle.textContent = `Listen to recent calls we made for ${businessName}.`;
            
            // Update description - but only if it hasn't been set from client config
            // (Don't overwrite the actual description from the API)
            const clientDescription = document.getElementById('clientDescription');
            if (clientDescription && !clientDescription.dataset.fromConfig) {
                clientDescription.textContent = `See what we're doing for ${businessName} - calls, follow-ups, and bookings`;
            }
        }
        
        function updateFreshnessIndicator() {
            const freshnessEl = document.getElementById('freshnessText');
            if (!freshnessEl) return;
            
            if (lastDataUpdate) {
                const secondsAgo = Math.floor((Date.now() - lastDataUpdate.getTime()) / 1000);
                if (secondsAgo < 60) {
                    freshnessEl.textContent = `Updated ${secondsAgo}s ago`;
                } else if (secondsAgo < 3600) {
                    const minutes = Math.floor(secondsAgo / 60);
                    freshnessEl.textContent = `Updated ${minutes}m ago`;
                } else {
                    const hours = Math.floor(secondsAgo / 3600);
                    freshnessEl.textContent = `Updated ${hours}h ago`;
                }
            } else {
                freshnessEl.textContent = 'Data syncing...';
            }
        }
        
        function formatNumber(value) {
            if (value === undefined || value === null) return 'â€”';
            return Number(value).toLocaleString('en-GB');
        }

        function formatPercent(value) {
            if (value === undefined || value === null) return 'â€”';
            const numeric = Number(value);
            return Number.isFinite(numeric) ? `${numeric}%` : `${value}`;
        }

        function formatCurrency(value) {
            const numeric = Number(value);
            if (!Number.isFinite(numeric)) return 'Â£0';
            return new Intl.NumberFormat('en-GB', {
                style: 'currency',
                currency: 'GBP',
                maximumFractionDigits: 0
            }).format(numeric);
        }

        function formatTimeAgo(dateString) {
            if (!dateString) return 'just now';
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffSecs = Math.floor(diffMs / 1000);
                const diffMins = Math.floor(diffSecs / 60);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);

                if (diffSecs < 60) return 'just now';
                if (diffMins < 60) return `${diffMins} min${diffMins === 1 ? '' : 's'} ago`;
                if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
                if (diffDays < 7) return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
                return date.toLocaleDateString();
            } catch (e) {
                return 'recently';
            }
        }

        function updateStatusBar(data) {
            const totalLeads = formatNumber(data.totalLeads);
            const totalCalls = formatNumber(data.totalCalls);
            const conversion = formatPercent(data.conversionRate);
            const firstResponse = data.firstResponse || 'â€”';

            document.getElementById('statusTotalLeads').textContent = totalLeads;
            // Show calls with answered/not answered breakdown
            const callsAnswered = data.metrics?.callsAnswered ?? 0;
            const callsNotAnswered = data.metrics?.callsNotAnswered ?? 0;
            const answerRate = data.metrics?.answerRate ?? 0;
            
            document.getElementById('statusTotalCalls').textContent = totalCalls;
            // Update hint to show answered vs not answered
            const callsHint = callsAnswered > 0 || callsNotAnswered > 0
                ? `${callsAnswered} answered, ${callsNotAnswered} not answered (${answerRate}% answer rate)`
                : `${totalCalls} leads called`;
            document.getElementById('statusHintCalls').textContent = callsHint;
            
            document.getElementById('statusConversionRate').textContent = conversion;
            document.getElementById('statusFirstResponse').textContent = firstResponse;

            const last24 = formatNumber(data.last24hLeads ?? 0);
            const bookings = formatNumber(data.bookingsThisWeek ?? 0);
            const winRate = formatPercent(data.successRate ?? 0);

            document.getElementById('statusHintLeads').textContent = `Last 24h: ${last24} new`;
            // statusHintCalls already set above with answered/not answered breakdown
            document.getElementById('statusHintConversion').textContent = `Win rate: ${winRate}`;
            document.getElementById('statusHintResponse').textContent = firstResponse === 'â€”'
                ? 'Goal: under 5 min'
                : `Current: ${firstResponse}`;
        }

        function renderRecentActivity(data) {
            const container = document.getElementById('recent-activity');
            if (!container) return;
            container.innerHTML = `
                <div class="activity-metric">
                    <div class="activity-metric-label">New Leads</div>
                    <div class="activity-metric-value">${formatNumber(data.last24hLeads || 0)}</div>
                    </div>
                <div class="activity-metric">
                    <div class="activity-metric-label">Calls Made</div>
                    <div class="activity-metric-value">${formatNumber(data.totalCalls || 0)}</div>
                    </div>
                <div class="activity-metric">
                    <div class="activity-metric-label">Bookings</div>
                    <div class="activity-metric-value">${formatNumber(data.bookingsThisWeek || 0)}</div>
                    </div>
                <div class="activity-metric">
                    <div class="activity-metric-label">Response Time</div>
                    <div class="activity-metric-value" style="font-size: 1.3rem;">${data.firstResponse || 'â€”'}</div>
                    </div>
            `;
        }

        function renderROI(roi = {}) {
            document.getElementById('roiSpend').textContent = formatCurrency(roi.costs?.total);
            document.getElementById('roiRevenue').textContent = formatCurrency(roi.revenue?.total);
            document.getElementById('roiBookings').textContent = `${formatNumber(roi.revenue?.bookings ?? 0)} bookings`;
            document.getElementById('roiMultiplier').textContent = `${(roi.roi?.multiplier ?? 0).toFixed(1)}x`;
            document.getElementById('roiProfit').textContent = `${formatCurrency(roi.roi?.profit ?? 0)} profit`;
        }


        function renderLeads(leads = []) {
            const container = document.getElementById('leads-list');
            if (!container) return;
            // Use current clientBusinessName (updated by personalizeDashboard)
            const businessName = clientBusinessName || 'Your Business';
            if (!leads.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-state-icon">ðŸ‘¥</span>
                        <div class="empty-state-title">No leads yet</div>
                        <div class="empty-state-message">Leads ${businessName} receives will appear here as we start following up.</div>
                    </div>
                `;
                currentLeads = [];
                return;
            }
            dashboardData.recentLeads = leads;
            currentLeads = leads.slice(0, 5);
            container.innerHTML = currentLeads.map((lead, index) => {
                const leadId = escapeHtml(String(lead.id || lead.phone || index));
                const leadName = escapeHtml(lead.name || 'Prospect');
                return `
                <div class="lead-item" data-lead-index="${index}" role="button" tabindex="0">
                    <div class="lead-name">${escapeHtml(lead.name || 'Prospect')}</div>
                    <div class="lead-meta">
                        <span>${escapeHtml(lead.phone || lead.email || '')}</span>
                        <span>${escapeHtml(lead.service || 'General')}</span>
                    </div>
                    <div class="lead-status">${escapeHtml(lead.status || 'In follow-up')}</div>
                    <button class="timeline-btn" onclick="event.stopPropagation(); viewLeadTimeline('${leadId}', '${leadName}')">ðŸ“Š View Timeline</button>
                </div>
            `;
            }).join('');
            attachLeadModalEvents();
        }


        function renderAppointments(appointments = []) {
            const container = document.getElementById('upcoming-appointments');
            if (!container) return;
            // Use current clientBusinessName (updated by personalizeDashboard)
            const businessName = clientBusinessName || 'Your Business';
            if (!Array.isArray(appointments) || !appointments.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-state-icon">ðŸ“…</span>
                        <div class="empty-state-title">No upcoming appointments</div>
                        <div class="empty-state-message">Appointments we book for ${businessName} will appear here automatically.</div>
                        <div class="empty-state-cta">
                            <button class="empty-state-btn" onclick="document.getElementById('leadImportButton')?.click()" aria-label="Upload leads to get started">
                                ðŸ“¤ Send ${businessName} Leads to Book
                            </button>
                    </div>
                    </div>
                `;
                return;
            }
            container.innerHTML = appointments.map(appt => `
                <div class="appt-item">
                    <div>
                        <div class="appt-name">${escapeHtml(appt.name || 'Prospect')}</div>
                        <div class="appt-service">${escapeHtml(appt.service || 'Consultation')}</div>
                    </div>
                    <div class="appt-time">${formatAppointmentTime(appt.start)}</div>
                </div>
            `).join('');
        }

        function renderChart(config, data) {
            const fallbackLabels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            const chartSource = data?.touchpoints && Array.isArray(data.touchpoints.data) && data.touchpoints.data.length
                ? data.touchpoints
                : { labels: fallbackLabels, data: config.chart || fallbackLabels.map(() => 0) };
            const totals = chartSource.data;
            const labels = chartSource.labels?.length === totals.length ? chartSource.labels : fallbackLabels;
            const max = Math.max(...totals, 1);
            const bars = totals.map((value, idx) => `
                <div class="chart-bar" style="height:${(value / max) * 100}%;" data-label="${labels[idx] || ''}"></div>
            `).join('');
            document.getElementById('chartBars').innerHTML = bars;
            const totalCalls = totals.reduce((sum,v)=>sum+v,0);
            // Use current clientBusinessName (updated by personalizeDashboard)
            const businessName = clientBusinessName || 'Your Business';
            document.getElementById('chartSummary').textContent = `${totalCalls} call${totalCalls !== 1 ? 's' : ''} we made for ${businessName} this week`;
        }

        function formatAppointmentTime(isoDate) {
            if (!isoDate) return 'â€”';
            const date = new Date(isoDate);
            if (Number.isNaN(date.getTime())) return 'â€”';
            return date.toLocaleString('en-GB', {
                weekday: 'short',
                day: 'numeric',
                month: 'short',
                hour: 'numeric',
                minute: '2-digit'
            });
        }


        async function renderSystemStatus(config) {
            const statusPhoneEl = document.getElementById('statusPhone');
            const statusCoverageEl = document.getElementById('statusCoverage');
            if (statusPhoneEl) statusPhoneEl.textContent = config.phone || 'Not supplied';
            if (statusCoverageEl) statusCoverageEl.textContent = config.businessHours || 'Not supplied';
            
            // Update SMS/Calendar status from integration health
            if (currentClient !== DEMO_CLIENT_KEY) {
                try {
                    const response = await fetch(`${BASE_URL}/api/integration-health/${currentClient}`);
                    if (response.ok) {
                        const payload = await response.json();
                        if (payload?.ok && Array.isArray(payload.integrations)) {
                            const twilio = payload.integrations.find(i => i.name === 'Twilio SMS');
                            const calendar = payload.integrations.find(i => i.name === 'Google Calendar');
                            
                            if (document.getElementById('statusSMS')) {
                                document.getElementById('statusSMS').textContent = twilio?.status === 'active' ? 'âœ“ Active' : 'âš  Not connected';
                                document.getElementById('statusSMS').className = twilio?.status === 'active' ? 'metric-value success' : 'metric-value warning';
                            }
                            
                            if (document.getElementById('statusCalendar')) {
                                document.getElementById('statusCalendar').textContent = calendar?.status === 'active' ? 'âœ“ Connected' : 'âš  Not connected';
                                document.getElementById('statusCalendar').className = calendar?.status === 'active' ? 'metric-value success' : 'metric-value warning';
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Failed to load integration status', error);
                    // Don't break dashboard - just show unknown status
                    if (document.getElementById('statusSMS')) {
                        document.getElementById('statusSMS').textContent = 'âš  Unknown';
                    }
                    if (document.getElementById('statusCalendar')) {
                        document.getElementById('statusCalendar').textContent = 'âš  Unknown';
                    }
                }
            } else {
                // Demo client - show active status
                document.getElementById('statusSMS').textContent = 'âœ“ Active';
                document.getElementById('statusSMS').className = 'metric-value success';
                document.getElementById('statusCalendar').textContent = 'âœ“ Connected';
                document.getElementById('statusCalendar').className = 'metric-value success';
            }
        }

        function renderIntegrationStatus(list = []) {
            const container = document.getElementById('integration-health');
            if (!container) return;
            if (!Array.isArray(list) || !list.length) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <span class="empty-state-icon">ðŸ”Œ</span>
                        <div class="empty-state-title">No integrations</div>
                        <div class="empty-state-message">Connect channels to monitor health.</div>
                    </div>
                `;
                return;
            }
            container.innerHTML = list.map(item => `
                <div class="integration-item">
                    <div class="integration-item-header">
                        <div class="integration-label">
                            <span class="integration-dot" style="background:${item.status === 'active' ? '#1b5e20' : item.status === 'warning' ? '#f5a623' : '#c62828'};"></span>
                            ${item.name}
                        </div>
                        <div class="integration-status ${item.status || 'inactive'}">${item.status || 'unknown'}</div>
                    </div>
                    ${item.detail && item.status !== 'active' ? `<div class="integration-detail">${item.detail}</div>` : ''}
                </div>
            `).join('');
        }

        function renderCalls(calls = []) {
            const container = document.getElementById('recent-calls');
            if (!container) {
                console.warn('recent-calls container not found');
                return;
            }
            
            console.log('[RENDER CALLS] Input:', {
                callsType: typeof calls,
                isArray: Array.isArray(calls),
                length: Array.isArray(calls) ? calls.length : 'not array',
                calls: calls
            });
            
            // Only use demo calls for demo client
            let callsToShow = calls && Array.isArray(calls) && calls.length > 0 ? calls : [];
            
            // Fallback to demo calls ONLY if it's the demo client
            if (callsToShow.length === 0 && currentClient === DEMO_CLIENT_KEY) {
                callsToShow = [
                    { id: 'demo-1', name: 'Sarah Patel', summary: 'Booked Tuesday 2:30pm via AI call', channel: 'Phone', timeAgo: '2 min ago' },
                    { id: 'demo-2', name: 'Marcus Flynn', summary: 'Requested reschedule â€¢ SMS follow-up sent', channel: 'SMS â†’ Call', timeAgo: '9 min ago' },
                    { id: 'demo-3', name: 'Laura Chen', summary: 'Synced with Google Calendar â€¢ reminder scheduled', channel: 'Webhook sync', timeAgo: '25 min ago' },
                    { id: 'demo-4', name: 'Rick Alvarez', summary: 'Moved to Thursday â€¢ calendar updated', channel: 'Phone', timeAgo: '42 min ago' }
                ];
            }
            
            if (!callsToShow || !callsToShow.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="empty-state-icon">ðŸ“ž</span>
                        <div class="empty-state-title">No calls yet</div>
                        <div class="empty-state-message">Your concierge will start calling leads as soon as you send them to us.</div>
                        <div class="empty-state-cta">
                            <button class="empty-state-btn" onclick="document.getElementById('leadImportButton')?.click()" aria-label="Upload leads">
                                ðŸ“¤ Upload Leads to Get Started
                            </button>
                    </div>
                    </div>
                `;
                return;
            }
            container.innerHTML = callsToShow.map((call, index) => {
                const timeAgo = call.timeAgo || formatTimeAgo(call.timestamp || call.created_at);
                const callId = escapeHtml(String(call.id || call.timestamp || index));
                const callName = escapeHtml(call.name || 'Prospect');
                const statusLabel = (call.status || '').toString().replace(/_/g, ' ') || 'completed';
                let outcomeLabel = '';
                if (call.summary && call.summary.startsWith('Outcome:')) {
                    outcomeLabel = call.summary.replace('Outcome:', '').trim();
                }
                const outcomeKey = outcomeLabel.toLowerCase().replace(/\s+/g, '-');
                const hasOutcome = !!outcomeLabel;
                const outcomeLower = outcomeLabel.toLowerCase();
                const wasPickedUp = hasOutcome && !/(no[- ]?answer|busy|failed|voicemail|declined|rejected)/.test(outcomeLower);
                return `
                    <div class="activity-item">
                        <strong>${escapeHtml(call.name || 'Prospect')}</strong> â€¢ ${escapeHtml(call.channel || 'AI call')}
                        <div class="activity-meta">${escapeHtml(call.summary || 'Conversation logged')} â€¢ ${timeAgo}</div>
                        <div class="activity-tags">
                            <span class="activity-pill status-in-progress">${escapeHtml(statusLabel)}</span>
                            ${hasOutcome ? `<span class="activity-pill outcome-${escapeHtml(outcomeKey)}">${escapeHtml(outcomeLabel)}</span>` : ''}
                            ${hasOutcome ? `<span class="activity-pill ${wasPickedUp ? 'pickup-yes' : 'pickup-no'}">${wasPickedUp ? 'Picked up' : 'No answer'}</span>` : ''}
                        </div>
                        <button class="transcript-btn" onclick="viewTranscript('${callId}', '${callName}')">ðŸ“„ View Transcript</button>
                    </div>
                `;
            }).join('');
        }

        function renderWorkflow(steps = []) {
            const container = document.getElementById('workflow');
            if (!container) return;
            if (!Array.isArray(steps) || steps.length === 0) {
                container.innerHTML = '<li style="color: var(--muted);">Workflow information not available</li>';
                return;
            }
            container.innerHTML = steps.map(step => `
                <li class="workflow-step">
                    <div class="workflow-icon">${escapeHtml(step.icon || 'ðŸ“‹')}</div>
                    <div>
                        <strong>${escapeHtml(step.title || 'Step')}</strong>
                        <p style="color: var(--muted); margin-top:4px;">${escapeHtml(step.desc || step.description || '')}</p>
                    </div>
                </li>
            `).join('');
        }

        function renderLeadJourney(data) {
            const container = document.getElementById('lead-journey');
            if (!container) return;
            const totalLeads = data.totalLeads || 0;
            const contacted = data.totalCalls || 0; // Unique leads we've attempted to call
            // Engaged = leads that actually answered the call (had a conversation)
            // Use callsAnswered from metrics, or fallback to contacted minus not answered
            const callsAnswered = data.metrics?.callsAnswered || 0;
            const engaged = callsAnswered > 0 ? callsAnswered : (data.engagedLeads || 0);
            const booked = data.bookingsThisWeek || 0;

            const stages = [
                { label: 'Leads', value: totalLeads, color: '#5c6ac4' },
                { label: 'Contacted', value: contacted, color: '#764ba2' },
                { label: 'Engaged', value: engaged, color: '#667eea' },
                { label: 'Booked', value: booked, color: '#1b5e20' }
            ];

            const maxValue = Math.max(...stages.map(s => s.value), 1);
            container.innerHTML = stages.map(stage => {
                const percent = maxValue > 0 ? Math.round((stage.value / maxValue) * 100) : 0;
                const stagePercent = totalLeads > 0 ? Math.round((stage.value / totalLeads) * 100) : 0;
                return `
                    <div class="funnel-stage">
                        <div class="funnel-label">
                            <span>${stage.label}</span>
                            <span>${formatNumber(stage.value)} <span class="funnel-percent">(${stagePercent}%)</span></span>
                    </div>
                        <div class="funnel-bar">
                            <div class="funnel-fill" style="width:${percent}%; background:linear-gradient(90deg, ${stage.color}, ${stage.color}dd);"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }



        function showToast(title, message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;

            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        async function viewTranscript(callId, name) {
            const modal = document.getElementById('transcriptModal');
            const titleEl = document.getElementById('transcriptModalTitle');
            const contentEl = document.getElementById('transcriptContent');
            if (!modal || !titleEl || !contentEl) return;

            titleEl.textContent = `Call Transcript: ${name}`;
            contentEl.textContent = 'Loading transcript...';
            modal.classList.add('open');

            // Always show demo transcripts in demo mode
            const isDemo = !currentClient || currentClient === DEMO_CLIENT_KEY || currentClient === 'demo_client' || 
                          (typeof currentClient === 'string' && (currentClient.includes('demo') || currentClient.includes('booking')));
            
            if (isDemo) {
                // Show realistic demo transcripts based on call ID
                const demoTranscripts = {
                    'demo-1': `AI: Hi Sarah, this is your AI booking concierge. I'm calling to follow up on your inquiry about our AI Strategy Session.

Sarah: Oh yes, I was interested in learning more about how this could help my business.

AI: Great! I'd be happy to help. Based on your inquiry, it sounds like you're looking to streamline your lead follow-up process. Is that correct?

Sarah: Exactly. We're getting leads but struggling to follow up quickly enough.

AI: Perfect! Our AI concierge can handle that for you. We can call your leads within minutes of them coming in, 24/7. Would you like to schedule a strategy session to see how this would work for your business?

Sarah: Yes, that would be great. When are you available?

AI: I have availability next Tuesday at 2:30pm or Thursday at 10am. Which works better for you?

Sarah: Tuesday at 2:30pm sounds perfect.

AI: Excellent! I've booked you for Tuesday, November 19th at 2:30pm. You'll receive a calendar invite and confirmation email shortly. Is there anything else I can help you with today?

Sarah: No, that's perfect. Thank you so much!

AI: You're very welcome, Sarah! We'll see you on Tuesday. Have a wonderful day!

[Call ended - Duration: 3m 42s | Outcome: Booked]`,
                    'demo-2': `AI: Hi Marcus, this is your AI booking concierge. I'm calling about your appointment scheduled for tomorrow.

Marcus: Oh hi, actually I need to reschedule if possible.

AI: Of course! I'd be happy to help you reschedule. What day and time would work better for you?

Marcus: Could we do Thursday afternoon instead? Maybe around 3pm?

AI: Let me check... Yes, I have Thursday at 3pm available. Would you like me to move your appointment to Thursday at 3pm?

Marcus: Yes, that would be perfect.

AI: Done! I've rescheduled your appointment to Thursday, November 21st at 3pm. You'll receive an updated calendar invite. Is there anything else I can help with?

Marcus: No, that's all. Thanks!

AI: You're welcome! We'll see you Thursday. Have a great day!

[Call ended - Duration: 1m 15s | Outcome: Rescheduled | SMS follow-up sent]`,
                    'demo-3': `AI: Hi Laura, this is your AI booking concierge. I'm calling to confirm your appointment details and send you a reminder.

Laura: Hi, yes I'm all set for tomorrow.

AI: Perfect! Your appointment is scheduled for tomorrow, Wednesday at 10am. I've just synced this with your Google Calendar and sent you a reminder. You should see it appear in your calendar shortly.

Laura: Great, I can see it now. Thank you for the reminder!

AI: You're very welcome! We'll see you tomorrow at 10am. If anything comes up, just let us know. Have a great day!

[Call ended - Duration: 1m 8s | Outcome: Confirmed | Calendar synced]`,
                    'demo-4': `AI: Hi Rick, this is your AI booking concierge. I'm calling about your appointment scheduled for this week.

Rick: Hi, I actually need to move it to next week if possible.

AI: Absolutely! What day next week works best for you?

Rick: How about Thursday?

AI: I have Thursday at 2pm or 4pm available. Which would you prefer?

Rick: 2pm works great.

AI: Perfect! I've moved your appointment to Thursday, November 28th at 2pm. Your calendar has been updated. You'll receive a confirmation shortly.

Rick: Excellent, thank you!

AI: You're welcome! We'll see you next Thursday. Have a great week!

[Call ended - Duration: 1m 32s | Outcome: Rescheduled | Calendar updated]`
                };

                const transcript = demoTranscripts[callId] || demoTranscripts['demo-1'];
                setTimeout(() => {
                    contentEl.innerHTML = `<pre style="white-space: pre-wrap; font-family: 'Inter', sans-serif; line-height: 1.6; color: var(--text); margin: 0;">${transcript}</pre>`;
                }, 300);
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/calls/${callId}/transcript?clientKey=${currentClient}`);
                const payload = await response.json();
                if (response.ok && payload?.ok && payload.transcript) {
                    contentEl.textContent = payload.transcript;
                } else {
                    contentEl.textContent = 'Transcript not available for this call.';
                }
            } catch (error) {
                console.error('Failed to load transcript', error);
                contentEl.innerHTML = `
                    <div class="error-message" role="alert">
                        <span class="error-message-icon">âš ï¸</span>
                        <div>
                            <strong>Unable to load transcript</strong>
                            <div style="font-size: 0.9rem; margin-top: 4px;">${error.message || 'Please try again later.'}</div>
                            <button class="empty-state-btn" style="margin-top: 8px; font-size: 0.85rem; padding: 6px 12px;" onclick="viewTranscript('${callId}', '${name}')">Retry</button>
                        </div>
                    </div>
                `;
            }
        }

        function closeTranscriptModal() {
            const modal = document.getElementById('transcriptModal');
            if (modal) modal.classList.remove('open');
        }

        async function renderActiveIndicator(data) {
            const titleEl = document.getElementById('activeTitle');
            const subtitleEl = document.getElementById('activeSubtitle');
            if (!titleEl || !subtitleEl) return;

            if (currentClient === DEMO_CLIENT_KEY) {
                const activeCalls = Math.floor((data.totalCalls || 0) * 0.1) || 0;
                const activeFollowups = Math.floor((data.totalLeads || 0) * 0.3) || 0;
                
                if (activeCalls > 0 || activeFollowups > 0) {
                    titleEl.textContent = `Your concierge is active`;
                    subtitleEl.textContent = `Currently calling ${activeCalls} lead${activeCalls !== 1 ? 's' : ''}, following up with ${activeFollowups}`;
                } else {
                    titleEl.textContent = `Your concierge is monitoring`;
                    subtitleEl.textContent = `Ready to handle leads as they come in`;
                }
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}/api/active-indicator/${currentClient}`);
                const payload = await response.json();
                if (response.ok && payload?.ok) {
                    titleEl.textContent = payload.title;
                    subtitleEl.textContent = payload.subtitle;
                }
            } catch (error) {
                console.error('Failed to load active indicator', error);
                // Gracefully degrade - don't show error for this non-critical feature
            }
        }

        async function renderCallQuality(data) {
            const container = document.getElementById('call-quality');
            if (!container) return;

            if (currentClient === DEMO_CLIENT_KEY) {
                const totalCalls = data.totalCalls || 0;
                const bookings = data.bookingsThisWeek || 0;
                const answered = data.callsAnswered || 0;
                const notAnswered = data.callsNotAnswered || 0;
                const avgDuration = Math.floor((totalCalls * 2.5) + Math.random() * 1.5);
                const successRate = totalCalls > 0 ? Math.round((bookings / totalCalls) * 100) : 0;
                const bestHour = '2-4pm';
                    
                    container.innerHTML = `
                    <div class="quality-metric">
                        <div class="quality-label">Avg Duration</div>
                        <div class="quality-value">${avgDuration}m</div>
                        <div class="quality-badge">per call</div>
                            </div>
                    <div class="quality-metric">
                        <div class="quality-label">Success Rate</div>
                        <div class="quality-value">${successRate}%</div>
                        <div class="quality-badge">bookings</div>
                            </div>
                    <div class="quality-metric">
                        <div class="quality-label">Call Outcomes</div>
                        <div class="quality-value">${answered}/${totalCalls}</div>
                        <div class="quality-badge">answered calls</div>
                            </div>
                    <div class="quality-metric">
                        <div class="quality-label">Best Time</div>
                        <div class="quality-value">${bestHour}</div>
                        <div class="quality-badge">to call</div>
                            </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/call-quality/${currentClient}`);
                const payload = await response.json();
                if (response.ok && payload?.ok) {
                    container.innerHTML = `
                        <div class="quality-metric">
                            <div class="quality-label">Avg Duration</div>
                            <div class="quality-value">${payload.avgDuration || 0}m</div>
                            <div class="quality-badge">per call</div>
                            </div>
                        <div class="quality-metric">
                            <div class="quality-label">Success Rate</div>
                            <div class="quality-value">${payload.successRate || 0}%</div>
                            <div class="quality-badge">bookings</div>
                        </div>
                        <div class="quality-metric">
                            <div class="quality-label">Calls (7 days)</div>
                            <div class="quality-value">${payload.totalCalls || 0}</div>
                            <div class="quality-badge">total calls</div>
                        </div>
                        <div class="quality-metric">
                            <div class="quality-label">Best Time</div>
                            <div class="quality-value">${payload.bestTime || 'â€”'}</div>
                            <div class="quality-badge">to call</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load call quality', error);
                showError(container, 'Unable to load call quality metrics. Please refresh the page.', () => location.reload());
            }
        }

        async function renderRetryQueue(data) {
            const container = document.getElementById('retry-queue');
            if (!container) return;

            if (currentClient === DEMO_CLIENT_KEY) {
                const totalCalls = data.totalCalls || 0;
                const failedCalls = Math.floor(totalCalls * 0.15);
                
                if (failedCalls === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <span class="empty-state-icon">âœ…</span>
                            <div class="empty-state-title">All caught up!</div>
                            <div class="empty-state-message">No retries needed - all calls successful!</div>
                            </div>
                    `;
                    return;
                }

                const retryLeads = currentLeads.slice(0, Math.min(failedCalls, 3)).map((lead, idx) => ({
                    name: lead.name || 'Prospect',
                    phone: lead.phone,
                    attempts: 2 + idx,
                    nextRetry: idx === 0 ? 'Today, 2pm' : idx === 1 ? 'Today, 4pm' : 'Tomorrow, 10am'
                }));

                container.innerHTML = retryLeads.map(lead => `
                    <div class="retry-item">
                        <div>
                            <div class="retry-name">${lead.name}</div>
                            <div class="retry-meta">Attempt ${lead.attempts} â€¢ ${lead.phone || ''}</div>
                            </div>
                        <div class="retry-status">Retrying ${lead.nextRetry}</div>
                        </div>
                `).join('');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/retry-queue/${currentClient}`);
                const payload = await response.json();
                if (response.ok && payload?.ok) {
                    if (!payload.retries || payload.retries.length === 0) {
                    container.innerHTML = `
                            <div class="empty-state" style="padding: 20px;">
                                <span class="empty-state-icon">âœ…</span>
                                <div class="empty-state-title">All caught up!</div>
                                <div class="empty-state-message">No retries needed - all calls successful!</div>
                        </div>
                    `;
                        return;
                    }
                    container.innerHTML = payload.retries.map(lead => `
                        <div class="retry-item">
                            <div>
                                <div class="retry-name">${lead.name}</div>
                                <div class="retry-meta">Attempt ${lead.attempts}/${lead.maxAttempts} â€¢ ${lead.phone || ''}</div>
                    </div>
                            <div class="retry-status">Retrying ${lead.nextRetry}</div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Failed to load retry queue', error);
                showError(container, 'Unable to load retry queue. Please refresh the page.', () => location.reload());
            }
        }

        async function viewLeadTimeline(leadId, name) {
            const modal = document.getElementById('timelineModal');
            const titleEl = document.getElementById('timelineModalTitle');
            const contentEl = document.getElementById('timelineContent');
            if (!modal || !titleEl || !contentEl) return;

            titleEl.textContent = `Journey: ${name}`;
            contentEl.innerHTML = 'Loading timeline...';
            modal.classList.add('open');

            // ALWAYS show demo timeline - no conditions, no API calls
            const now = new Date();
            const timeline = [
                { event: 'Lead received', time: new Date(now - 2 * 60 * 60 * 1000), icon: 'ðŸ“¥', detail: 'Added via CSV import' },
                { event: 'AI call initiated', time: new Date(now - 100 * 60 * 1000), icon: 'ðŸ“ž', detail: 'Called within 5 minutes' },
                { event: 'SMS follow-up sent', time: new Date(now - 90 * 60 * 1000), icon: 'ðŸ’¬', detail: 'Scheduled for tomorrow' },
                { event: 'Engagement detected', time: new Date(now - 60 * 60 * 1000), icon: 'âœ¨', detail: 'Showed interest in consultation' },
                { event: 'Appointment booked', time: new Date(now - 30 * 60 * 1000), icon: 'ðŸ“…', detail: 'Booked for next Tuesday, 2pm' }
            ];

            contentEl.innerHTML = timeline.map(item => `
                <div class="timeline-item">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <div class="timeline-title">${item.icon} ${item.event}</div>
                        <div class="timeline-meta">${item.detail} â€¢ ${formatTimeAgo(item.time.toISOString())}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function closeTimelineModal() {
            const modal = document.getElementById('timelineModal');
            if (modal) modal.classList.remove('open');
        }


        async function renderCallRecordings(calls = []) {
            const container = document.getElementById('call-recordings');
            if (!container) return;

            if (currentClient === DEMO_CLIENT_KEY) {
                if (!calls.length) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <span class="empty-state-icon">ðŸŽ™ï¸</span>
                            <div class="empty-state-title">No recordings yet</div>
                            <div class="empty-state-message">Call recordings will appear here after calls are made.</div>
                            </div>
                    `;
                    return;
                }

                container.innerHTML = calls.slice(0, 3).map((call, index) => `
                    <div class="recording-item">
                        <div class="recording-controls">
                            <button class="play-btn" onclick="playRecording('${call.id || index}', '${call.name || 'Prospect'}')" title="Play recording">â–¶</button>
                            </div>
                        <div class="recording-info">
                            <div class="recording-name">${call.name || 'Prospect'}</div>
                            <div class="recording-meta">${call.summary || 'Call completed'} â€¢ ${call.timeAgo || formatTimeAgo(call.created_at || '')} â€¢ ${Math.floor(Math.random() * 3 + 2)} min</div>
                                </div>
                            </div>
                `).join('');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/call-recordings/${currentClient}`);
                const payload = await response.json();
                if (response.ok && payload?.ok) {
                    if (!payload.recordings || payload.recordings.length === 0) {
                        container.innerHTML = `
                            <div class="empty-state" style="padding: 20px;">
                                <span class="empty-state-icon">ðŸŽ™ï¸</span>
                                <div class="empty-state-title">No recordings yet</div>
                                <div class="empty-state-message">Call recordings will appear here after calls are made.</div>
                                </div>
                        `;
                        return;
                    }
                    container.innerHTML = payload.recordings.map(recording => {
                        const durationMin = Math.floor((recording.duration || 0) / 60);
                        const durationSec = (recording.duration || 0) % 60;
                        return `
                            <div class="recording-item">
                                <div class="recording-controls">
                                    <button class="play-btn" onclick="playRecording('${recording.id}', '${recording.name}', '${recording.recordingUrl || ''}')" title="Play recording">â–¶</button>
                            </div>
                                <div class="recording-info">
                                    <div class="recording-name">${recording.name}</div>
                                    <div class="recording-meta">${recording.outcome || 'Call completed'} â€¢ ${recording.timeAgo || 'Recently'} â€¢ ${durationMin}:${String(durationSec).padStart(2, '0')}</div>
                        </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Failed to load call recordings', error);
            }
        }

        function playRecording(callId, name, recordingUrl) {
            if (currentClient === DEMO_CLIENT_KEY) {
                showToast('Recording Playback', `Demo recording for ${name} would play here`, 'info');
                return;
            }
            
            if (recordingUrl) {
                window.open(recordingUrl, '_blank');
                showToast('Playing Recording', `Opening recording for ${name}...`, 'info');
            } else {
                showToast('Recording Unavailable', `Recording URL not found for ${name}`, 'warning');
            }
        }

        async function renderCalendarDetails(data) {
            const container = document.getElementById('calendar-details');
            if (!container) return;

            if (currentClient === DEMO_CLIENT_KEY) {
                const lastSync = new Date(Date.now() - 5 * 60 * 1000);
                const conflictsResolved = Math.floor((data.bookingsThisWeek || 0) * 0.1);
                const appointmentsBooked = data.bookingsThisWeek || 0;

                container.innerHTML = `
                    <div class="calendar-detail-item">
                        <span class="calendar-detail-label">Last sync</span>
                        <span class="calendar-detail-value success">${formatTimeAgo(lastSync.toISOString())}</span>
                                </div>
                    <div class="calendar-detail-item">
                        <span class="calendar-detail-label">Conflicts resolved</span>
                        <span class="calendar-detail-value">${conflictsResolved} this week</span>
                                </div>
                    <div class="calendar-detail-item">
                        <span class="calendar-detail-label">Appointments booked</span>
                        <span class="calendar-detail-value success">${appointmentsBooked} this week</span>
                                </div>
                    <div class="calendar-detail-item">
                        <span class="calendar-detail-label">Calendar status</span>
                        <span class="calendar-detail-value success">âœ“ Synced and active</span>
                                </div>
                `;
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/calendar-sync/${currentClient}`);
                const payload = await response.json();
                if (response.ok && payload?.ok) {
                    const lastSyncTime = formatTimeAgo(payload.lastSync);
                    container.innerHTML = `
                        <div class="calendar-detail-item">
                            <span class="calendar-detail-label">Last sync</span>
                            <span class="calendar-detail-value ${payload.connected ? 'success' : 'warning'}">${lastSyncTime}</span>
                                    </div>
                        <div class="calendar-detail-item">
                            <span class="calendar-detail-label">Conflicts resolved</span>
                            <span class="calendar-detail-value">${payload.conflictsResolved || 0} this week</span>
                            </div>
                        <div class="calendar-detail-item">
                            <span class="calendar-detail-label">Appointments booked</span>
                            <span class="calendar-detail-value success">${payload.appointmentsBooked || 0} this week</span>
                        </div>
                        <div class="calendar-detail-item">
                            <span class="calendar-detail-label">Calendar status</span>
                            <span class="calendar-detail-value ${payload.connected ? 'success' : 'warning'}">${payload.connected ? 'âœ“ Synced and active' : 'âš  Not connected'}</span>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load calendar details', error);
                // Show error state when API fails
                container.innerHTML = `
                    <div class="calendar-detail-item">
                        <span class="calendar-detail-label">Last sync</span>
                        <span class="calendar-detail-value warning">â€”</span>
                    </div>
                    <div class="calendar-detail-item">
                        <span class="calendar-detail-label">Conflicts resolved</span>
                        <span class="calendar-detail-value">0 this week</span>
                    </div>
                    <div class="calendar-detail-item">
                        <span class="calendar-detail-label">Appointments booked</span>
                        <span class="calendar-detail-value">0 this week</span>
                    </div>
                    <div class="calendar-detail-item">
                        <span class="calendar-detail-label">Calendar status</span>
                        <span class="calendar-detail-value warning">âš  Not connected</span>
                    </div>
                `;
            }
        }
        
        async function exportData(type) {
            if (currentClient === DEMO_CLIENT_KEY) {
                showToast('Export Ready', `Demo data export for ${type} would download here.`, 'info');
                return;
            }

            try {
                showToast('Exporting', `Preparing ${type} export...`, 'info');
                const response = await fetch(`${BASE_URL}/api/export/${type}?clientKey=${currentClient}`);
                if (!response.ok) throw new Error('Export failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${type}-export-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showToast('Export Complete', `Downloaded ${type} data.`, 'success');
            } catch (error) {
                console.error('Export failed', error);
                const errorMsg = error.message || 'Unable to export data. Please check your connection and try again.';
                showToast('Export Failed', errorMsg, 'error');
            }
        }

        function attachLeadModalEvents() {
            document.querySelectorAll('.lead-item').forEach(item => {
                item.addEventListener('click', () => openLeadModal(item.dataset.leadIndex));
                item.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        openLeadModal(item.dataset.leadIndex);
                    }
                });
            });
        }

        function openLeadModal(index) {
            const lead = currentLeads[Number(index)];
            if (!lead) return;
            const modal = document.getElementById('leadModal');
            if (!modal) return;
            document.getElementById('modalLeadName').textContent = lead.name || lead.phone || 'Lead';
            document.getElementById('modalLeadService').textContent = lead.service || 'General';
            document.getElementById('modalLeadSource').textContent = lead.source || 'Unknown';
            document.getElementById('modalLeadStatus').textContent = lead.status || 'In follow-up';
            document.getElementById('modalLeadNotes').textContent = lead.lastMessage || lead.notes || 'No notes yet.';
            modal.dataset.currentIndex = index;
            modal.classList.add('open');
        }

        function closeLeadModal() {
            const modal = document.getElementById('leadModal');
            if (!modal) return;
            modal.classList.remove('open');
            modal.dataset.currentIndex = '';
        }

        function startLiveEvents(clientKey) {
            if (!window.EventSource || clientKey === DEMO_CLIENT_KEY) {
                stopLiveEvents();
                return;
            }
            if (liveEventSource) liveEventSource.close();
            liveEventSource = new EventSource(`${BASE_URL}/api/events/${clientKey}`);
            liveEventSource.onmessage = (event) => {
                if (!event.data) return;
                try {
                    const payload = JSON.parse(event.data);
                    handleLiveEvent(payload);
                } catch (err) {
                    console.warn('Failed to parse event payload', err);
                }
            };
            liveEventSource.onerror = () => {
                stopLiveEvents();
                setTimeout(() => startLiveEvents(clientKey), 10000);
            };
        }

        function stopLiveEvents() {
            if (liveEventSource) {
                liveEventSource.close();
                liveEventSource = null;
            }
        }

        function handleLiveEvent(call) {
            if (!call) return;
            call.timeAgo = formatTimeAgo(call.timestamp || call.created_at);
            dashboardData.recentCalls = [call, ...(dashboardData.recentCalls || [])].slice(0, 5);
            renderCalls(dashboardData.recentCalls);
            showToast('New Call Logged', `${call.name || 'Prospect'}: ${call.summary || 'Call completed'}`, 'info');
        }

        async function initDashboard() {
            currentClient = getClientFromURL();
            
            // Fetch client config from API if not demo
            let clientConfig = null;
            if (currentClient !== DEMO_CLIENT_KEY) {
                try {
                    console.log('[DASHBOARD] Fetching client config from:', `${BASE_URL}/api/clients/${currentClient}`);
                    const response = await fetch(`${BASE_URL}/api/clients/${currentClient}`);
                    console.log('[DASHBOARD] Response status:', response.status, response.ok);
                    
                    if (response.ok) {
                const data = await response.json();
                        console.log('[DASHBOARD] API response data:', data);
                        
                        if (data.ok && data.client) {
                            clientConfig = data.client;
                            console.log('[DASHBOARD] Loaded client config:', {
                                name: clientConfig.name || clientConfig.displayName,
                                description: clientConfig.description,
                                tagline: clientConfig.tagline,
                                industry: clientConfig.industry,
                                hasWhiteLabel: !!clientConfig.whiteLabel,
                                hasBranding: !!clientConfig.whiteLabel?.branding,
                                primaryColor: clientConfig.whiteLabel?.branding?.primaryColor || clientConfig.primaryColor,
                                secondaryColor: clientConfig.whiteLabel?.branding?.secondaryColor || clientConfig.secondaryColor,
                                accentColor: clientConfig.whiteLabel?.branding?.accentColor || clientConfig.accentColor,
                                hasClientConfig: true
                            });
                        } else {
                            console.warn('[DASHBOARD] API response missing client data:', {
                                hasOk: !!data.ok,
                                hasClient: !!data.client,
                                data: data
                            });
                        }
                    } else {
                        const errorText = await response.text();
                        console.error('[DASHBOARD] API error response:', response.status, errorText);
                    }
                } catch (err) {
                    console.error('[DASHBOARD] Could not fetch client config:', err);
                }
            }
            
            // Use clientConfig if available, otherwise use CLIENT_CONFIG but only for non-meta fields
            // Meta fields (phone, timezone, businessHours, industry) should only come from actual client config
            const config = clientConfig || CLIENT_CONFIG[currentClient] || CLIENT_CONFIG[DEMO_CLIENT_KEY] || {};
            config.key = currentClient;
            
            // Debug: Log what we have
            console.log('[initDashboard] Config after merge:', {
                hasClientConfig: !!clientConfig,
                hasWhiteLabel: !!config.whiteLabel,
                hasBranding: !!config.whiteLabel?.branding,
                primaryColor: config.primaryColor || config.whiteLabel?.branding?.primaryColor,
                displayName: config.displayName || config.name,
                industry: config.industry
            });
            
            // If we're using CLIENT_CONFIG fallback, clear ALL mock data fields
            // Only use fields from actual clientConfig (from API/file)
            // BUT preserve branding/color fields - they should always be applied if available
            if (!clientConfig) {
                // Don't use CLIENT_CONFIG defaults - they're all mock data
                delete config.phone;
                delete config.numbers;
                delete config.numbers_json;
                delete config.businessHours;
                delete config.timezone;
                delete config.industry;
                delete config.name;
                delete config.displayName;
                // Keep only essential non-meta fields for UI functionality
                // BUT preserve branding fields (colors, logo, whiteLabel) - these should be applied regardless
                // Note: CLIENT_CONFIG doesn't have branding, so this is fine
            } else {
                // When clientConfig exists, ensure whiteLabel is preserved
                if (clientConfig.whiteLabel && !config.whiteLabel) {
                    config.whiteLabel = clientConfig.whiteLabel;
                }
                // Also ensure top-level color fields are preserved
                if (clientConfig.primaryColor && !config.primaryColor) {
                    config.primaryColor = clientConfig.primaryColor;
                }
                if (clientConfig.secondaryColor && !config.secondaryColor) {
                    config.secondaryColor = clientConfig.secondaryColor;
                }
                if (clientConfig.accentColor && !config.accentColor) {
                    config.accentColor = clientConfig.accentColor;
                }
            }
            
            // Update header with business name if available
            // REMOVED: This was overwriting updateHeader. Let updateHeader handle all header updates.
            // updateHeader will call applyClientBranding, so we don't need to call it separately
            // But ensure branding is applied even if updateHeader doesn't do it
            updateHeader(config, !!clientConfig);
            
            // Always apply branding if available (as a fallback, in case updateHeader didn't)
            // This ensures colors and branding work even with partial data
            if (config.whiteLabel || config.primaryColor || config.secondaryColor || config.accentColor) {
                // Small delay to ensure DOM is ready
                setTimeout(() => {
                    applyClientBranding(config);
                }, 100);
            }
            initThemeToggle();
            // Init test call button - it will fetch config if needed
            initTestCallButton(currentClient, config).catch(err => console.warn('Test call button init error:', err));
            initModalControls();
            initImporter();
            initAccessibility();
            initKeyboardShortcuts();
            initOfflineDetection();
            initDataFreshness();

            // Initialize with empty data structure for real clients, demo data only for demo client
            if (currentClient === DEMO_CLIENT_KEY) {
                dashboardData = { ...DEMO_DATA };
                document.getElementById('demoBanner').style.display = 'block';
                stopLiveEvents();
            } else {
                // For real clients, start with empty structure - will be populated from API
                dashboardData = {
                    totalLeads: 0,
                    totalCalls: 0,
                    last24hLeads: 0,
                    conversionRate: 0,
                    successRate: 0,
                    firstResponse: 'â€”',
                    bookingsThisWeek: 0,
                    avgLeadScore: 0,
                    highPriorityLeads: 0,
                    mediumPriorityLeads: 0,
                    lowPriorityLeads: 0,
                    recentLeads: [],
                    recentCalls: [],
                    appointments: [],
                    serviceMix: [],
                    touchpoints: { labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'], data: [0, 0, 0, 0, 0, 0, 0] },
                    roi: { costs: { total: 0, perCall: 0 }, revenue: { total: 0, bookings: 0, avgDealValue: 0 }, roi: { profit: 0, multiplier: 0, percentage: 0 } }
                };
                const banner = document.getElementById('demoBanner');
                if (banner) banner.style.display = 'none';
            }

            // Show loading skeletons
            const loadingContainers = ['leads-list', 'upcoming-appointments', 'recent-calls', 'recent-activity'];
            loadingContainers.forEach(id => {
                const container = document.getElementById(id);
                if (container) showSkeleton(container, id === 'recent-activity' ? 'metrics' : 'list');
            });

            // Always try to fetch real data from API
            try {
                const livePayload = await fetchLiveData(currentClient);
                if (livePayload) {
                    // Use real data from API, don't merge with demo data
                    dashboardData = mergeData({}, livePayload, currentClient === DEMO_CLIENT_KEY);
                } else if (currentClient === DEMO_CLIENT_KEY) {
                    // Only use demo data if it's the demo client and no API data
                    dashboardData = { ...DEMO_DATA };
                }
                // If no livePayload and not demo client, dashboardData stays as empty structure
            } catch (error) {
                console.error('Failed to load dashboard data', error);
                // Only show error for real clients, demo client can use demo data
                if (currentClient !== DEMO_CLIENT_KEY) {
                    const leadsContainer = document.getElementById('leads-list');
                    if (leadsContainer) {
                        showError(leadsContainer, 'Unable to load dashboard data. Please refresh the page.', () => location.reload());
                    }
                }
            }

            // Render critical data first (non-blocking)
            updateStatusBar(dashboardData);
            renderRecentActivity(dashboardData);
            const roiData = dashboardData.roi || { costs: { total: 0, perCall: 0 }, revenue: { total: 0, bookings: 0, avgDealValue: 0 }, roi: { profit: 0, multiplier: 0, percentage: 0 } };
            renderROI(roiData);
            renderLeadJourney(dashboardData);
            renderLeads(dashboardData.recentLeads || []);
            renderAppointments(dashboardData.appointments || []);
            renderChart(config, dashboardData);
            const callsToRender = dashboardData.recentCalls || [];
            renderCalls(callsToRender);
            renderWorkflow(config.customWorkflow || config.workflow || CLIENT_CONFIG.demo_client.workflow);
            
            // Load async data in parallel (non-blocking)
            Promise.all([
                renderActiveIndicator(dashboardData).catch(err => console.warn('Active indicator failed', err)),
                renderSystemStatus(config).catch(err => console.warn('System status failed', err)),
                renderCallQuality(dashboardData).catch(err => console.warn('Call quality failed', err)),
                renderRetryQueue(dashboardData).catch(err => console.warn('Retry queue failed', err)),
                renderCalendarDetails(dashboardData).catch(err => console.warn('Calendar details failed', err)),
                renderCallRecordings(callsToRender).catch(err => console.warn('Call recordings failed', err))
            ]).then(() => {
                console.log('All async data loaded');
            });
            
            // Load integration health (non-blocking)
            loadIntegrationHealth(currentClient);

            startLiveEvents(currentClient);

            // Add fade-in animation to cards
            setTimeout(() => {
                document.querySelectorAll('.card').forEach((card, index) => {
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.classList.add('fade-in');
                });
            }, 100);

            setInterval(async () => {
                try {
                    const refreshPayload = await fetchLiveData(currentClient);
                    // Update freshness timestamp even in demo mode
                    lastDataUpdate = new Date();
                    if (refreshPayload) {
                        dashboardData = mergeData(dashboardData, refreshPayload);
                        updateStatusBar(dashboardData);
                        renderRecentActivity(dashboardData);
                        const roiData = dashboardData.roi || { costs: { total: 0, perCall: 0 }, revenue: { total: 0, bookings: 0, avgDealValue: 0 }, roi: { profit: 0, multiplier: 0, percentage: 0 } };
                        renderROI(roiData);
                        await renderActiveIndicator(dashboardData);
                        renderLeadJourney(dashboardData);
                        renderLeads(dashboardData.recentLeads || []);
                        renderAppointments(dashboardData.appointments || []);
                        const callsToRender = dashboardData.recentCalls || [];
                        renderCalls(callsToRender);
                        await renderCallRecordings(callsToRender);
                        await renderCallQuality(dashboardData);
                        await renderRetryQueue(dashboardData);
                        await renderCalendarDetails(dashboardData);
                        renderChart(config, dashboardData);
                    }
                } catch (error) {
                    console.error('Failed to refresh dashboard data', error);
                    // Silent fail for background refresh - don't interrupt user
                }
            }, 30000);
        }

        // Accessibility improvements
        function initAccessibility() {
            // Add ARIA labels to interactive elements
            document.querySelectorAll('button').forEach(btn => {
                if (!btn.getAttribute('aria-label') && !btn.textContent.trim()) {
                    btn.setAttribute('aria-label', btn.title || 'Button');
                }
            });

            // Add ARIA labels to cards
            document.querySelectorAll('.card').forEach(card => {
                const title = card.querySelector('h3');
                if (title && !card.getAttribute('aria-label')) {
                    card.setAttribute('aria-label', title.textContent);
                }
            });

            // Improve keyboard navigation
            document.querySelectorAll('.lead-item, .appt-item, .activity-item').forEach(item => {
                if (!item.getAttribute('tabindex')) {
                    item.setAttribute('tabindex', '0');
                }
                item.setAttribute('role', 'button');
            });
        }

        // Keyboard shortcuts
        function initKeyboardShortcuts() {
            const hint = document.getElementById('keyboardHint');
            let hintTimeout;

            document.addEventListener('keydown', (e) => {
                // Show hint on first keypress
                if (hint && !hint.classList.contains('show')) {
                    hint.classList.add('show');
                    clearTimeout(hintTimeout);
                    hintTimeout = setTimeout(() => hint.classList.remove('show'), 3000);
                }

                // ? - Show keyboard shortcuts
                if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    showKeyboardShortcuts();
                }

                // Escape - Close modals
                if (e.key === 'Escape') {
                    closeLeadModal();
                    closeTranscriptModal();
                    closeTimelineModal();
                }

                // u - Upload leads (when not in input)
                if (e.key === 'u' && !e.ctrlKey && !e.metaKey && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    document.getElementById('leadImportButton')?.click();
                }

                // t - Toggle theme
                if (e.key === 't' && !e.ctrlKey && !e.metaKey && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    document.getElementById('themeToggle')?.click();
                }
            });
        }

        function showKeyboardShortcuts() {
            const shortcuts = [
                { key: '?', desc: 'Show keyboard shortcuts' },
                { key: 'Esc', desc: 'Close modals' },
                { key: 'u', desc: 'Upload leads' },
                { key: 't', desc: 'Toggle theme' }
            ];

            const modal = document.createElement('div');
            modal.className = 'modal-backdrop open';
            modal.setAttribute('role', 'dialog');
            modal.setAttribute('aria-label', 'Keyboard shortcuts');
            modal.innerHTML = `
                <div class="lead-modal">
                    <div class="modal-header">
                        <h4>âŒ¨ï¸ Keyboard Shortcuts</h4>
                        <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()" aria-label="Close">&times;</button>
                            </div>
                    <div class="modal-body">
                        ${shortcuts.map(s => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(92,106,196,0.1);">
                                <span><kbd style="background: rgba(92,106,196,0.1); padding: 4px 8px; border-radius: 4px; font-weight: 600;">${s.key}</kbd></span>
                                <span style="color: var(--muted);">${s.desc}</span>
                            </div>
                        `).join('')}
                        </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Offline detection
        function initOfflineDetection() {
            const freshnessDot = document.getElementById('freshnessDot');
            const freshnessText = document.getElementById('freshnessText');

            function updateOnlineStatus() {
                if (navigator.onLine) {
                    freshnessDot?.classList.remove('offline');
                    if (freshnessText) freshnessText.textContent = 'Online';
                } else {
                    freshnessDot?.classList.add('offline');
                    if (freshnessText) freshnessText.textContent = 'Offline';
                    showToast('Connection Lost', 'You are currently offline. Data will sync when connection is restored.', 'warning');
                }
            }

            window.addEventListener('online', () => {
                updateOnlineStatus();
                showToast('Connection Restored', 'You are back online. Syncing data...', 'success');
                // Refresh data
                setTimeout(async () => {
                    try {
                        const refreshPayload = await fetchLiveData(currentClient);
                        if (refreshPayload) {
                            dashboardData = mergeData(dashboardData, refreshPayload);
                            updateStatusBar(dashboardData);
                            renderRecentActivity(dashboardData);
                            renderLeads(dashboardData.recentLeads || []);
                            renderAppointments(dashboardData.appointments || []);
                }
            } catch (error) {
                        console.error('Failed to refresh after coming online', error);
                    }
                }, 1000);
            });

            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();
        }

        // Data freshness indicator
        function initDataFreshness() {
            const freshnessText = document.getElementById('freshnessText');
            if (!freshnessText) return;

            function updateFreshness() {
                const now = new Date();
                const diffMs = now - lastDataUpdate;
                const diffMins = Math.floor(diffMs / 60000);
                const diffSecs = Math.floor((diffMs % 60000) / 1000);

                if (diffMins < 1) {
                    freshnessText.textContent = `Updated ${diffSecs}s ago`;
                } else if (diffMins < 60) {
                    freshnessText.textContent = `Updated ${diffMins}m ago`;
                } else {
                    const diffHours = Math.floor(diffMins / 60);
                    freshnessText.textContent = `Updated ${diffHours}h ago`;
                }
            }

            // Update freshness every second
            setInterval(updateFreshness, 1000);
            updateFreshness();
        }

        // Better error handling
        function showError(container, message, retryFn = null) {
            if (!container) return;
            const errorId = `error-${Date.now()}`;
            const errorHtml = `
                <div class="error-message" role="alert" id="${errorId}">
                    <span class="error-message-icon">âš ï¸</span>
                    <div style="flex: 1;">
                        <strong>Error loading data</strong>
                        <div style="font-size: 0.9rem; margin-top: 4px;">${message}</div>
                        ${retryFn ? `<button class="empty-state-btn" style="margin-top: 8px; font-size: 0.85rem; padding: 6px 12px;" id="retry-${errorId}">Retry</button>` : ''}
                    </div>
                    </div>
                `;
            container.innerHTML = errorHtml;
            if (retryFn) {
                const retryBtn = document.getElementById(`retry-${errorId}`);
                if (retryBtn) {
                    retryBtn.addEventListener('click', retryFn);
                }
            }
        }

        // Loading skeleton
        function showSkeleton(container, type = 'list') {
            if (!container) return;
            if (type === 'list') {
                container.innerHTML = `
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-text" style="width: 60%;"></div>
                        <div class="skeleton skeleton-text" style="width: 80%;"></div>
                        <div class="skeleton skeleton-text" style="width: 70%;"></div>
                    </div>
                `;
            } else if (type === 'metrics') {
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div class="skeleton skeleton-text" style="height: 60px;"></div>
                        <div class="skeleton skeleton-text" style="height: 60px;"></div>
                        <div class="skeleton skeleton-text" style="height: 60px;"></div>
                        <div class="skeleton skeleton-text" style="height: 60px;"></div>
                    </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', initDashboard);
        window.addEventListener('beforeunload', stopLiveEvents);

        async function initTestCallButton(clientKey, config) {
            const testCallBtn = document.getElementById('testCallBtn');
            if (!testCallBtn) {
                console.warn('[TEST CALL] Button element not found');
                return;
            }

            // Try to get full client config if not already loaded
            let fullConfig = config;
            if (clientKey && clientKey !== DEMO_CLIENT_KEY && (!config?.vapi?.assistantId && !config?.assistantId)) {
                try {
                    const response = await fetch(`${BASE_URL}/api/clients/${clientKey}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.ok && data.client) {
                            fullConfig = data.client;
                        }
                    }
                } catch (err) {
                    console.warn('[TEST CALL] Could not fetch client config:', err);
                }
            }

            // Show button for demo clients or clients with isDemo flag
            // Also check if client has a VAPI assistant ID (likely a demo)
            const hasAssistantId = fullConfig?.vapi?.assistantId || fullConfig?.assistantId;
            const isDemo = clientKey === DEMO_CLIENT_KEY || 
                         clientKey === 'demo_client' ||
                         clientKey === 'demo-client' ||
                         clientKey?.includes('demo') || 
                         clientKey?.includes('booking') ||
                         fullConfig?.isDemo === true ||
                         (typeof clientKey === 'string' && (clientKey.includes('demo') || clientKey.includes('booking')));

            console.log('[TEST CALL] Client check:', {
                clientKey,
                isDemo,
                hasAssistantId,
                configIsDemo: fullConfig?.isDemo,
                vapiAssistantId: fullConfig?.vapi?.assistantId,
                assistantId: fullConfig?.assistantId
            });

            // Show button if it's a demo client OR if it has an assistant ID (for testing)
            // Also show if clientKey exists (not the default demo_client) - means it's a real demo client
            const shouldShow = isDemo || hasAssistantId || (clientKey && clientKey !== DEMO_CLIENT_KEY);
            
            if (shouldShow) {
                testCallBtn.style.display = 'block';
                console.log('[TEST CALL] Button shown for client:', clientKey);
                
                // Store the final config for the click handler
                const finalAssistantId = fullConfig?.vapi?.assistantId || fullConfig?.assistantId;
                
                testCallBtn.addEventListener('click', async () => {
                    if (testCallBtn.disabled) return;
                    
                    testCallBtn.disabled = true;
                    testCallBtn.textContent = 'ðŸ“ž Calling...';
                    
                    try {
                        const response = await fetch(`${BASE_URL}/api/demo/test-call`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                clientKey: clientKey,
                                assistantId: finalAssistantId
                            })
                        });

                        const data = await response.json();
                        
                        if (data.success) {
                            showToast('Test Call Initiated', `Calling ${data.phoneNumber || 'your phone'}... Answer to test the assistant!`, 'success');
                            testCallBtn.textContent = 'âœ… Call Sent';
                            setTimeout(() => {
                                testCallBtn.textContent = 'ðŸ“ž Test Call';
                                testCallBtn.disabled = false;
                            }, 5000);
                        } else {
                            throw new Error(data.error || 'Failed to initiate call');
                        }
                    } catch (error) {
                        console.error('Test call error:', error);
                        showToast('Test Call Failed', error.message || 'Could not initiate call. Check console for details.', 'error');
                        testCallBtn.textContent = 'ðŸ“ž Test Call';
                        testCallBtn.disabled = false;
                    }
                });
            } else {
                testCallBtn.style.display = 'none';
            }
        }

        function initThemeToggle() {
            const toggle = document.getElementById('themeToggle');
            if (!toggle) return;
            const saved = localStorage.getItem(THEME_KEY) || 'light';
            applyTheme(saved);
            toggle.textContent = saved === 'dark' ? 'Light mode' : 'Dark mode';
            toggle.addEventListener('click', () => {
                const nextMode = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
                applyTheme(nextMode);
                toggle.textContent = nextMode === 'dark' ? 'Light mode' : 'Dark mode';
                localStorage.setItem(THEME_KEY, nextMode);
            });
        }

        function applyTheme(mode) {
            if (mode === 'dark') {
                document.body.dataset.theme = 'dark';
            } else {
                document.body.dataset.theme = '';
            }
        }

        async function handleLeadAction(action) {
            const modal = document.getElementById('leadModal');
            if (!modal) return;
            const index = modal.dataset.currentIndex;
            if (index === undefined || index === '') return;
            const lead = currentLeads[Number(index)];
            if (!lead) return;

            if (currentClient === DEMO_CLIENT_KEY || !lead.id) {
                applyLocalLeadAction(lead, action);
                dashboardData.recentLeads = dashboardData.recentLeads?.map((item, idx) =>
                    idx === Number(index) ? lead : item
                ) || currentLeads;
                renderLeads(dashboardData.recentLeads || currentLeads);
                closeLeadModal();
                showToast('Lead Updated', `Lead ${action === 'snooze' ? 'snoozed' : 'escalated'} successfully`, 'success');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/api/leads/${lead.id}/${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clientKey: currentClient })
                });
                const payload = await response.json();
                if (!response.ok || !payload?.ok) {
                    throw new Error(payload?.error || 'Action failed');
                }
                if (payload.lead) {
                    dashboardData.recentLeads = (dashboardData.recentLeads || []).map(item =>
                        item.id === lead.id ? { ...item, ...payload.lead } : item
                    );
                    renderLeads(dashboardData.recentLeads);
                }
                closeLeadModal();
                showToast('Lead Updated', `Lead ${action === 'snooze' ? 'snoozed' : 'escalated'} successfully`, 'success');
            } catch (error) {
                console.error('Lead action failed', error);
                showToast('Action Failed', error.message || 'Unable to update lead', 'error');
                alert(`Unable to ${action} lead. ${error.message || ''}`);
            }
        }

        function applyLocalLeadAction(lead, action) {
            if (action === 'snooze') {
                lead.status = 'Snoozed (demo)';
                lead.lastMessage = 'Lead snoozed for 1 day (demo).';
            } else {
                lead.status = 'Priority (demo)';
                lead.lastMessage = 'Escalated to operator (demo).';
            }
        }

        function initModalControls() {
            const backdrop = document.getElementById('leadModal');
            const closeBtn = document.getElementById('modalCloseBtn');
            if (closeBtn) closeBtn.addEventListener('click', closeLeadModal);
            if (backdrop) {
                backdrop.addEventListener('click', (event) => {
                    if (event.target === backdrop) closeLeadModal();
                });
            }
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeLeadModal();
                    closeTranscriptModal();
                    closeTimelineModal();
                }
            });
            const snoozeBtn = document.getElementById('modalSnoozeBtn');
            if (snoozeBtn) snoozeBtn.addEventListener('click', () => handleLeadAction('snooze'));
            const escalateBtn = document.getElementById('modalEscalateBtn');
            if (escalateBtn) escalateBtn.addEventListener('click', () => handleLeadAction('escalate'));

            const transcriptBackdrop = document.getElementById('transcriptModal');
            const transcriptCloseBtn = document.getElementById('transcriptCloseBtn');
            if (transcriptCloseBtn) transcriptCloseBtn.addEventListener('click', closeTranscriptModal);
            if (transcriptBackdrop) {
                transcriptBackdrop.addEventListener('click', (event) => {
                    if (event.target === transcriptBackdrop) closeTranscriptModal();
                });
            }

            const timelineBackdrop = document.getElementById('timelineModal');
            const timelineCloseBtn = document.getElementById('timelineCloseBtn');
            if (timelineCloseBtn) timelineCloseBtn.addEventListener('click', closeTimelineModal);
            if (timelineBackdrop) {
                timelineBackdrop.addEventListener('click', (event) => {
                    if (event.target === timelineBackdrop) closeTimelineModal();
                });
            }
        }

        function initImporter() {
            const input = document.getElementById('leadImportInput');
            const button = document.getElementById('leadImportButton');
            const dropzone = document.getElementById('leadDropzone');
            const pasteToggle = document.getElementById('leadPasteToggle');
            const pasteContainer = document.getElementById('leadPasteContainer');
            const pasteSubmit = document.getElementById('leadPasteSubmit');
            const pasteInput = document.getElementById('leadPasteInput');
            if (button && input) button.addEventListener('click', () => input.click());
            if (input) {
                input.addEventListener('change', (event) => {
                    const file = event.target.files?.[0];
                    if (file) handleLeadImportFile(file);
                    event.target.value = '';
                });
            }
            if (dropzone) {
                ['dragenter', 'dragover'].forEach(evt =>
                    dropzone.addEventListener(evt, e => {
                        e.preventDefault();
                        dropzone.classList.add('dragover');
                    })
                );
                ['dragleave', 'drop'].forEach(evt =>
                    dropzone.addEventListener(evt, e => {
                        e.preventDefault();
                        dropzone.classList.remove('dragover');
                    })
                );
                dropzone.addEventListener('drop', e => {
                    const file = e.dataTransfer.files?.[0];
                    if (file) handleLeadImportFile(file);
                });
            }
            if (pasteToggle && pasteContainer) {
                pasteToggle.addEventListener('click', () => {
                    const isVisible = pasteContainer.style.display === 'block';
                    pasteContainer.style.display = isVisible ? 'none' : 'block';
                    if (!isVisible && pasteInput) {
                        pasteInput.focus();
                    }
                });
            }
            if (pasteSubmit && pasteInput) {
                pasteSubmit.addEventListener('click', () => {
                    handleLeadPaste(pasteInput.value || '');
                });
            }
            if (pasteInput) {
                pasteInput.addEventListener('keydown', (event) => {
                    if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
                        event.preventDefault();
                        handleLeadPaste(pasteInput.value || '');
                    }
                });
            }
        }

        function handleLeadImportFile(file) {
            setImportStatus(`Processing ${file.name}...`);
            const reader = new FileReader();
            reader.onload = () => {
                const leads = parseCsv(reader.result);
                submitLeadImport(leads);
            };
            reader.onerror = () => setImportStatus('Unable to read file', 'error');
            reader.readAsText(file);
        }

        function handleLeadPaste(rawText) {
            const text = (rawText || '').trim();
            if (!text) {
                setImportStatus('Nothing to import â€“ please paste some numbers first.', 'error');
                return;
            }

            const lines = text.split(/\r?\n/).map(line => line.trim()).filter(Boolean);
            if (!lines.length) {
                setImportStatus('Nothing to import â€“ please paste some numbers first.', 'error');
                return;
            }

            const leads = [];

            for (const line of lines) {
                if (!line) continue;

                const parts = line.split(',').map(p => p.trim()).filter(Boolean);

                let name = '';
                let phone = '';
                let service = '';
                let source = '';

                if (parts.length === 1) {
                    // Single value: treat as phone
                    phone = parts[0];
                } else if (parts.length === 2) {
                    // name, phone
                    name = parts[0];
                    phone = parts[1];
                } else if (parts.length === 3) {
                    // name, phone, service
                    name = parts[0];
                    phone = parts[1];
                    service = parts[2];
                } else if (parts.length >= 4) {
                    // name, phone, service, source (ignore extra)
                    name = parts[0];
                    phone = parts[1];
                    service = parts[2];
                    source = parts[3];
                }

                // Fallback: if still no phone, try to detect a phone-like token in the line
                if (!phone) {
                    const phoneMatch = line.match(/(\+?\d[\d\s\-().]{6,})/);
                    if (phoneMatch) {
                        phone = phoneMatch[1].trim();
                    }
                }

                if (!phone) continue;

                leads.push({
                    name,
                    phone,
                    service,
                    source
                });
            }

            if (!leads.length) {
                setImportStatus('No valid phone numbers found in your pasted text.', 'error');
                return;
            }

            console.log('[LEAD IMPORT] Parsed leads from paste:', leads.length);
            submitLeadImport(leads);
        }

        function parseCsv(text) {
            if (!text) return [];
            const lines = text.trim().split(/\r?\n/);
            if (lines.length < 2) return [];
            
            // Parse CSV line handling quoted values
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current.trim());
                return result;
            }
            
            const headers = parseCSVLine(lines.shift()).map(h => h.trim().toLowerCase());
            
            // Helper function to find column index by multiple possible names
            function findColumn(possibleNames) {
                for (const name of possibleNames) {
                    const index = headers.findIndex(h => h.includes(name.toLowerCase()));
                    if (index !== -1) return index;
                }
                return -1;
            }
            
            // Find column indices using flexible matching
            const nameIdx = findColumn(['name', 'contact', 'full name', 'contact name', 'lead name', 'decision maker', 'decisionmaker']);
            const phoneIdx = findColumn(['phone', 'mobile', 'telephone', 'tel', 'contact number', 'phone number', 'number']);
            const serviceIdx = findColumn(['service', 'interest', 'product', 'inquiry', 'service type']);
            const sourceIdx = findColumn(['source', 'lead source', 'campaign', 'utm_source', 'origin']);
            
            // Phone is required, others are optional
            if (phoneIdx === -1) {
                console.warn('No phone column found. Looking for: phone, mobile, telephone, tel, contact number');
                console.warn('Available headers:', headers);
                return [];
            }
            
            console.log('[CSV PARSE] Column mapping:', {
                name: nameIdx >= 0 ? headers[nameIdx] : 'not found',
                phone: headers[phoneIdx],
                service: serviceIdx >= 0 ? headers[serviceIdx] : 'not found',
                source: sourceIdx >= 0 ? headers[sourceIdx] : 'not found'
            });
            
            const parsedLeads = lines
                .map((line, lineNum) => {
                    if (!line.trim()) return null;
                    const cells = parseCSVLine(line);
                    
                    const phone = cells[phoneIdx] || '';
                    if (!phone || !phone.trim()) {
                        console.warn(`[CSV PARSE] Row ${lineNum + 2}: No phone number found, skipping`);
                        return null; // Skip rows without phone
                    }
                    
                    return {
                        name: nameIdx >= 0 ? (cells[nameIdx] || '').trim() : '',
                        phone: phone.trim(),
                        service: serviceIdx >= 0 ? (cells[serviceIdx] || '').trim() : '',
                        source: sourceIdx >= 0 ? (cells[sourceIdx] || '').trim() : ''
                    };
                })
                .filter(lead => lead && lead.phone && lead.phone.trim());
            
            console.log(`[CSV PARSE] Parsed ${parsedLeads.length} valid leads from ${lines.length} rows`);
            return parsedLeads;
        }

        async function submitLeadImport(leads = []) {
            console.log('[LEAD IMPORT] Starting import with leads:', leads.length);
            
            if (!Array.isArray(leads) || !leads.length) {
                console.warn('[LEAD IMPORT] No leads provided');
                setImportStatus('No valid rows found in CSV', 'error');
                return;
            }
            
            // Ensure currentClient is set
            if (!currentClient) {
                currentClient = getClientFromURL();
                console.log('[LEAD IMPORT] Retrieved client from URL:', currentClient);
            }
            
            console.log('[LEAD IMPORT] Current client:', currentClient, 'URL:', window.location.href);
            
            if (currentClient === DEMO_CLIENT_KEY) {
                const demoLeads = leads.map((lead, idx) => ({
                    id: Date.now() + idx,
                    name: lead.name || lead.phone,
                    phone: lead.phone,
                    service: lead.service || 'Lead Follow-Up',
                    source: lead.source || 'Import',
                    status: 'New (demo)',
                    lastMessage: 'Added via CSV import.',
                    timeAgo: 'Just now'
                }));
                // Merge imported leads with existing, keeping imported at top
                const existingLeads = (dashboardData.recentLeads || []).filter(lead => 
                    !lead.phone || !demoLeads.some(dl => dl.phone === lead.phone)
                );
                dashboardData.recentLeads = [...demoLeads, ...existingLeads].slice(0, 10);
                renderLeads(dashboardData.recentLeads);
                setImportStatus(`${demoLeads.length} leads staged (demo)`, 'success');
                showToast('Leads Imported', `${demoLeads.length} leads added (demo mode)`, 'success');
                return;
            }
            try {
                if (!currentClient || currentClient === DEMO_CLIENT_KEY) {
                    throw new Error('Client key is required. Please access the dashboard with a valid client key in the URL (?client=your-client-key)');
                }
                
                // Map and filter leads
                const mappedLeads = leads.map(lead => ({
                    name: lead.name || '',
                    phone: lead.phone || '',
                    service: lead.service || 'Lead Follow-Up',
                    source: lead.source || 'Import'
                })).filter(lead => lead.phone && lead.phone.trim()); // Only send leads with valid phone numbers
                
                if (!mappedLeads || mappedLeads.length === 0) {
                    throw new Error('No valid leads found. Ensure your CSV has a "phone" column with phone numbers.');
                }
                
                const requestBody = { 
                    clientKey: currentClient, 
                    leads: mappedLeads
                };
                
                // Validate request body before sending
                if (!requestBody.clientKey || !requestBody.clientKey.trim()) {
                    console.error('[LEAD IMPORT] Client key validation failed:', {
                        currentClient,
                        requestBodyClientKey: requestBody.clientKey,
                        url: window.location.href,
                        urlParams: new URLSearchParams(window.location.search).get('client')
                    });
                    throw new Error('Client key is missing. Please access the dashboard with a client key in the URL (?client=your-client-key)');
                }
                
                if (!Array.isArray(requestBody.leads) || requestBody.leads.length === 0) {
                    console.error('[LEAD IMPORT] Leads validation failed:', {
                        mappedLeadsLength: mappedLeads.length,
                        requestBodyLeadsLength: requestBody.leads?.length
                    });
                    throw new Error('No valid leads to import. Please check your CSV file.');
                }
                
                const requestBodyString = JSON.stringify(requestBody);
                console.log('[LEAD IMPORT] ========== REQUEST DETAILS ==========');
                console.log('[LEAD IMPORT] Full request body:', requestBody);
                console.log('[LEAD IMPORT] Stringified body:', requestBodyString);
                console.log('[LEAD IMPORT] Body length:', requestBodyString.length);
                console.log('[LEAD IMPORT] Client key:', requestBody.clientKey);
                console.log('[LEAD IMPORT] Leads count:', requestBody.leads.length);
                console.log('[LEAD IMPORT] First lead:', requestBody.leads[0]);
                console.log('[LEAD IMPORT] Endpoint:', `${BASE_URL}/api/leads/import`);
                console.log('[LEAD IMPORT] Base URL:', BASE_URL);
                
                setImportStatus('Uploading leads...');
                showToast('Uploading', 'Importing leads...', 'info');
                
                const response = await fetch(`${BASE_URL}/api/leads/import`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: requestBodyString
                });
                
                console.log('[LEAD IMPORT] Response received:', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    headers: Object.fromEntries(response.headers.entries())
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[LEAD IMPORT] Server error:', {
                        status: response.status,
                        statusText: response.statusText,
                        errorText: errorText,
                        requestBody: { clientKey: requestBody.clientKey, leadCount: requestBody.leads.length }
                    });
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch {
                        throw new Error(`Import failed: ${response.status} ${response.statusText}. ${errorText}`);
                    }
                    throw new Error(errorData.error || errorData.message || 'Import failed');
                }
                
                const payload = await response.json();
                if (!payload?.ok) {
                    throw new Error(payload.error || 'Import failed');
                }
                if (Array.isArray(payload.leads) && payload.leads.length) {
                    dashboardData.recentLeads = [...payload.leads, ...(dashboardData.recentLeads || [])].slice(0, 5);
                    renderLeads(dashboardData.recentLeads);
                }
                setImportStatus(`Imported ${payload.inserted} leads`, 'success');
                showToast('Import Complete', `Successfully imported ${payload.inserted} leads`, 'success');
            } catch (error) {
                console.error('Import failed', error);
                const errorMsg = error.message || 'Unable to import leads. Please check your CSV format and try again.';
                setImportStatus(errorMsg, 'error');
                showToast('Import Failed', errorMsg, 'error');
            }
        }

        function setImportStatus(message, type) {
            const statusEl = document.getElementById('leadImportStatus');
            if (!statusEl) return;
            statusEl.textContent = message;
            statusEl.className = `import-status ${type || ''}`;
        }

        async function loadIntegrationHealth(clientKey) {
            if (clientKey === DEMO_CLIENT_KEY) {
                renderIntegrationStatus(DEMO_INTEGRATIONS);
                return;
            }
            try {
                const response = await fetch(`${BASE_URL}/api/integration-health/${clientKey}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const payload = await response.json();
                if (payload?.ok && Array.isArray(payload.integrations)) {
                    renderIntegrationStatus(payload.integrations);
                } else {
                    // Show empty state if no integrations returned
                    renderIntegrationStatus([]);
                }
            } catch (error) {
                console.warn('Failed to load integration health', error);
                // Show empty state on error - don't break dashboard
                const container = document.getElementById('integration-health');
                if (container) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <span class="empty-state-icon">âš ï¸</span>
                            <div class="empty-state-title">Unable to load integrations</div>
                            <div class="empty-state-message">Integration status unavailable. Dashboard will continue to work normally.</div>
                        </div>
                    `;
                }
            }
        }
    </script>
</body>
</html>

