<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Dashboard - AI Booking Concierge</title>
    <style>
        :root {
            --primary: #5c6ac4;
            --secondary: #3a4a9f;
            --success: #1b5e20;
            --warning: #f5a623;
            --danger: #c62828;
            --light: #f7f9fc;
            --dark: #1f2234;
            --card-shadow: 0 8px 24px rgba(16, 26, 62, 0.08);
            --surface: #ffffff;
            --text: #2b2e3b;
            --muted: #6f7390;
        }

        body[data-theme="dark"] {
            --surface: #181b2a;
            --text: #eef0ff;
            --muted: #b1b6d4;
            --light: #1f2335;
            background: radial-gradient(circle at top, #1f2640, #0f1324);
            color: var(--text);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #eef2ff 0%, #e3ebff 40%, #fef9ff 100%);
            color: #2b2e3b;
            line-height: 1.5;
            font-feature-settings: 'cv02', 'cv03', 'cv04';
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px 72px;
        }

        .header {
            background: var(--surface);
            border-radius: 20px;
            padding: 28px 32px;
            box-shadow: var(--card-shadow);
            border-left: 6px solid var(--primary);
            border: 1px solid rgba(92,106,196,0.15);
        }

        .client-info {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
            align-items: center;
        }

        .client-brand {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .client-logo {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: #fff;
            background: var(--primary);
        }

        .client-details h1 {
            font-size: 2.3rem;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .client-details p {
            color: var(--muted);
            font-size: 1rem;
            margin-top: 4px;
        }

        .status-chip {
            padding: 10px 20px;
            border-radius: 999px;
            font-weight: 600;
            background: rgba(92, 106, 196, 0.1);
            color: var(--primary);
        }

        body[data-theme="dark"] .status-chip {
            background: rgba(92,106,196,0.3);
            color: #d5d9ff;
        }

        .client-meta {
            margin-top: 18px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .meta-item {
            background: var(--light);
            border-radius: 12px;
            padding: 12px 16px;
        }

        .meta-label {
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            color: #8c8fab;
            margin-bottom: 4px;
        }

        .meta-value {
            font-weight: 600;
            color: #2f3147;
        }

        .demo-banner {
            margin-top: 18px;
            padding: 14px 18px;
            border-radius: 14px;
            background: #fff8e1;
            border-left: 4px solid #f5a623;
            color: #7a4f00;
            display: none;
        }

        .status-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 22px;
            margin: 30px 0;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.96);
            border-radius: 18px;
            padding: 18px;
            box-shadow: var(--card-shadow);
            text-align: center;
            border: 1px solid rgba(92,106,196,0.1);
            position: relative;
            overflow: hidden;
        }

        .status-card h4 {
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-size: 0.75rem;
            color: #8c8fab;
            margin-bottom: 10px;
        }

        .status-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .status-hint {
            margin-top: 6px;
            font-size: 0.85rem;
            color: #8c8fab;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 22px;
        }

        .card {
            background: var(--surface);
            border-radius: 18px;
            padding: 22px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(92,106,196,0.08);
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .card h3 {
            margin-bottom: 18px;
            font-size: 1.2rem;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-subtitle {
            margin-top: -10px;
            margin-bottom: 16px;
            font-size: 0.92rem;
            color: #7a7da0;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f3fb;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--muted);
        }

        .metric-value {
            font-weight: 600;
            color: var(--primary);
        }

        .leads-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 320px;
            overflow-y: auto;
        }

        .lead-item {
            border: 1px solid #eef0fb;
            border-radius: 12px;
            padding: 14px;
            background: #f9f9ff;
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .lead-item:hover {
            transform: translateY(-2px);
            border-color: rgba(92,106,196,0.5);
        }

        .lead-name {
            font-weight: 600;
            color: #2f3147;
        }

        .lead-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #7b7f9f;
            margin-top: 6px;
        }

        .lead-status {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            background: rgba(92, 106, 196, 0.12);
            color: var(--primary);
        }
        .theme-toggle {
            border: 1px solid rgba(92,106,196,0.3);
            background: transparent;
            color: var(--primary);
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .theme-toggle:hover {
            background: rgba(92,106,196,0.1);
        }

        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(7, 11, 30, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(6px);
        }

        .modal-backdrop.open {
            display: flex;
        }

        .lead-modal {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px 28px;
            width: min(480px, 90%);
            box-shadow: 0 30px 60px rgba(11, 14, 32, 0.35);
            border: 1px solid rgba(92,106,196,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .modal-header h4 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text);
        }

        .modal-close {
            border: none;
            background: transparent;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--muted);
        }

        .modal-body p {
            margin: 6px 0;
            color: var(--muted);
        }

        .mix-list {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .mix-item {
            border: 1px solid rgba(92,106,196,0.12);
            border-radius: 12px;
            padding: 12px 14px;
        }

        .mix-header {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            color: #2f3147;
            margin-bottom: 6px;
        }

        .mix-bar {
            height: 10px;
            border-radius: 999px;
            background: #eef0ff;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .mix-bar-fill {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .mix-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #7a7fa4;
        }

        .mix-tag {
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(27, 94, 32, 0.12);
            color: var(--success);
        }

        .chart {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            height: 180px;
            padding: 8px 6px;
        }

        .chart-bar {
            flex: 1;
            border-radius: 8px 8px 4px 4px;
            background: linear-gradient(180deg, rgba(92,106,196,0.85), rgba(58,74,159,0.85));
            position: relative;
        }

        .chart-bar::after {
            content: attr(data-label);
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.85rem;
            color: #8c8fab;
        }

        .chart-value {
            text-align: center;
            margin-top: 8px;
            font-size: 0.9rem;
            color: #616484;
        }

        .activity-feed {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid #ecefff;
            background: #fbfbff;
        }

        .activity-item strong {
            color: #2f3147;
        }

        .activity-meta {
            margin-top: 4px;
            color: #8b8fb0;
            font-size: 0.9rem;
        }

        .workflow-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .workflow-step {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .workflow-icon {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            background: rgba(92,106,196,0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }


        @media (max-width: 768px) {
            .client-info {
                flex-direction: column;
                align-items: flex-start;
            }
            .status-bar {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="client-info">
                <div class="client-brand">
                    <div class="client-logo" id="clientLogo">‚ú®</div>
                    <div class="client-details">
                        <h1 id="clientName">Demo Booking Partner</h1>
                        <p id="clientDescription">Real-time follow-up + booking dashboard</p>
                        <p id="clientTagline">We chase every lead you already paid for and land them on your calendar.</p>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:12px;">
                    <button class="theme-toggle" id="themeToggle" type="button">Dark mode</button>
                    <div class="status-chip" id="clientStatus">Live</div>
                </div>
            </div>

            <div class="client-meta" id="clientMeta">
                <div class="meta-item">
                    <div class="meta-label">Phone</div>
                    <div class="meta-value" id="metaPhone">+44 20 3880 1234</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Timezone</div>
                    <div class="meta-value" id="metaTimezone">Europe/London</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Coverage</div>
                    <div class="meta-value" id="metaHours">8am - 8pm, 7 days/week</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Industry</div>
                    <div class="meta-value" id="metaIndustry">AI Booking Concierge</div>
                </div>
            </div>

            <div class="demo-banner" id="demoBanner">
                <strong>Demo environment:</strong> This sandbox mirrors the live dashboard your clients see. We just preload it with mock data for Looms.
            </div>
        </header>

        <section class="status-bar">
            <div class="status-card" title="Total leads loaded for this tenant">
                <h4>Total Leads</h4>
                <div class="status-value" id="statusTotalLeads">48</div>
                <p class="status-hint" id="statusHintLeads">Last 24h: 7 new</p>
            </div>
            <div class="status-card" title="AI outbound + inbound conversations logged">
                <h4>AI Calls Logged</h4>
                <div class="status-value" id="statusTotalCalls">36</div>
                <p class="status-hint" id="statusHintCalls">Booked: 12 this week</p>
            </div>
            <div class="status-card" title="Lead-to-booked conversion from AI follow-up">
                <h4>Conversion Rate</h4>
                <div class="status-value" id="statusConversionRate">63%</div>
                <p class="status-hint" id="statusHintConversion">Win rate: 84%</p>
            </div>
            <div class="status-card" title="Average time from lead drop to first AI touch">
                <h4>First Response</h4>
                <div class="status-value" id="statusFirstResponse">2m 58s</div>
                <p class="status-hint" id="statusHintResponse">Goal: under 5 min</p>
            </div>
        </section>

        <section class="dashboard-grid">
            <article class="card">
                <h3>üìà Recent Activity</h3>
                <p class="card-subtitle">Rolling 24h snapshot of AI follow-up.</p>
                <div id="recent-activity">
                    <div class="metric-row">
                        <span class="metric-label">New leads (24h)</span>
                        <span class="metric-value">7</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Calls completed</span>
                        <span class="metric-value">21</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Appointments booked</span>
                        <span class="metric-value">12</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg response speed</span>
                        <span class="metric-value">2m 58s</span>
                    </div>
                </div>
            </article>

            <article class="card">
                <h3>üß© Lead Priority</h3>
                <p class="card-subtitle">Automatic scoring from recent touchpoints.</p>
                <div id="lead-priority">
                    <div class="metric-row">
                        <span class="metric-label">High priority</span>
                        <span class="metric-value">9</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Medium</span>
                        <span class="metric-value">14</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Low</span>
                        <span class="metric-value">7</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Avg lead score</span>
                        <span class="metric-value">87</span>
                    </div>
                </div>
            </article>

            <article class="card">
                <h3>üë• Recent Leads</h3>
                <p class="card-subtitle">Latest leads routed to the concierge.</p>
                <div id="leads-list" class="leads-list"></div>
            </article>

            <article class="card">
                <h3>üßÆ Service Mix</h3>
                <p class="card-subtitle">Where the concierge spends its time.</p>
                <div id="service-mix" class="mix-list"></div>
            </article>

            <article class="card">
                <h3>üìä Weekly Performance</h3>
                <p class="card-subtitle">Touchpoints generated over the last 7 days.</p>
                <div id="performance-chart">
                    <div class="chart" id="chartBars"></div>
                    <p class="chart-value" id="chartSummary">18 bookings in the last 7 days</p>
                </div>
            </article>

            <article class="card">
                <h3>‚öôÔ∏è System Status</h3>
                <p class="card-subtitle">Live configuration connected to your channels.</p>
                <div id="system-status">
                    <div class="metric-row">
                        <span class="metric-label">Lead number</span>
                        <span class="metric-value" id="statusPhone">+44 20 3880 1234</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">SMS & WhatsApp</span>
                        <span class="metric-value">Active</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Calendar sync</span>
                        <span class="metric-value">Connected</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Pipeline coverage</span>
                        <span class="metric-value" id="statusCoverage">7 days/week</span>
                    </div>
                </div>
            </article>

            <article class="card" style="grid-column: 1 / -1;">
                <h3>üóìÔ∏è Latest Conversations</h3>
                <p class="card-subtitle">Newest AI-led calls and follow-ups.</p>
                <div id="recent-calls" class="activity-feed"></div>
            </article>

            <article class="card" style="grid-column: 1 / -1;">
                <h3>üìã How We Run This For You</h3>
                <p class="card-subtitle">Done-for-you workflow the concierge follows every day.</p>
                <ul id="workflow" class="workflow-list"></ul>
            </article>
        </section>
    </div>

    <div class="modal-backdrop" id="leadModal">
        <div class="lead-modal">
            <div class="modal-header">
                <h4 id="modalLeadName">Lead Name</h4>
                <button class="modal-close" id="modalCloseBtn" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Service:</strong> <span id="modalLeadService">‚Äî</span></p>
                <p><strong>Source:</strong> <span id="modalLeadSource">‚Äî</span></p>
                <p><strong>Status:</strong> <span id="modalLeadStatus">‚Äî</span></p>
                <p><strong>Last message:</strong></p>
                <p id="modalLeadNotes">‚Äî</p>
            </div>
        </div>
    </div>

    <script>
        const DEMO_CLIENT_KEY = 'demo_client';
        const BASE_URL = window.location.origin;
        const THEME_KEY = 'dashboard_theme';

        const CLIENT_CONFIG = {
            demo_client: {
                name: 'Demo Booking Partner',
                description: 'Live sandbox showing the AI concierge following up + booking',
                tagline: 'Upload existing leads ‚Üí AI calls in minutes ‚Üí appointments land in your calendar.',
                logo: '‚ú®',
                status: 'Demo Live',
                phone: '+44 20 3880 1234',
                timezone: 'Europe/London',
                businessHours: '8am - 8pm, 7 days/week',
                industry: 'AI Booking Concierge',
                workflow: [
                    { icon: 'üì•', title: 'Import leads', desc: 'We pull directly from your CRM, forms, or spreadsheets.' },
                    { icon: 'ü§ñ', title: 'AI speed-to-lead', desc: 'Calls + SMS go out within minutes (24/7 coverage).' },
                    { icon: 'üìÖ', title: 'Bookings land in calendar', desc: 'Confirmed appointments drop straight into your calendar.' },
                    { icon: 'üìä', title: 'Daily digest', desc: 'Slack/email summary with leads touched and outcomes.' }
                ],
                chart: [5, 7, 6, 9, 8, 10, 7]
            }
        };

        const DEMO_DATA = {
            totalLeads: 48,
            totalCalls: 36,
            last24hLeads: 7,
            conversionRate: 63,
            successRate: 84,
            firstResponse: '2m 58s',
            bookingsThisWeek: 18,
            avgLeadScore: 87,
            highPriorityLeads: 9,
            mediumPriorityLeads: 14,
            lowPriorityLeads: 7,
            touchpoints: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                data: [5, 7, 6, 9, 8, 10, 7]
            },
            recentLeads: [
                { name: 'Jordan Hale', phone: '+44 7700 900451', service: 'AI Strategy Session', status: 'Booked ‚Ä¢ calendar invite sent', source: 'Facebook Lead Ad', timeAgo: '2 min ago', lastMessage: '‚ÄúGot the confirmation, see you Tuesday.‚Äù' },
                { name: 'Priya Desai', phone: '+44 7700 900512', service: 'Follow-up Call', status: 'Awaiting reply ‚Ä¢ wants afternoon slot', source: 'Website form', timeAgo: '9 min ago', lastMessage: 'Asked for 4-6pm slot; AI sent options.' },
                { name: 'Lewis Grant', phone: '+44 7700 900623', service: 'Pricing Review', status: 'Engaged ‚Ä¢ asked for case study', source: 'Referral', timeAgo: '25 min ago', lastMessage: 'Shared case study + queued callback tomorrow.' },
                { name: 'Emily Carr', phone: '+44 7700 900734', service: 'Calendar Integration', status: 'Left voicemail ‚Ä¢ SMS reminder queued', source: 'CRM import', timeAgo: '40 min ago', lastMessage: 'Voicemail dropped, SMS reminder scheduled at 9am.' },
                { name: 'Tom Osei', phone: '+44 7700 900845', service: 'AI Concierge Setup', status: 'Nurture ‚Ä¢ waiting on partner approval', source: 'Google Ads', timeAgo: '58 min ago', lastMessage: 'Sent partner-friendly explainer PDF.' }
            ],
            serviceMix: [
                { name: 'Lead Follow-Up', percent: 35, notes: 'Speed-to-lead flows' },
                { name: 'Appointment Booking', percent: 45, notes: 'AI calendar concierge' },
                { name: 'Calendar Integration', percent: 20, notes: 'Multi-calendar sync' }
            ],
            recentCalls: [
                { name: 'Sarah Patel', summary: 'Booked Tuesday 2:30pm via AI call', channel: 'Phone', timeAgo: '2 min ago' },
                { name: 'Marcus Flynn', summary: 'Requested reschedule ‚Ä¢ SMS follow-up sent', channel: 'SMS ‚Üí Call', timeAgo: '9 min ago' },
                { name: 'Laura Chen', summary: 'Synced with Google Calendar ‚Ä¢ reminder scheduled', channel: 'Webhook sync', timeAgo: '25 min ago' },
                { name: 'Rick Alvarez', summary: 'Moved to Thursday ‚Ä¢ calendar updated', channel: 'Phone', timeAgo: '42 min ago' }
            ]
        };

        function getClientFromURL() {
            const params = new URLSearchParams(window.location.search);
            return (params.get('client') || DEMO_CLIENT_KEY).replace(/-/g, '_');
        }

        let currentLeads = [];

        async function fetchLiveData(clientKey) {
            if (clientKey !== DEMO_CLIENT_KEY) {
                try {
                    const res = await fetch(`${BASE_URL}/api/demo-dashboard/${clientKey}`);
                    if (res.ok) {
                        const payload = await res.json();
                        if (payload.ok) return payload;
                    }
                } catch (err) {
                    console.warn('Live data unavailable', err.message);
                }
            }
            return null;
        }

        function mergeData(base = {}, livePayload) {
            if (!livePayload) return base;
            const metrics = livePayload.metrics || {};
            return {
                ...base,
                totalLeads: metrics.totalLeads ?? base.totalLeads,
                totalCalls: metrics.totalCalls ?? base.totalCalls,
                last24hLeads: metrics.last24hLeads ?? base.last24hLeads,
                conversionRate: metrics.conversionRate ?? base.conversionRate,
                successRate: metrics.successRate ?? base.successRate,
                firstResponse: metrics.firstResponse ?? base.firstResponse,
                bookingsThisWeek: metrics.bookingsThisWeek ?? base.bookingsThisWeek,
                avgLeadScore: metrics.avgLeadScore ?? base.avgLeadScore,
                highPriorityLeads: metrics.highPriorityLeads ?? base.highPriorityLeads,
                mediumPriorityLeads: metrics.mediumPriorityLeads ?? base.mediumPriorityLeads,
                lowPriorityLeads: metrics.lowPriorityLeads ?? base.lowPriorityLeads,
                recentLeads: Array.isArray(livePayload.leads) && livePayload.leads.length ? livePayload.leads : base.recentLeads,
                serviceMix: Array.isArray(livePayload.serviceMix) && livePayload.serviceMix.length ? livePayload.serviceMix : base.serviceMix,
                recentCalls: Array.isArray(livePayload.recentCalls) && livePayload.recentCalls.length ? livePayload.recentCalls : base.recentCalls,
                touchpoints: livePayload.touchpoints && Array.isArray(livePayload.touchpoints.data)
                    ? livePayload.touchpoints
                    : base.touchpoints
            };
        }

        function updateHeader(config) {
            document.getElementById('clientLogo').textContent = config.logo || 'üè¢';
            document.getElementById('clientName').textContent = config.name;
            document.getElementById('clientDescription').textContent = config.description || '';
            document.getElementById('clientTagline').textContent = config.tagline || '';
            document.getElementById('clientStatus').textContent = config.status || 'Live';
            document.getElementById('metaPhone').textContent = config.phone || '‚Äî';
            document.getElementById('metaTimezone').textContent = config.timezone || '‚Äî';
            document.getElementById('metaHours').textContent = config.businessHours || '‚Äî';
            document.getElementById('metaIndustry').textContent = config.industry || '‚Äî';

            const banner = document.getElementById('demoBanner');
            if (banner) {
                if (config.key === DEMO_CLIENT_KEY) {
                    banner.style.display = 'block';
                    banner.innerHTML = `<strong>Demo environment:</strong> ${config.name} shows exactly what your live dashboard will look like. When we onboard you we simply plug in your data.`;
                } else {
                    banner.style.display = 'none';
                }
            }
        }

        function formatNumber(value) {
            if (value === undefined || value === null) return '‚Äî';
            return Number(value).toLocaleString('en-GB');
        }

        function formatPercent(value) {
            if (value === undefined || value === null) return '‚Äî';
            const numeric = Number(value);
            return Number.isFinite(numeric) ? `${numeric}%` : `${value}`;
        }

        function updateStatusBar(data) {
            const totalLeads = formatNumber(data.totalLeads);
            const totalCalls = formatNumber(data.totalCalls);
            const conversion = formatPercent(data.conversionRate);
            const firstResponse = data.firstResponse || '‚Äî';

            document.getElementById('statusTotalLeads').textContent = totalLeads;
            document.getElementById('statusTotalCalls').textContent = totalCalls;
            document.getElementById('statusConversionRate').textContent = conversion;
            document.getElementById('statusFirstResponse').textContent = firstResponse;

            const last24 = formatNumber(data.last24hLeads ?? 0);
            const bookings = formatNumber(data.bookingsThisWeek ?? 0);
            const winRate = formatPercent(data.successRate ?? 0);

            document.getElementById('statusHintLeads').textContent = `Last 24h: ${last24} new`;
            document.getElementById('statusHintCalls').textContent = `${bookings} bookings locked in`;
            document.getElementById('statusHintConversion').textContent = `Win rate: ${winRate}`;
            document.getElementById('statusHintResponse').textContent = firstResponse === '‚Äî'
                ? 'Goal: under 5 min'
                : `Current: ${firstResponse}`;
        }

        function renderRecentActivity(data) {
            const container = document.getElementById('recent-activity');
            container.innerHTML = `
                <div class="metric-row"><span class="metric-label">New leads (24h)</span><span class="metric-value">${formatNumber(data.last24hLeads)}</span></div>
                <div class="metric-row"><span class="metric-label">Calls completed</span><span class="metric-value">${formatNumber(data.totalCalls)}</span></div>
                <div class="metric-row"><span class="metric-label">Appointments booked</span><span class="metric-value">${formatNumber(data.bookingsThisWeek ?? 18)}</span></div>
                <div class="metric-row"><span class="metric-label">Avg response speed</span><span class="metric-value">${data.firstResponse || '‚Äî'}</span></div>
            `;
        }

        function renderLeadPriority(data) {
            const container = document.getElementById('lead-priority');
            container.innerHTML = `
                <div class="metric-row"><span class="metric-label">High priority</span><span class="metric-value">${formatNumber(data.highPriorityLeads ?? 0)}</span></div>
                <div class="metric-row"><span class="metric-label">Medium</span><span class="metric-value">${formatNumber(data.mediumPriorityLeads ?? 0)}</span></div>
                <div class="metric-row"><span class="metric-label">Low</span><span class="metric-value">${formatNumber(data.lowPriorityLeads ?? 0)}</span></div>
                <div class="metric-row"><span class="metric-label">Avg lead score</span><span class="metric-value">${formatNumber(data.avgLeadScore ?? 0)}</span></div>
            `;
        }

        function renderLeads(leads = []) {
            const container = document.getElementById('leads-list');
            if (!container) return;
            if (!leads.length) {
                container.innerHTML = '<p style="color:#8c8fab;">Leads will appear here as soon as they arrive.</p>';
                currentLeads = [];
                return;
            }
            currentLeads = leads.slice(0, 5);
            container.innerHTML = currentLeads.map((lead, index) => `
                <div class="lead-item" data-lead-index="${index}" role="button" tabindex="0">
                    <div class="lead-name">${lead.name || 'Prospect'}</div>
                    <div class="lead-meta">
                        <span>${lead.phone || lead.email || ''}</span>
                        <span>${lead.service || 'General'}</span>
                    </div>
                    <div class="lead-status">${lead.status || 'In follow-up'}</div>
                </div>
            `).join('');
            attachLeadModalEvents();
        }

        function renderServiceMix(mix = []) {
            const container = document.getElementById('service-mix');
            if (!container) return;
            if (!Array.isArray(mix) || !mix.length) {
                container.innerHTML = '<p style="color:#8c8fab;">Connect services to see distribution.</p>';
                return;
            }
            const topPercent = Math.max(...mix.map(item => item.percent || 0), 0);
            container.innerHTML = mix.map(service => {
                const percent = Math.max(0, Math.min(100, service.percent || 0));
                const tag = percent === topPercent && percent > 0
                    ? '<span class="mix-tag">Top workflow</span>'
                    : '';
                return `
                    <div class="mix-item">
                        <div class="mix-header">
                            <span>${service.name || 'Service'}</span>
                            <span>${percent}%</span>
                        </div>
                        <div class="mix-bar" role="presentation">
                            <div class="mix-bar-fill" style="width:${percent}%;"></div>
                        </div>
                        <div class="mix-meta">
                            <span>${service.notes || 'Running in parallel'}</span>
                            <span>${tag}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderChart(config, data) {
            const fallbackLabels = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
            const chartSource = data?.touchpoints && Array.isArray(data.touchpoints.data) && data.touchpoints.data.length
                ? data.touchpoints
                : { labels: fallbackLabels, data: config.chart || fallbackLabels.map(() => 0) };
            const totals = chartSource.data;
            const labels = chartSource.labels?.length === totals.length ? chartSource.labels : fallbackLabels;
            const max = Math.max(...totals, 1);
            const bars = totals.map((value, idx) => `
                <div class="chart-bar" style="height:${(value / max) * 100}%;" data-label="${labels[idx] || ''}"></div>
            `).join('');
            document.getElementById('chartBars').innerHTML = bars;
            document.getElementById('chartSummary').textContent = `${totals.reduce((sum,v)=>sum+v,0)} touchpoints in the last 7 days`;
        }


        function renderSystemStatus(config) {
            document.getElementById('statusPhone').textContent = config.phone || '‚Äî';
            document.getElementById('statusCoverage').textContent = config.businessHours || '‚Äî';
        }

        function renderCalls(calls = []) {
            const container = document.getElementById('recent-calls');
            if (!calls.length) {
                container.innerHTML = '<p style="color:#8c8fab;">Live call feed will show up here as soon as we begin calling leads.</p>';
                return;
            }
            container.innerHTML = calls.map(call => `
                <div class="activity-item">
                    <strong>${call.name || 'Prospect'}</strong> ‚Ä¢ ${call.channel || 'AI call'}
                    <div class="activity-meta">${call.summary || 'Conversation logged'} ‚Ä¢ ${call.timeAgo || 'Just now'}</div>
                </div>
            `).join('');
        }

        function renderWorkflow(steps = []) {
            const container = document.getElementById('workflow');
            container.innerHTML = steps.map(step => `
                <li class="workflow-step">
                    <div class="workflow-icon">${step.icon}</div>
                    <div>
                        <strong>${step.title}</strong>
                        <p style="color:#6f7390; margin-top:4px;">${step.desc}</p>
                    </div>
                </li>
            `).join('');
        }

        function attachLeadModalEvents() {
            document.querySelectorAll('.lead-item').forEach(item => {
                item.addEventListener('click', () => openLeadModal(item.dataset.leadIndex));
                item.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        openLeadModal(item.dataset.leadIndex);
                    }
                });
            });
        }

        function openLeadModal(index) {
            const lead = currentLeads[Number(index)];
            if (!lead) return;
            document.getElementById('modalLeadName').textContent = lead.name || lead.phone || 'Lead';
            document.getElementById('modalLeadService').textContent = lead.service || 'General';
            document.getElementById('modalLeadSource').textContent = lead.source || 'Unknown';
            document.getElementById('modalLeadStatus').textContent = lead.status || 'In follow-up';
            document.getElementById('modalLeadNotes').textContent = lead.lastMessage || lead.notes || 'No notes yet.';
            document.getElementById('leadModal').classList.add('open');
        }

        function closeLeadModal() {
            document.getElementById('leadModal').classList.remove('open');
        }

        async function initDashboard() {
            const clientKey = getClientFromURL();
            const config = { ...CLIENT_CONFIG[clientKey] } || CLIENT_CONFIG[DEMO_CLIENT_KEY];
            config.key = clientKey;
            updateHeader(config);
            initThemeToggle();
            initModalControls();

            let data = { ...DEMO_DATA };
            if (clientKey === DEMO_CLIENT_KEY) {
                document.getElementById('demoBanner').style.display = 'block';
            } else {
                const banner = document.getElementById('demoBanner');
                if (banner) banner.style.display = 'none';
            }

            const livePayload = await fetchLiveData(clientKey);
            data = mergeData(data, livePayload);

            updateStatusBar(data);
            renderRecentActivity(data);
            renderLeadPriority(data);
            renderLeads(data.recentLeads || []);
            renderServiceMix(data.serviceMix || []);
            renderChart(config, data);
            renderSystemStatus(config);
            renderCalls(data.recentCalls || []);
            renderWorkflow(config.workflow || CLIENT_CONFIG.demo_client.workflow);

            setInterval(async () => {
                const refreshPayload = await fetchLiveData(clientKey);
                if (refreshPayload) {
                    data = mergeData(data, refreshPayload);
                    updateStatusBar(data);
                    renderRecentActivity(data);
                    renderLeadPriority(data);
                    renderLeads(data.recentLeads || []);
                    renderServiceMix(data.serviceMix || []);
                    renderCalls(data.recentCalls || []);
                    renderChart(config, data);
                }
            }, 30000);
        }

        document.addEventListener('DOMContentLoaded', initDashboard);

        function initThemeToggle() {
            const toggle = document.getElementById('themeToggle');
            if (!toggle) return;
            const saved = localStorage.getItem(THEME_KEY) || 'light';
            applyTheme(saved);
            toggle.textContent = saved === 'dark' ? 'Light mode' : 'Dark mode';
            toggle.addEventListener('click', () => {
                const nextMode = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
                applyTheme(nextMode);
                toggle.textContent = nextMode === 'dark' ? 'Light mode' : 'Dark mode';
                localStorage.setItem(THEME_KEY, nextMode);
            });
        }

        function applyTheme(mode) {
            if (mode === 'dark') {
                document.body.dataset.theme = 'dark';
            } else {
                document.body.dataset.theme = '';
            }
        }

        function initModalControls() {
            const backdrop = document.getElementById('leadModal');
            const closeBtn = document.getElementById('modalCloseBtn');
            if (closeBtn) closeBtn.addEventListener('click', closeLeadModal);
            if (backdrop) {
                backdrop.addEventListener('click', (event) => {
                    if (event.target === backdrop) closeLeadModal();
                });
            }
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') closeLeadModal();
            });
        }
    </script>
</body>
</html>

