<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Hub - Enterprise Dashboard</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #4a5568;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #4a5568;
            white-space: nowrap;
            min-width: 120px;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 600px;
        }

        .content-section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), transparent);
            pointer-events: none;
        }

        .stat-card h3 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .stat-card p {
            font-size: 1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .stat-card .trend {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .search-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-select {
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
            min-width: 150px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .score-display {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .score-value {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .score-high { color: #48bb78; }
        .score-medium { color: #ed8936; }
        .score-low { color: #f56565; }

        .score-bar {
            width: 60px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #f56565, #ed8936, #48bb78);
            transition: width 0.3s ease;
        }

        .engagement-score, .conversion-prob {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .engagement-high, .conversion-high {
            background: rgba(72, 187, 120, 0.2);
            color: #38a169;
        }

        .engagement-medium, .conversion-medium {
            background: rgba(237, 137, 54, 0.2);
            color: #dd6b20;
        }

        .engagement-low, .conversion-low {
            background: rgba(245, 101, 101, 0.2);
            color: #e53e3e;
        }

        .lead-name {
            line-height: 1.4;
        }

        .lead-name small {
            color: #718096;
            font-size: 0.8rem;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2d3748;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .metric-label {
            font-weight: 500;
            color: #4a5568;
        }

        .metric-value {
            font-weight: 700;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .insights-panel, .recommendations-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .insights-panel h3, .recommendations-panel h3 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 1.2rem;
        }

        .insight-item, .recommendation-item {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #667eea;
        }

        .insight-item h4 {
            margin-bottom: 8px;
            color: #2d3748;
            font-size: 1rem;
        }

        .insight-item p, .recommendation-item p {
            margin: 5px 0;
            color: #4a5568;
            line-height: 1.5;
        }

        .appointment-tab {
            display: none;
        }

        .appointment-tab.active {
            display: block;
        }

        .lead-info {
            line-height: 1.4;
        }

        .lead-info small {
            color: #718096;
            font-size: 0.8rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(72, 187, 120, 0.2);
            color: #38a169;
        }

        .status-inactive {
            background: rgba(245, 101, 101, 0.2);
            color: #e53e3e;
        }

        .status-pending {
            background: rgba(237, 137, 54, 0.2);
            color: #dd6b20;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4a5568;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2d3748;
        }

        .realtime-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(72, 187, 120, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
            display: none;
        }

        .realtime-indicator.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #4a5568;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .bulk-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
            padding: 15px;
            background: #f7fafc;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }
        
        .selection-info {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            margin-top: 5px;
            min-width: 200px;
            z-index: 1000;
            overflow: hidden;
        }
        
        .dropdown-menu a {
            display: block;
            padding: 12px 16px;
            color: #2d3748;
            text-decoration: none;
            transition: background 0.2s;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .dropdown-menu a:last-child {
            border-bottom: none;
        }
        
        .dropdown-menu a:hover {
            background: #f7fafc;
        }
        
        .global-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            margin-top: 5px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-result-item:hover {
            background: #f7fafc;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-type {
            font-size: 0.75rem;
            color: #667eea;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .search-result-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 2px;
        }
        
        .search-result-subtitle {
            font-size: 0.85rem;
            color: #718096;
        }

        .checkbox-column {
            width: 50px;
        }

        .export-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .insights-panel {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .insight-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .insight-priority-high {
            border-left: 4px solid #e53e3e;
        }

        .insight-priority-medium {
            border-left: 4px solid #ed8936;
        }

        .insight-priority-low {
            border-left: 4px solid #48bb78;
        }

        .forecast-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .forecast-card h4 {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .forecast-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .forecast-metric {
            text-align: center;
        }

        .forecast-metric .value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .forecast-metric .label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .notification-badge {
            position: relative;
        }

        .notification-badge::after {
            content: attr(data-count);
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tabs-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .advanced-filters {
            background: #f7fafc;
            padding: 20px;
            border-radius: 15px;
        }
        
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a5568;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
                padding: 15px 20px;
            }
            
            .header h1 {
                font-size: 1.5rem;
                flex-direction: column;
                gap: 10px;
            }
            
            .header > div {
                display: flex;
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            
            .header .btn {
                width: 100%;
            }
            
            .nav-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 4px;
            }
            
            .nav-tab {
                min-width: 100px;
                padding: 12px 16px;
                font-size: 0.9rem;
            }
            
            .search-bar {
                flex-direction: column;
            }
            
            .search-input,
            .filter-select {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .stat-card h3 {
                font-size: 2rem;
            }
            
            .data-table {
                font-size: 0.85rem;
                display: block;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .data-table th,
            .data-table td {
                padding: 10px 6px;
                white-space: nowrap;
            }
            
            .bulk-actions {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .bulk-actions .btn {
                width: 100%;
            }
            
            .content-section {
                padding: 15px;
            }
            
            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 20px;
            }
            
            .filter-bar {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-group {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.2rem;
            }
            
            .nav-tab {
                min-width: 80px;
                padding: 10px 12px;
                font-size: 0.8rem;
            }
            
            .stat-card h3 {
                font-size: 1.8rem;
            }
            
            .data-table {
                font-size: 0.75rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="realtime-indicator" id="realtimeIndicator">
        🔄 Real-time data updated
    </div>

    <div class="container">
        <div class="header">
            <h1>
                🎯 Admin Hub Enterprise
                <span class="status">
                    <span class="status-indicator"></span>
                    LIVE
                </span>
            </h1>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div style="position: relative;">
                    <input type="text" class="search-input" id="globalSearch" placeholder="🔍 Search everything..." style="min-width: 300px;" onkeyup="performGlobalSearch()">
                    <div id="globalSearchResults" class="global-search-results" style="display: none;"></div>
                </div>
                <button class="btn btn-primary" onclick="refreshAllData()">
                    🔄 Refresh All
                </button>
                <button class="btn btn-success" onclick="window.location.href='/admin-client-onboarding.html'">
                    ➕ New Client
                </button>
                <button class="btn btn-warning notification-badge" onclick="showNotifications()" data-count="0" id="notificationBtn">
                    🔔 Notifications
                </button>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showSection('overview')">📊 Overview</div>
            <div class="nav-tab" onclick="showSection('clients')">👥 Clients</div>
            <div class="nav-tab" onclick="showSection('calls')">📞 Calls</div>
            <div class="nav-tab" onclick="showSection('reminders')">⏰ Reminders</div>
            <div class="nav-tab" onclick="showSection('leads')">🎯 Lead Scoring</div>
            <div class="nav-tab" onclick="showSection('appointments')">📅 Appointments</div>
            <div class="nav-tab" onclick="showSection('analytics')">📈 Analytics</div>
            <div class="nav-tab" onclick="showSection('insights')">🧠 AI Insights</div>
            <div class="nav-tab" onclick="showSection('forecasts')">🔮 Forecasts</div>
            <div class="nav-tab" onclick="showSection('users')">👤 Users</div>
            <div class="nav-tab" onclick="showSection('system')">⚙️ System</div>
        </div>

        <!-- Overview Section -->
        <div id="overview" class="content-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="activeClients">-</h3>
                    <p>Active Clients</p>
                    <div class="trend" id="clientsTrend">↗️ +12%</div>
                </div>
                <div class="stat-card">
                    <h3 id="monthlyRevenue">-</h3>
                    <p>Monthly Revenue</p>
                    <div class="trend" id="revenueTrend">↗️ +8%</div>
                </div>
                <div class="stat-card">
                    <h3 id="totalCalls">-</h3>
                    <p>Total Calls</p>
                    <div class="trend" id="callsTrend">↗️ +15%</div>
                </div>
                <div class="stat-card">
                    <h3 id="conversionRate">-</h3>
                    <p>Conversion Rate</p>
                    <div class="trend" id="conversionTrend">↗️ +3%</div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">Recent Activity Trends</div>
                <canvas id="activityChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Client Performance Comparison</div>
                <canvas id="performanceChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Clients Section -->
        <div id="clients" class="content-section">
            <div class="advanced-filters">
                <div class="filter-header">
                    <h3 style="margin: 0; color: #2d3748;">Filters</h3>
                    <div class="filter-actions">
                        <button class="btn btn-secondary" onclick="saveCurrentFilter()" style="font-size: 0.85rem; padding: 6px 12px;">💾 Save View</button>
                        <select class="filter-select" id="savedViews" onchange="loadSavedView()" style="min-width: 150px;">
                            <option value="">Quick Filters...</option>
                            <option value="all-active">All Active</option>
                            <option value="high-value">High Value (>$1000)</option>
                            <option value="recent">Last 30 Days</option>
                            <option value="low-conversion">Low Conversion (<10%)</option>
                        </select>
                        <button class="btn btn-secondary" onclick="clearAllFilters()" style="font-size: 0.85rem; padding: 6px 12px;">🔄 Clear All</button>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Search</label>
                        <input type="text" class="search-input" id="clientSearch" placeholder="Search clients..." onkeyup="searchClients()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select class="filter-select" id="clientFilter" onchange="filterClients()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Industry</label>
                        <select class="filter-select" id="industryFilter" onchange="filterClients()">
                            <option value="">All Industries</option>
                            <option value="Healthcare">Healthcare</option>
                            <option value="Legal">Legal</option>
                            <option value="Fitness">Fitness</option>
                            <option value="Wellness">Wellness</option>
                            <option value="Technology">Technology</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Revenue Range</label>
                        <select class="filter-select" id="revenueFilter" onchange="filterClients()">
                            <option value="">All Revenue</option>
                            <option value="0-500">$0 - $500</option>
                            <option value="500-1000">$500 - $1,000</option>
                            <option value="1000+">$1,000+</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Date Range</label>
                        <input type="date" class="form-input" id="dateFrom" onchange="filterClients()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">To</label>
                        <input type="date" class="form-input" id="dateTo" onchange="filterClients()">
                    </div>
                </div>
            </div>

            <div class="bulk-actions">
                <div class="selection-info" id="selectionInfo" style="display: none;">
                    <span id="selectionCount">0</span> selected
                </div>
                <button class="btn btn-primary" onclick="selectAllClients()">Select All</button>
                <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                <div class="dropdown" style="position: relative;">
                    <button class="btn btn-danger" id="bulkActionBtn" disabled>Bulk Actions ▼</button>
                    <div class="dropdown-menu" id="bulkActionMenu" style="display: none;">
                        <a href="#" onclick="bulkDeleteClients(); return false;">🗑️ Delete Selected</a>
                        <a href="#" onclick="bulkExportSelected(); return false;">📥 Export Selected</a>
                        <a href="#" onclick="bulkTagClients(); return false;">🏷️ Add Tag</a>
                        <a href="#" onclick="bulkUpdateStatus(); return false;">✅ Update Status</a>
                    </div>
                </div>
                <div class="export-actions">
                    <button class="btn btn-success" onclick="exportData('clients', 'csv')">📊 Export CSV</button>
                    <button class="btn btn-success" onclick="exportData('clients', 'json')">📄 Export JSON</button>
                </div>
            </div>

            <div class="loading" id="clientsLoading">
                <div class="spinner"></div>
                Loading clients...
            </div>

            <table class="data-table" id="clientsTable" style="display: none;">
                <thead>
                    <tr>
                        <th class="checkbox-column">
                            <input type="checkbox" id="selectAllClients" onchange="toggleAllClients()">
                        </th>
                        <th>Client</th>
                        <th>Industry</th>
                        <th>Status</th>
                        <th>Leads</th>
                        <th>Calls</th>
                        <th>Conversion</th>
                        <th>Revenue</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="clientsBody"></tbody>
            </table>
        </div>

        <!-- Calls Section -->
        <div id="calls" class="content-section">
            <div class="advanced-filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Search</label>
                        <input type="text" class="search-input" id="callSearch" placeholder="Search calls..." onkeyup="searchCalls()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select class="filter-select" id="callStatusFilter" onchange="filterCalls()">
                            <option value="">All Status</option>
                            <option value="completed">Completed</option>
                            <option value="failed">Failed</option>
                            <option value="in_progress">In Progress</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Outcome</label>
                        <select class="filter-select" id="callOutcomeFilter" onchange="filterCalls()">
                            <option value="">All Outcomes</option>
                            <option value="interested">Interested</option>
                            <option value="not_interested">Not Interested</option>
                            <option value="callback_requested">Callback Requested</option>
                            <option value="booked">Booked</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="export-actions">
                <button class="btn btn-success" onclick="exportData('calls', 'csv')">📊 Export CSV</button>
                <button class="btn btn-success" onclick="exportData('calls', 'json')">📄 Export JSON</button>
            </div>

            <div class="loading" id="callsLoading">
                <div class="spinner"></div>
                Loading calls...
            </div>

            <table class="data-table" id="callsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Outcome</th>
                        <th>Duration</th>
                        <th>Quality</th>
                        <th>Sentiment</th>
                        <th>Timestamp</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="callsBody"></tbody>
            </table>
        </div>

        <!-- Reminders Section -->
        <div id="reminders" class="content-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalReminders">-</h3>
                    <p>Total Reminders</p>
                    <div class="trend" id="remindersTrend">↗️ +8%</div>
                </div>
                <div class="stat-card">
                    <h3 id="sentReminders">-</h3>
                    <p>Sent Successfully</p>
                    <div class="trend" id="sentTrend">✅ 95%</div>
                </div>
                <div class="stat-card">
                    <h3 id="pendingReminders">-</h3>
                    <p>Pending</p>
                    <div class="trend" id="pendingTrend">⏰ Active</div>
                </div>
                <div class="stat-card">
                    <h3 id="failedReminders">-</h3>
                    <p>Failed</p>
                    <div class="trend" id="failedTrend">⚠️ 2%</div>
                </div>
            </div>

            <div class="advanced-filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Search</label>
                        <input type="text" class="search-input" id="reminderSearch" placeholder="Search reminders..." onkeyup="searchReminders()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select class="filter-select" id="reminderStatusFilter" onchange="filterReminders()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="sent">Sent</option>
                            <option value="failed">Failed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Type</label>
                        <select class="filter-select" id="reminderTypeFilter" onchange="filterReminders()">
                            <option value="">All Types</option>
                            <option value="confirmation">Confirmation</option>
                            <option value="24hour">24-Hour</option>
                            <option value="1hour">1-Hour</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Client</label>
                        <select class="filter-select" id="reminderClientFilter" onchange="filterReminders()">
                            <option value="">All Clients</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="export-actions">
                <button class="btn btn-success" onclick="exportData('reminders', 'csv')">📊 Export CSV</button>
                <button class="btn btn-success" onclick="exportData('reminders', 'json')">📄 Export JSON</button>
                <button class="btn btn-primary" onclick="sendPendingReminders()">📤 Send Pending</button>
            </div>

            <div class="loading" id="remindersLoading">
                <div class="spinner"></div>
                Loading reminders...
            </div>

            <table class="data-table" id="remindersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Client</th>
                        <th>Phone</th>
                        <th>Type</th>
                        <th>Appointment Time</th>
                        <th>Scheduled For</th>
                        <th>Status</th>
                        <th>Sent At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="remindersBody"></tbody>
            </table>
        </div>

        <!-- Lead Scoring Section -->
        <div id="leads" class="content-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalLeads">-</h3>
                    <p>Total Leads</p>
                    <div class="trend" id="leadsTrend">↗️ +15%</div>
                </div>
                <div class="stat-card">
                    <h3 id="highScoreLeads">-</h3>
                    <p>High Score (80+)</p>
                    <div class="trend" id="highScoreTrend">🎯 25%</div>
                </div>
                <div class="stat-card">
                    <h3 id="avgScore">-</h3>
                    <p>Average Score</p>
                    <div class="trend" id="avgScoreTrend">📊 65</div>
                </div>
                <div class="stat-card">
                    <h3 id="conversionProb">-</h3>
                    <p>Avg Conversion</p>
                    <div class="trend" id="conversionTrend">📈 45%</div>
                </div>
            </div>

            <div class="advanced-filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="filter-label">Search</label>
                        <input type="text" class="search-input" id="leadSearch" placeholder="Search leads..." onkeyup="searchLeads()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Score Range</label>
                        <select class="filter-select" id="scoreRangeFilter" onchange="filterLeads()">
                            <option value="">All Scores</option>
                            <option value="high">High (80-100)</option>
                            <option value="medium">Medium (50-79)</option>
                            <option value="low">Low (0-49)</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Sort By</label>
                        <select class="filter-select" id="leadSortFilter" onchange="sortLeads()">
                            <option value="score">Score</option>
                            <option value="engagement_score">Engagement</option>
                            <option value="conversion_probability">Conversion Prob</option>
                            <option value="created_at">Date Created</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Source</label>
                        <select class="filter-select" id="sourceFilter" onchange="filterLeads()">
                            <option value="">All Sources</option>
                            <option value="website">Website</option>
                            <option value="referral">Referral</option>
                            <option value="social">Social Media</option>
                            <option value="cold">Cold Lead</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="export-actions">
                <button class="btn btn-success" onclick="exportData('leads', 'csv')">📊 Export CSV</button>
                <button class="btn btn-success" onclick="exportData('leads', 'json')">📄 Export JSON</button>
                <button class="btn btn-primary" onclick="updateAllScores()">🔄 Update All Scores</button>
                <button class="btn btn-warning" onclick="showScoringRules()">⚙️ Manage Rules</button>
            </div>

            <div class="loading" id="leadsLoading">
                <div class="spinner"></div>
                Loading leads...
            </div>

            <table class="data-table" id="leadsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Source</th>
                        <th>Score</th>
                        <th>Engagement</th>
                        <th>Conversion %</th>
                        <th>Calls</th>
                        <th>SMS</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="leadsBody"></tbody>
            </table>
        </div>

        <!-- Appointments Section -->
        <div id="appointments" class="content-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalAppointments">-</h3>
                    <p>Total Appointments</p>
                    <div class="trend" id="appointmentsTrend">📅 Active</div>
                </div>
                <div class="stat-card">
                    <h3 id="completedAppointments">-</h3>
                    <p>Completed</p>
                    <div class="trend" id="completedTrend">✅ 85%</div>
                </div>
                <div class="stat-card">
                    <h3 id="noShowRate">-</h3>
                    <p>No-Show Rate</p>
                    <div class="trend" id="noShowTrend">⚠️ 12%</div>
                </div>
                <div class="stat-card">
                    <h3 id="totalRevenue">-</h3>
                    <p>Total Revenue</p>
                    <div class="trend" id="revenueTrend">💰 £2,450</div>
                </div>
            </div>

            <div class="tabs-container">
                <button class="tab-btn active" onclick="showAppointmentTab('overview')">📊 Overview</button>
                <button class="tab-btn" onclick="showAppointmentTab('funnel')">🔄 Funnel</button>
                <button class="tab-btn" onclick="showAppointmentTab('insights')">💡 Insights</button>
                <button class="tab-btn" onclick="showAppointmentTab('list')">📋 List</button>
            </div>

            <!-- Appointment Overview Tab -->
            <div id="appointmentOverview" class="appointment-tab">
                <div class="chart-container">
                    <div class="chart-title">Hourly Distribution</div>
                    <canvas id="hourlyChart" width="400" height="200"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Daily Distribution</div>
                    <canvas id="dailyChart" width="400" height="200"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Performance Metrics</div>
                    <div id="performanceMetrics" class="metrics-grid">
                        <div class="metric-item">
                            <span class="metric-label">Peak Hours (9-17)</span>
                            <span class="metric-value" id="peakHourCount">-</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Off-Peak Hours</span>
                            <span class="metric-value" id="offPeakCount">-</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Weekend Appointments</span>
                            <span class="metric-value" id="weekendCount">-</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Avg Duration</span>
                            <span class="metric-value" id="avgDuration">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appointment Funnel Tab -->
            <div id="appointmentFunnel" class="appointment-tab" style="display: none;">
                <div class="chart-container">
                    <div class="chart-title">Conversion Funnel</div>
                    <canvas id="funnelChart" width="400" height="300"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Daily Funnel Trends</div>
                    <canvas id="funnelTrendsChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Appointment Insights Tab -->
            <div id="appointmentInsights" class="appointment-tab" style="display: none;">
                <div class="insights-panel">
                    <h3>🎯 AI-Powered Insights</h3>
                    <div id="insightsContent">
                        <div class="loading">Loading insights...</div>
                    </div>
                </div>

                <div class="recommendations-panel">
                    <h3>💡 Recommendations</h3>
                    <div id="recommendationsContent">
                        <div class="loading">Loading recommendations...</div>
                    </div>
                </div>
            </div>

            <!-- Appointment List Tab -->
            <div id="appointmentList" class="appointment-tab" style="display: none;">
                <div class="advanced-filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="filter-label">Search</label>
                            <input type="text" class="search-input" id="appointmentSearch" placeholder="Search appointments..." onkeyup="searchAppointments()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Status</label>
                            <select class="filter-select" id="appointmentStatusFilter" onchange="filterAppointments()">
                                <option value="">All Status</option>
                                <option value="scheduled">Scheduled</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="completed">Completed</option>
                                <option value="no_show">No Show</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="rescheduled">Rescheduled</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Date Range</label>
                            <input type="date" class="filter-select" id="appointmentDateFrom" onchange="filterAppointments()">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">To</label>
                            <input type="date" class="filter-select" id="appointmentDateTo" onchange="filterAppointments()">
                        </div>
                    </div>
                </div>

                <div class="export-actions">
                    <button class="btn btn-success" onclick="exportData('appointments', 'csv')">📊 Export CSV</button>
                    <button class="btn btn-success" onclick="exportData('appointments', 'json')">📄 Export JSON</button>
                    <button class="btn btn-primary" onclick="updateFunnel()">🔄 Update Funnel</button>
                </div>

                <div class="loading" id="appointmentsLoading">
                    <div class="spinner"></div>
                    Loading appointments...
                </div>

                <table class="data-table" id="appointmentsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Lead</th>
                            <th>Appointment Time</th>
                            <th>Duration</th>
                            <th>Status</th>
                            <th>Outcome</th>
                            <th>Revenue</th>
                            <th>Service</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics" class="content-section">
            <div class="tabs-container">
                <button class="tab-btn active" onclick="showAnalyticsTab('overview')">Overview</button>
                <button class="tab-btn" onclick="showAnalyticsTab('trends')">Trends</button>
                <button class="tab-btn" onclick="showAnalyticsTab('performance')">Performance</button>
            </div>

            <div id="analyticsOverview" class="analytics-tab">
                <div class="chart-container">
                    <div class="chart-title">Conversion Funnel</div>
                    <canvas id="funnelChart" width="400" height="200"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Peak Hours Analysis</div>
                    <canvas id="peakHoursChart" width="400" height="200"></canvas>
                </div>
            </div>

            <div id="analyticsTrends" class="analytics-tab" style="display: none;">
                <div class="chart-container">
                    <div class="chart-title">Daily Trends (Last 30 Days)</div>
                    <canvas id="trendsChart" width="400" height="200"></canvas>
                </div>
            </div>

            <div id="analyticsPerformance" class="analytics-tab" style="display: none;">
                <div class="chart-container">
                    <div class="chart-title">Client Performance Comparison</div>
                    <canvas id="clientComparisonChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- AI Insights Section -->
        <div id="insights" class="content-section">
            <div class="insights-panel">
                <h3>🧠 AI-Powered Insights</h3>
                <p>Automated analysis and recommendations based on your data patterns.</p>
            </div>

            <div id="insightsContainer">
                <div class="loading" id="insightsLoading">
                    <div class="spinner"></div>
                    Analyzing data for insights...
                </div>
            </div>
        </div>

        <!-- Forecasts Section -->
        <div id="forecasts" class="content-section">
            <div class="forecast-card">
                <h4>🔮 Revenue Forecasts</h4>
                <p>AI-powered predictions based on historical data and trends.</p>
            </div>

            <div id="forecastsContainer">
                <div class="loading" id="forecastsLoading">
                    <div class="spinner"></div>
                    Generating forecasts...
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="content-section">
            <div class="bulk-actions">
                <button class="btn btn-success" onclick="showAddUserModal()">➕ Add User</button>
            </div>

            <div class="loading" id="usersLoading">
                <div class="spinner"></div>
                Loading users...
            </div>

            <table class="data-table" id="usersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Created</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersBody"></tbody>
            </table>
        </div>

        <!-- System Section -->
        <div id="system" class="content-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="systemStatus">-</h3>
                    <p>System Status</p>
                </div>
                <div class="stat-card">
                    <h3 id="systemUptime">-</h3>
                    <p>Uptime</p>
                </div>
                <div class="stat-card">
                    <h3 id="systemResponseTime">-</h3>
                    <p>Response Time</p>
                </div>
                <div class="stat-card">
                    <h3 id="systemErrors">-</h3>
                    <p>Recent Errors</p>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">System Health Timeline</div>
                <canvas id="healthChart" width="400" height="200"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-title">Memory Usage</div>
                <canvas id="memoryChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add New Client</div>
                <button class="close-btn" onclick="closeAddClientModal()">&times;</button>
            </div>
            <form id="addClientForm">
                <div class="form-group">
                    <label class="form-label">Client Name</label>
                    <input type="text" class="form-input" id="clientName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Industry</label>
                    <select class="form-input" id="clientIndustry">
                        <option value="Healthcare">Healthcare</option>
                        <option value="Legal">Legal</option>
                        <option value="Fitness">Fitness</option>
                        <option value="Wellness">Wellness</option>
                        <option value="Technology">Technology</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="clientEmail">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="clientPhone">
                </div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <input type="text" class="form-input" id="clientAddress">
                </div>
                <div class="form-group">
                    <label class="form-label">Website</label>
                    <input type="url" class="form-input" id="clientWebsite">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="clientDescription" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Timezone</label>
                    <select class="form-input" id="clientTimezone">
                        <option value="Europe/London">Europe/London</option>
                        <option value="America/New_York">America/New_York</option>
                        <option value="America/Los_Angeles">America/Los_Angeles</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeAddClientModal()" style="background: #e2e8f0; color: #4a5568;">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Add New User</div>
                <button class="close-btn" onclick="closeAddUserModal()">&times;</button>
            </div>
            <form id="addUserForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-input" id="userRole" required>
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                        <option value="operator">Operator</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="userPassword" required>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeAddUserModal()" style="background: #e2e8f0; color: #4a5568;">Cancel</button>
                    <button type="submit" class="btn btn-success">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Notifications</div>
                <button class="close-btn" onclick="closeNotificationsModal()">&times;</button>
            </div>
            <div id="notificationsContainer">
                <div class="loading" id="notificationsLoading">
                    <div class="spinner"></div>
                    Loading notifications...
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        let socket = null;
        let charts = {};
        let selectedClients = new Set();
        let currentAnalyticsTab = 'overview';

        // Initialize WebSocket connection
        function initWebSocket() {
            socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to WebSocket server');
                socket.emit('request-update', 'all');
            });
            
            socket.on('data-update', (data) => {
                console.log('Received data update:', data.type);
                showRealtimeIndicator();
                handleDataUpdate(data.type, data.data);
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from WebSocket server');
            });
            
            socket.on('error', (error) => {
                console.error('WebSocket error:', error);
            });
        }

        // Show real-time update indicator
        function showRealtimeIndicator() {
            const indicator = document.getElementById('realtimeIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 3000);
        }

        // Handle data updates from WebSocket
        function handleDataUpdate(type, data) {
            switch(type) {
                case 'all':
                    updateOverview(data.businessStats);
                    updateClientsTable(data.clients);
                    updateCallsTable(data.calls);
                    updateAnalytics(data.analytics);
                    updateSystemHealth(data.systemHealth);
                    break;
                case 'business-stats':
                    updateOverview(data);
                    break;
                case 'clients':
                    updateClientsTable(data);
                    break;
                case 'calls':
                    updateCallsTable(data);
                    break;
                case 'analytics':
                    updateAnalytics(data);
                    break;
                case 'system-health':
                    updateSystemHealth(data);
                    break;
            }
        }

        // Update overview section
        function updateOverview(data) {
            document.getElementById('activeClients').textContent = data.activeClients || 0;
            document.getElementById('monthlyRevenue').textContent = `£${data.monthlyRevenue || 0}`;
            document.getElementById('totalCalls').textContent = data.totalCalls || 0;
            document.getElementById('conversionRate').textContent = `${data.conversionRate || 0}%`;
        }

        // Update clients table
        function updateClientsTable(data) {
            const loading = document.getElementById('clientsLoading');
            const table = document.getElementById('clientsTable');
            const body = document.getElementById('clientsBody');
            
            loading.style.display = 'none';
            table.style.display = 'table';
            
            body.innerHTML = data.map(client => `
                <tr>
                    <td class="checkbox-column">
                        <input type="checkbox" class="client-checkbox" value="${client.clientKey}" onchange="toggleClientSelection('${client.clientKey}')">
                    </td>
                    <td>
                        <strong>${client.name}</strong><br>
                        <small>${client.email}</small>
                    </td>
                    <td>${client.industry}</td>
                    <td><span class="status-badge status-${client.status}">${client.status}</span></td>
                    <td>${client.leadCount}</td>
                    <td>${client.callCount}</td>
                    <td>${client.conversionRate}%</td>
                    <td>£${client.monthlyRevenue}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewClient('${client.clientKey}')">View</button>
                        <button class="btn btn-success" onclick="editClient('${client.clientKey}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteClient('${client.clientKey}', '${client.name}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Update calls table with enhanced data
        function updateCallsTable(data) {
            const loading = document.getElementById('callsLoading');
            const table = document.getElementById('callsTable');
            const body = document.getElementById('callsBody');
            
            loading.style.display = 'none';
            table.style.display = 'table';
            
            body.innerHTML = data.recentCalls.map(call => `
                <tr>
                    <td>${call.client}</td>
                    <td>${call.phone}</td>
                    <td><span class="status-badge status-${call.status}">${call.status}</span></td>
                    <td>${call.outcome || 'N/A'}</td>
                    <td>${call.duration}</td>
                    <td>${call.quality_score || 'N/A'}</td>
                    <td>${call.sentiment || 'N/A'}</td>
                    <td>${new Date(call.timestamp).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewCallDetails('${call.phone}')">Details</button>
                    </td>
                </tr>
            `).join('');
        }

        // Update analytics charts
        function updateAnalytics(data) {
            // Update funnel chart
            if (charts.funnel) {
                charts.funnel.destroy();
            }
            const funnelCtx = document.getElementById('funnelChart').getContext('2d');
            charts.funnel = new Chart(funnelCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Leads', 'Calls', 'Bookings'],
                    datasets: [{
                        data: [data.conversionFunnel.leads, data.conversionFunnel.calls, data.conversionFunnel.bookings],
                        backgroundColor: ['#667eea', '#764ba2', '#48bb78']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Update peak hours chart
            if (charts.peakHours) {
                charts.peakHours.destroy();
            }
            const peakHoursCtx = document.getElementById('peakHoursChart').getContext('2d');
            charts.peakHours = new Chart(peakHoursCtx, {
                type: 'bar',
                data: {
                    labels: data.peakHours,
                    datasets: [{
                        label: 'Call Volume',
                        data: data.peakHours.map(() => Math.floor(Math.random() * 50) + 10),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update system health
        function updateSystemHealth(data) {
            document.getElementById('systemStatus').textContent = data.status || 'healthy';
            document.getElementById('systemUptime').textContent = `${data.uptime || 99.9}%`;
            document.getElementById('systemResponseTime').textContent = `${data.responseTime || 120}ms`;
            document.getElementById('systemErrors').textContent = data.recentErrors?.length || 0;
        }

        // Load advanced analytics
        async function loadAdvancedAnalytics() {
            try {
                const response = await fetch('/api/admin/analytics/advanced?period=30d');
                const data = await response.json();
                
                // Update insights
                updateInsights(data.insights);
                
                // Update forecasts
                updateForecasts(data.forecasts);
                
                // Update trends chart
                updateTrendsChart(data.trends);
                
            } catch (error) {
                console.error('Error loading advanced analytics:', error);
            }
        }

        // Update insights
        function updateInsights(insights) {
            const container = document.getElementById('insightsContainer');
            const loading = document.getElementById('insightsLoading');
            
            loading.style.display = 'none';
            
            if (insights.length === 0) {
                container.innerHTML = '<div class="insight-item">No insights available at this time.</div>';
                return;
            }
            
            container.innerHTML = insights.map(insight => `
                <div class="insight-item insight-priority-${insight.priority}">
                    <h4>${insight.type.replace('_', ' ').toUpperCase()}</h4>
                    <p><strong>${insight.clientName}:</strong> ${insight.message}</p>
                    <p><em>Recommendation:</em> ${insight.recommendation}</p>
                </div>
            `).join('');
        }

        // Update forecasts
        function updateForecasts(forecasts) {
            const container = document.getElementById('forecastsContainer');
            const loading = document.getElementById('forecastsLoading');
            
            loading.style.display = 'none';
            
            container.innerHTML = forecasts.map(forecast => `
                <div class="forecast-card">
                    <h4>${forecast.clientName}</h4>
                    <div class="forecast-metrics">
                        <div class="forecast-metric">
                            <div class="value">${forecast.forecastCalls}</div>
                            <div class="label">Forecast Calls</div>
                        </div>
                        <div class="forecast-metric">
                            <div class="value">${forecast.forecastBookings}</div>
                            <div class="label">Forecast Bookings</div>
                        </div>
                        <div class="forecast-metric">
                            <div class="value">£${forecast.forecastRevenue}</div>
                            <div class="label">Forecast Revenue</div>
                        </div>
                        <div class="forecast-metric">
                            <div class="value">${forecast.confidence}%</div>
                            <div class="label">Confidence</div>
                        </div>
                    </div>
                    <p>Growth Rate: ${forecast.growthRate > 0 ? '+' : ''}${forecast.growthRate}%</p>
                </div>
            `).join('');
        }

        // Update trends chart
        function updateTrendsChart(trends) {
            if (charts.trends) {
                charts.trends.destroy();
            }
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            charts.trends = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: trends.map(t => t.date),
                    datasets: [
                        {
                            label: 'Leads',
                            data: trends.map(t => t.leads),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Calls',
                            data: trends.map(t => t.calls),
                            borderColor: '#764ba2',
                            backgroundColor: 'rgba(118, 75, 162, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Bookings',
                            data: trends.map(t => t.bookings),
                            borderColor: '#48bb78',
                            backgroundColor: 'rgba(72, 187, 120, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const users = await response.json();
                
                const loading = document.getElementById('usersLoading');
                const table = document.getElementById('usersTable');
                const body = document.getElementById('usersBody');
                
                loading.style.display = 'none';
                table.style.display = 'table';
                
                body.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td><span class="status-badge status-${user.role}">${user.role}</span></td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editUser('${user.id}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteUser('${user.id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch('/api/admin/notifications');
                const notifications = await response.json();
                
                const container = document.getElementById('notificationsContainer');
                const loading = document.getElementById('notificationsLoading');
                
                loading.style.display = 'none';
                
                if (notifications.length === 0) {
                    container.innerHTML = '<div class="insight-item">No new notifications.</div>';
                    return;
                }
                
                container.innerHTML = notifications.map(notification => `
                    <div class="insight-item">
                        <h4>${notification.title}</h4>
                        <p>${notification.message}</p>
                        <small>${new Date(notification.created_at).toLocaleString()}</small>
                        <button class="btn btn-primary" onclick="markNotificationRead('${notification.id}')">Mark as Read</button>
                    </div>
                `).join('');
                
                // Update notification badge
                document.getElementById('notificationBtn').setAttribute('data-count', notifications.length);
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Navigation functions
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load section data
            loadSectionData(sectionName);
        }

        // Load data for specific section
        function loadSectionData(sectionName) {
            // Always use API calls for reliability
            switch(sectionName) {
                case 'overview':
                    loadOverview();
                    break;
                case 'clients':
                    loadClients();
                    break;
                case 'calls':
                    loadCalls();
                    break;
                case 'reminders':
                    loadReminders();
                    break;
                case 'leads':
                    loadLeads();
                    break;
                case 'appointments':
                    loadAppointments();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'insights':
                    loadAdvancedAnalytics();
                    break;
                case 'forecasts':
                    loadAdvancedAnalytics();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'system':
                    loadSystemHealth();
                    break;
            }
            
            // Also request real-time update if socket is connected
            if (socket && socket.connected) {
                socket.emit('request-update', sectionName);
            }
        }

        // Analytics tab switching
        function showAnalyticsTab(tabName) {
            // Hide all analytics tabs
            document.querySelectorAll('.analytics-tab').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`analytics${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).style.display = 'block';
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            currentAnalyticsTab = tabName;
        }

        // Fallback API functions
        async function loadOverview() {
            try {
                const response = await fetch('/api/admin/business-stats');
                const data = await response.json();
                updateOverview(data);
            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }

        async function loadClients() {
            try {
                const response = await fetch('/api/admin/clients');
                const data = await response.json();
                updateClientsTable(data);
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }

        async function loadCalls() {
            try {
                const response = await fetch('/api/admin/calls');
                const data = await response.json();
                updateCallsTable(data);
            } catch (error) {
                console.error('Error loading calls:', error);
            }
        }

        async function loadReminders() {
            try {
                const response = await fetch('/api/admin/reminders');
                const data = await response.json();
                updateRemindersTable(data);
                
                // Load stats
                const statsResponse = await fetch('/api/admin/reminders/stats');
                const stats = await statsResponse.json();
                updateRemindersStats(stats);
                
                // Populate client filter
                populateReminderClientFilter();
            } catch (error) {
                console.error('Error loading reminders:', error);
            }
        }

        function updateRemindersStats(stats) {
            document.getElementById('totalReminders').textContent = stats.total || 0;
            document.getElementById('sentReminders').textContent = stats.sent || 0;
            document.getElementById('pendingReminders').textContent = stats.pending || 0;
            document.getElementById('failedReminders').textContent = stats.failed || 0;
            
            // Update trends
            document.getElementById('sentTrend').textContent = `✅ ${stats.successRate}%`;
            document.getElementById('pendingTrend').textContent = stats.pending > 0 ? '⏰ Active' : '✅ Complete';
            document.getElementById('failedTrend').textContent = `⚠️ ${stats.failed} failed`;
        }

        function updateRemindersTable(reminders) {
            const tbody = document.getElementById('remindersBody');
            const table = document.getElementById('remindersTable');
            const loading = document.getElementById('remindersLoading');
            
            if (reminders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #718096;">No reminders found</td></tr>';
            } else {
                tbody.innerHTML = reminders.map(reminder => `
                    <tr>
                        <td>${reminder.clientName || reminder.clientKey}</td>
                        <td>${reminder.leadPhone}</td>
                        <td>
                            <span class="status-badge ${getReminderTypeClass(reminder.reminderType)}">
                                ${getReminderTypeLabel(reminder.reminderType)}
                            </span>
                        </td>
                        <td>${formatDateTime(reminder.appointmentTime)}</td>
                        <td>${formatDateTime(reminder.scheduledFor)}</td>
                        <td>
                            <span class="status-badge ${getReminderStatusClass(reminder.status)}">
                                ${reminder.status}
                            </span>
                        </td>
                        <td>${reminder.sentAt ? formatDateTime(reminder.sentAt) : '-'}</td>
                        <td>
                            <div class="action-buttons">
                                ${reminder.status === 'pending' ? 
                                    `<button class="btn btn-sm btn-primary" onclick="sendReminder(${reminder.id})">📤 Send</button>` : 
                                    ''
                                }
                                ${reminder.status === 'pending' || reminder.status === 'failed' ? 
                                    `<button class="btn btn-sm btn-danger" onclick="cancelReminder(${reminder.id})">❌ Cancel</button>` : 
                                    ''
                                }
                                ${reminder.smsSid ? 
                                    `<button class="btn btn-sm btn-success" onclick="viewSMS('${reminder.smsSid}')">📱 View SMS</button>` : 
                                    ''
                                }
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            
            loading.style.display = 'none';
            table.style.display = 'table';
        }

        function getReminderTypeClass(type) {
            switch(type) {
                case 'confirmation': return 'status-active';
                case '24hour': return 'status-pending';
                case '1hour': return 'status-pending';
                default: return 'status-inactive';
            }
        }

        function getReminderTypeLabel(type) {
            switch(type) {
                case 'confirmation': return 'Confirmation';
                case '24hour': return '24-Hour';
                case '1hour': return '1-Hour';
                default: return type;
            }
        }

        function getReminderStatusClass(status) {
            switch(status) {
                case 'sent': return 'status-active';
                case 'pending': return 'status-pending';
                case 'failed': return 'status-inactive';
                case 'cancelled': return 'status-inactive';
                default: return 'status-inactive';
            }
        }

        async function sendReminder(reminderId) {
            try {
                const response = await fetch('/api/admin/reminders/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reminderId })
                });
                
                if (response.ok) {
                    showNotification('Reminder sent successfully!', 'success');
                    loadReminders(); // Refresh data
                } else {
                    const error = await response.json();
                    showNotification(`Failed to send reminder: ${error.error}`, 'error');
                }
            } catch (error) {
                showNotification(`Error sending reminder: ${error.message}`, 'error');
            }
        }

        async function cancelReminder(reminderId) {
            if (!confirm('Are you sure you want to cancel this reminder?')) return;
            
            try {
                const response = await fetch(`/api/admin/reminders/${reminderId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification('Reminder cancelled successfully!', 'success');
                    loadReminders(); // Refresh data
                } else {
                    const error = await response.json();
                    showNotification(`Failed to cancel reminder: ${error.error}`, 'error');
                }
            } catch (error) {
                showNotification(`Error cancelling reminder: ${error.message}`, 'error');
            }
        }

        async function sendPendingReminders() {
            if (!confirm('Send all pending reminders now?')) return;
            
            try {
                const response = await fetch('/api/admin/reminders/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reminderId: 'all' })
                });
                
                if (response.ok) {
                    showNotification('All pending reminders sent!', 'success');
                    loadReminders(); // Refresh data
                } else {
                    const error = await response.json();
                    showNotification(`Failed to send reminders: ${error.error}`, 'error');
                }
            } catch (error) {
                showNotification(`Error sending reminders: ${error.message}`, 'error');
            }
        }

        function searchReminders() {
            const searchTerm = document.getElementById('reminderSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#remindersBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filterReminders() {
            const statusFilter = document.getElementById('reminderStatusFilter').value;
            const typeFilter = document.getElementById('reminderTypeFilter').value;
            const clientFilter = document.getElementById('reminderClientFilter').value;
            
            const rows = document.querySelectorAll('#remindersBody tr');
            
            rows.forEach(row => {
                const statusBadge = row.querySelector('.status-badge');
                const typeBadge = row.cells[2].querySelector('.status-badge');
                const clientName = row.cells[0].textContent;
                
                let show = true;
                
                if (statusFilter && statusBadge.textContent.toLowerCase() !== statusFilter.toLowerCase()) {
                    show = false;
                }
                
                if (typeFilter && typeBadge.textContent.toLowerCase() !== typeFilter.toLowerCase()) {
                    show = false;
                }
                
                if (clientFilter && !clientName.toLowerCase().includes(clientFilter.toLowerCase())) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }

        async function populateReminderClientFilter() {
            try {
                const response = await fetch('/api/admin/clients');
                const clients = await response.json();
                
                const select = document.getElementById('reminderClientFilter');
                select.innerHTML = '<option value="">All Clients</option>';
                
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.name;
                    option.textContent = client.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error populating client filter:', error);
            }
        }

        function viewSMS(smsSid) {
            // Open Twilio console or show SMS details
            window.open(`https://console.twilio.com/us1/monitor/logs/messages/${smsSid}`, '_blank');
        }

        async function loadLeads() {
            try {
                const response = await fetch('/api/admin/leads/scoring');
                const data = await response.json();
                updateLeadsTable(data);
                
                // Load analytics
                const analyticsResponse = await fetch('/api/admin/leads/scoring/analytics');
                const analytics = await analyticsResponse.json();
                updateLeadsStats(analytics);
            } catch (error) {
                console.error('Error loading leads:', error);
            }
        }

        function updateLeadsStats(analytics) {
            document.getElementById('totalLeads').textContent = analytics.totalLeads || 0;
            document.getElementById('highScoreLeads').textContent = analytics.highScoreLeads || 0;
            document.getElementById('avgScore').textContent = Math.round(analytics.avgScore) || 0;
            document.getElementById('conversionProb').textContent = Math.round(analytics.avgConversionProb) + '%';
            
            // Update trends
            document.getElementById('highScoreTrend').textContent = `🎯 ${analytics.highScorePercentage}%`;
            document.getElementById('avgScoreTrend').textContent = `📊 ${Math.round(analytics.avgScore)}`;
            document.getElementById('conversionTrend').textContent = `📈 ${Math.round(analytics.avgConversionProb)}%`;
        }

        function updateLeadsTable(leads) {
            const tbody = document.getElementById('leadsBody');
            const table = document.getElementById('leadsTable');
            const loading = document.getElementById('leadsLoading');
            
            if (leads.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #718096;">No leads found</td></tr>';
            } else {
                tbody.innerHTML = leads.map(lead => `
                    <tr>
                        <td>
                            <div class="lead-name">
                                <strong>${lead.name || 'Unknown'}</strong>
                                ${lead.email ? `<br><small>${lead.email}</small>` : ''}
                            </div>
                        </td>
                        <td>${lead.phone || '-'}</td>
                        <td>
                            <span class="status-badge ${getSourceClass(lead.source)}">
                                ${lead.source || 'Unknown'}
                            </span>
                        </td>
                        <td>
                            <div class="score-display">
                                <span class="score-value ${getScoreClass(lead.score)}">${lead.score}</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${lead.score}%"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="engagement-score ${getEngagementClass(lead.engagementScore)}">
                                ${lead.engagementScore}
                            </span>
                        </td>
                        <td>
                            <span class="conversion-prob ${getConversionClass(lead.conversionProbability)}">
                                ${Math.round(lead.conversionProbability)}%
                            </span>
                        </td>
                        <td>${lead.callCount}</td>
                        <td>${lead.smsCount}</td>
                        <td>${formatDate(lead.createdAt)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="updateLeadScore(${lead.id})">🔄 Update</button>
                                <button class="btn btn-sm btn-success" onclick="viewLeadHistory(${lead.id})">📊 History</button>
                                <button class="btn btn-sm btn-warning" onclick="viewScoreFactors(${lead.id})">🔍 Factors</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            
            loading.style.display = 'none';
            table.style.display = 'table';
        }

        function getSourceClass(source) {
            switch(source?.toLowerCase()) {
                case 'website': return 'status-active';
                case 'referral': return 'status-active';
                case 'social': return 'status-pending';
                case 'cold': return 'status-inactive';
                default: return 'status-inactive';
            }
        }

        function getScoreClass(score) {
            if (score >= 80) return 'score-high';
            if (score >= 50) return 'score-medium';
            return 'score-low';
        }

        function getEngagementClass(score) {
            if (score >= 70) return 'engagement-high';
            if (score >= 40) return 'engagement-medium';
            return 'engagement-low';
        }

        function getConversionClass(prob) {
            if (prob >= 60) return 'conversion-high';
            if (prob >= 30) return 'conversion-medium';
            return 'conversion-low';
        }

        async function updateLeadScore(leadId) {
            try {
                const response = await fetch(`/api/admin/leads/${leadId}/score`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    showNotification('Lead score updated successfully!', 'success');
                    loadLeads(); // Refresh data
                } else {
                    const error = await response.json();
                    showNotification(`Failed to update score: ${error.error}`, 'error');
                }
            } catch (error) {
                showNotification(`Error updating score: ${error.message}`, 'error');
            }
        }

        async function updateAllScores() {
            if (!confirm('Update scores for all leads? This may take a moment.')) return;
            
            try {
                const response = await fetch('/api/admin/leads/scoring/update-all', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(`Updated scores for ${result.updatedCount} leads!`, 'success');
                    loadLeads(); // Refresh data
                } else {
                    const error = await response.json();
                    showNotification(`Failed to update scores: ${error.error}`, 'error');
                }
            } catch (error) {
                showNotification(`Error updating scores: ${error.message}`, 'error');
            }
        }

        async function viewLeadHistory(leadId) {
            try {
                const response = await fetch(`/api/admin/leads/scoring/history/${leadId}`);
                const history = await response.json();
                
                // Create modal to show history
                showScoringHistoryModal(leadId, history);
            } catch (error) {
                showNotification(`Error loading history: ${error.message}`, 'error');
            }
        }

        function viewScoreFactors(leadId) {
            // Find the lead in the current data and show factors
            const leadRow = document.querySelector(`tr[data-lead-id="${leadId}"]`);
            if (leadRow) {
                // Extract score factors from data attribute or make API call
                showScoreFactorsModal(leadId);
            }
        }

        function showScoringRules() {
            // Open scoring rules management modal
            showScoringRulesModal();
        }

        function searchLeads() {
            const searchTerm = document.getElementById('leadSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#leadsBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filterLeads() {
            const scoreFilter = document.getElementById('scoreRangeFilter').value;
            const sourceFilter = document.getElementById('sourceFilter').value;
            
            const rows = document.querySelectorAll('#leadsBody tr');
            
            rows.forEach(row => {
                const scoreValue = parseInt(row.cells[3].querySelector('.score-value').textContent);
                const sourceBadge = row.cells[2].querySelector('.status-badge').textContent.toLowerCase();
                
                let show = true;
                
                if (scoreFilter) {
                    switch(scoreFilter) {
                        case 'high':
                            if (scoreValue < 80) show = false;
                            break;
                        case 'medium':
                            if (scoreValue < 50 || scoreValue >= 80) show = false;
                            break;
                        case 'low':
                            if (scoreValue >= 50) show = false;
                            break;
                    }
                }
                
                if (sourceFilter && !sourceBadge.includes(sourceFilter.toLowerCase())) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }

        function sortLeads() {
            const sortBy = document.getElementById('leadSortFilter').value;
            const tbody = document.getElementById('leadsBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                let aValue, bValue;
                
                switch(sortBy) {
                    case 'score':
                        aValue = parseInt(a.cells[3].querySelector('.score-value').textContent);
                        bValue = parseInt(b.cells[3].querySelector('.score-value').textContent);
                        break;
                    case 'engagement_score':
                        aValue = parseInt(a.cells[4].querySelector('.engagement-score').textContent);
                        bValue = parseInt(b.cells[4].querySelector('.engagement-score').textContent);
                        break;
                    case 'conversion_probability':
                        aValue = parseInt(a.cells[5].querySelector('.conversion-prob').textContent);
                        bValue = parseInt(b.cells[5].querySelector('.conversion-prob').textContent);
                        break;
                    case 'created_at':
                        aValue = new Date(a.cells[8].textContent);
                        bValue = new Date(b.cells[8].textContent);
                        break;
                    default:
                        return 0;
                }
                
                return bValue - aValue; // Descending order
            });
            
            // Re-append sorted rows
            rows.forEach(row => tbody.appendChild(row));
        }

        async function loadAppointments() {
            try {
                const response = await fetch('/api/admin/appointments/analytics');
                const data = await response.json();
                updateAppointmentStats(data.metrics);
                updateAppointmentCharts(data);
                loadAppointmentInsights();
            } catch (error) {
                console.error('Error loading appointments:', error);
            }
        }

        function updateAppointmentStats(metrics) {
            document.getElementById('totalAppointments').textContent = metrics.totalAppointments || 0;
            document.getElementById('completedAppointments').textContent = metrics.completedAppointments || 0;
            document.getElementById('noShowRate').textContent = (metrics.noShowRate || 0).toFixed(1) + '%';
            document.getElementById('totalRevenue').textContent = '£' + (metrics.totalRevenue || 0).toFixed(0);
            
            // Update trends
            document.getElementById('completedTrend').textContent = `✅ ${(metrics.completionRate || 0).toFixed(1)}%`;
            document.getElementById('noShowTrend').textContent = `⚠️ ${(metrics.noShowRate || 0).toFixed(1)}%`;
            document.getElementById('revenueTrend').textContent = `💰 £${(metrics.totalRevenue || 0).toFixed(0)}`;
            
            // Update performance metrics
            document.getElementById('peakHourCount').textContent = metrics.peakHourAppointments || 0;
            document.getElementById('offPeakCount').textContent = metrics.offPeakAppointments || 0;
            document.getElementById('weekendCount').textContent = metrics.weekendAppointments || 0;
            document.getElementById('avgDuration').textContent = (metrics.avgDuration || 0).toFixed(0) + ' min';
        }

        function updateAppointmentCharts(data) {
            // Hourly Distribution Chart
            const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
            new Chart(hourlyCtx, {
                type: 'bar',
                data: {
                    labels: data.hourlyDistribution.map(h => h.hour + ':00'),
                    datasets: [{
                        label: 'Total Appointments',
                        data: data.hourlyDistribution.map(h => h.totalAppointments),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Completed',
                        data: data.hourlyDistribution.map(h => h.completed),
                        backgroundColor: 'rgba(72, 187, 120, 0.6)',
                        borderColor: 'rgba(72, 187, 120, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Daily Distribution Chart
            const dailyCtx = document.getElementById('dailyChart').getContext('2d');
            new Chart(dailyCtx, {
                type: 'doughnut',
                data: {
                    labels: data.dailyDistribution.map(d => d.dayName),
                    datasets: [{
                        data: data.dailyDistribution.map(d => d.totalAppointments),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(72, 187, 120, 0.8)',
                            'rgba(237, 137, 54, 0.8)',
                            'rgba(245, 101, 101, 0.8)',
                            'rgba(147, 51, 234, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(251, 146, 60, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // Funnel Chart
            const funnelCtx = document.getElementById('funnelChart').getContext('2d');
            const funnelData = data.funnel.length > 0 ? data.funnel[0] : {
                leadsGenerated: 0,
                callsMade: 0,
                appointmentsScheduled: 0,
                appointmentsConfirmed: 0,
                appointmentsCompleted: 0
            };
            
            new Chart(funnelCtx, {
                type: 'bar',
                data: {
                    labels: ['Leads', 'Calls', 'Scheduled', 'Confirmed', 'Completed'],
                    datasets: [{
                        label: 'Conversion Funnel',
                        data: [
                            funnelData.leadsGenerated,
                            funnelData.callsMade,
                            funnelData.appointmentsScheduled,
                            funnelData.appointmentsConfirmed,
                            funnelData.appointmentsCompleted
                        ],
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(72, 187, 120, 0.8)',
                            'rgba(237, 137, 54, 0.8)',
                            'rgba(245, 101, 101, 0.8)',
                            'rgba(147, 51, 234, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        async function loadAppointmentInsights() {
            try {
                const response = await fetch('/api/admin/appointments/insights');
                const insights = await response.json();
                
                // Update insights content
                const insightsContent = document.getElementById('insightsContent');
                insightsContent.innerHTML = `
                    <div class="insight-item">
                        <h4>📊 Performance Summary</h4>
                        <p>No-show rate: <strong>${insights.avgNoShowRate.toFixed(1)}%</strong> 
                        (Industry benchmark: ${insights.industryBenchmark}%)</p>
                        <p>Performance vs benchmark: <strong>${insights.performanceVsBenchmark > 0 ? '+' : ''}${insights.performanceVsBenchmark.toFixed(1)}%</strong></p>
                    </div>
                    <div class="insight-item">
                        <h4>⏰ Best Performing Times</h4>
                        <p>Best hour: <strong>${insights.bestHour || 'N/A'}:00</strong></p>
                        <p>Best day: <strong>${insights.bestDay !== null ? ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][insights.bestDay] : 'N/A'}</strong></p>
                    </div>
                    <div class="insight-item">
                        <h4>⚠️ Areas for Improvement</h4>
                        <p>Worst hour: <strong>${insights.worstHour || 'N/A'}:00</strong></p>
                        <p>Worst day: <strong>${insights.worstDay !== null ? ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][insights.worstDay] : 'N/A'}</strong></p>
                    </div>
                `;
                
                // Update recommendations
                const recommendationsContent = document.getElementById('recommendationsContent');
                recommendationsContent.innerHTML = insights.recommendations.map(rec => `
                    <div class="recommendation-item">
                        <p>💡 ${rec}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading appointment insights:', error);
            }
        }

        async function loadAppointmentList() {
            try {
                const response = await fetch('/api/admin/appointments/list');
                const appointments = await response.json();
                updateAppointmentsTable(appointments);
            } catch (error) {
                console.error('Error loading appointment list:', error);
            }
        }

        function updateAppointmentsTable(appointments) {
            const tbody = document.getElementById('appointmentsBody');
            const table = document.getElementById('appointmentsTable');
            const loading = document.getElementById('appointmentsLoading');
            
            if (appointments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #718096;">No appointments found</td></tr>';
            } else {
                tbody.innerHTML = appointments.map(apt => `
                    <tr>
                        <td>${apt.clientName || apt.clientKey}</td>
                        <td>
                            <div class="lead-info">
                                <strong>${apt.leadName || 'Unknown'}</strong>
                                ${apt.leadPhone ? `<br><small>${apt.leadPhone}</small>` : ''}
                            </div>
                        </td>
                        <td>${formatDateTime(apt.appointmentTime)}</td>
                        <td>${apt.durationMinutes} min</td>
                        <td>
                            <span class="status-badge ${getAppointmentStatusClass(apt.status)}">
                                ${apt.status}
                            </span>
                        </td>
                        <td>${apt.outcome || '-'}</td>
                        <td>£${apt.revenue.toFixed(2)}</td>
                        <td>${apt.serviceType || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="viewAppointmentDetails('${apt.appointmentId}')">👁️ View</button>
                                <button class="btn btn-sm btn-warning" onclick="editAppointment('${apt.appointmentId}')">✏️ Edit</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
            
            loading.style.display = 'none';
            table.style.display = 'table';
        }

        function getAppointmentStatusClass(status) {
            switch(status) {
                case 'completed': return 'status-active';
                case 'confirmed': return 'status-active';
                case 'scheduled': return 'status-pending';
                case 'no_show': return 'status-inactive';
                case 'cancelled': return 'status-inactive';
                case 'rescheduled': return 'status-pending';
                default: return 'status-inactive';
            }
        }

        function showAppointmentTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.appointment-tab').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById('appointment' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).style.display = 'block';
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load data for specific tab
            if (tabName === 'list') {
                loadAppointmentList();
            }
        }

        function searchAppointments() {
            const searchTerm = document.getElementById('appointmentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#appointmentsBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function filterAppointments() {
            const statusFilter = document.getElementById('appointmentStatusFilter').value;
            const dateFrom = document.getElementById('appointmentDateFrom').value;
            const dateTo = document.getElementById('appointmentDateTo').value;
            
            const rows = document.querySelectorAll('#appointmentsBody tr');
            
            rows.forEach(row => {
                const statusBadge = row.querySelector('.status-badge');
                const appointmentTime = row.cells[2].textContent;
                
                let show = true;
                
                if (statusFilter && statusBadge.textContent.toLowerCase() !== statusFilter.toLowerCase()) {
                    show = false;
                }
                
                if (dateFrom && new Date(appointmentTime) < new Date(dateFrom)) {
                    show = false;
                }
                
                if (dateTo && new Date(appointmentTime) > new Date(dateTo)) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }

        async function updateFunnel() {
            try {
                const response = await fetch('/api/admin/appointments/analytics/update-funnel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: new Date().toISOString().split('T')[0] })
                });
                
                if (response.ok) {
                    showNotification('Funnel data updated successfully!', 'success');
                    loadAppointments(); // Refresh data
                } else {
                    const error = await response.json();
                    showNotification(`Failed to update funnel: ${error.error}`, 'error');
                }
            } catch (error) {
                showNotification(`Error updating funnel: ${error.message}`, 'error');
            }
        }

        function viewAppointmentDetails(appointmentId) {
            // Open appointment details modal or navigate to details page
            showNotification(`Viewing appointment ${appointmentId}`, 'info');
        }

        function editAppointment(appointmentId) {
            // Open appointment edit modal
            showNotification(`Editing appointment ${appointmentId}`, 'info');
        }

        async function loadAnalytics() {
            try {
                const response = await fetch('/api/admin/analytics');
                const data = await response.json();
                updateAnalytics(data);
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        async function loadSystemHealth() {
            try {
                const response = await fetch('/api/admin/system-health');
                const data = await response.json();
                updateSystemHealth(data);
            } catch (error) {
                console.error('Error loading system health:', error);
            }
        }

        // Client management functions
        async function viewClient(clientKey) {
            // Navigate to detailed client profile page
            window.location.href = `/client-profile.html?client=${clientKey}`;
        }

        async function editClient(clientKey) {
            const newName = prompt('Enter new client name:', '');
            if (newName) {
                try {
                    const response = await fetch(`/api/admin/client/${clientKey}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ displayName: newName })
                    });
                    
                    if (response.ok) {
                        alert('Client updated successfully!');
                        if (socket && socket.connected) {
                            socket.emit('request-update', 'clients');
                        } else {
                            loadClients();
                        }
                    } else {
                        alert('Error updating client');
                    }
                } catch (error) {
                    console.error('Error updating client:', error);
                    alert('Error updating client');
                }
            }
        }

        async function deleteClient(clientKey, clientName) {
            if (confirm(`Are you sure you want to delete "${clientName}"? This action cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/admin/client/${clientKey}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert('Client deleted successfully!');
                        if (socket && socket.connected) {
                            socket.emit('request-update', 'clients');
                        } else {
                            loadClients();
                        }
                    } else {
                        alert('Error deleting client');
                    }
                } catch (error) {
                    console.error('Error deleting client:', error);
                    alert('Error deleting client');
                }
            }
        }

        // Modal functions
        function showAddClientModal() {
            document.getElementById('addClientModal').style.display = 'block';
        }

        function closeAddClientModal() {
            document.getElementById('addClientModal').style.display = 'none';
            document.getElementById('addClientForm').reset();
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
            document.getElementById('addUserForm').reset();
        }

        function showNotifications() {
            document.getElementById('notificationsModal').style.display = 'block';
            loadNotifications();
        }

        function closeNotificationsModal() {
            document.getElementById('notificationsModal').style.display = 'none';
        }

        // Add client form submission
        document.getElementById('addClientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                displayName: document.getElementById('clientName').value,
                industry: document.getElementById('clientIndustry').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                address: document.getElementById('clientAddress').value,
                website: document.getElementById('clientWebsite').value,
                description: document.getElementById('clientDescription').value,
                timezone: document.getElementById('clientTimezone').value
            };
            
            try {
                const response = await fetch('/api/admin/client', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert('Client created successfully!');
                    closeAddClientModal();
                    if (socket && socket.connected) {
                        socket.emit('request-update', 'clients');
                    } else {
                        loadClients();
                    }
                } else {
                    alert('Error creating client');
                }
            } catch (error) {
                console.error('Error creating client:', error);
                alert('Error creating client');
            }
        });

        // Add user form submission
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                username: document.getElementById('username').value,
                email: document.getElementById('userEmail').value,
                role: document.getElementById('userRole').value,
                password: document.getElementById('userPassword').value
            };
            
            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert('User created successfully!');
                    closeAddUserModal();
                    loadUsers();
                } else {
                    alert('Error creating user');
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Error creating user');
            }
        });

        // Search and filter functions
        function searchClients() {
            const query = document.getElementById('clientSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#clientsBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }

        function filterClients() {
            const statusFilter = document.getElementById('clientFilter').value;
            const industryFilter = document.getElementById('industryFilter').value;
            const revenueFilter = document.getElementById('revenueFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const rows = document.querySelectorAll('#clientsBody tr');
            
            rows.forEach(row => {
                const statusBadge = row.querySelector('.status-badge');
                const industry = row.cells[2].textContent;
                const revenueText = row.cells[7].textContent; // Revenue column
                const revenue = parseInt(revenueText.replace(/[£,\s]/g, '')) || 0;
                
                let show = true;
                
                if (statusFilter && !statusBadge.classList.contains(`status-${statusFilter}`)) {
                    show = false;
                }
                
                if (industryFilter && industry !== industryFilter) {
                    show = false;
                }
                
                if (revenueFilter) {
                    if (revenueFilter === '0-500' && (revenue < 0 || revenue > 500)) show = false;
                    if (revenueFilter === '500-1000' && (revenue < 500 || revenue > 1000)) show = false;
                    if (revenueFilter === '1000+' && revenue < 1000) show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }
        
        function saveCurrentFilter() {
            const filters = {
                status: document.getElementById('clientFilter').value,
                industry: document.getElementById('industryFilter').value,
                revenue: document.getElementById('revenueFilter').value,
                dateFrom: document.getElementById('dateFrom').value,
                dateTo: document.getElementById('dateTo').value
            };
            
            const name = prompt('Enter a name for this filter view:');
            if (name) {
                localStorage.setItem(`savedFilter_${name}`, JSON.stringify(filters));
                alert(`Filter view "${name}" saved!`);
            }
        }
        
        function loadSavedView() {
            const view = document.getElementById('savedViews').value;
            
            switch(view) {
                case 'all-active':
                    document.getElementById('clientFilter').value = 'active';
                    break;
                case 'high-value':
                    document.getElementById('revenueFilter').value = '1000+';
                    break;
                case 'recent':
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                    document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];
                    break;
                case 'low-conversion':
                    // This would require custom logic to filter by conversion rate
                    alert('Low conversion filter requires backend support');
                    return;
            }
            
            if (view) filterClients();
        }
        
        function clearAllFilters() {
            document.getElementById('clientSearch').value = '';
            document.getElementById('clientFilter').value = '';
            document.getElementById('industryFilter').value = '';
            document.getElementById('revenueFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('savedViews').value = '';
            filterClients();
        }
        
        async function performGlobalSearch() {
            const query = document.getElementById('globalSearch').value.trim();
            const resultsDiv = document.getElementById('globalSearchResults');
            
            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            try {
                // Search across clients, calls, and leads
                const [clientsRes, callsRes] = await Promise.all([
                    fetch('/api/admin/clients'),
                    fetch('/api/admin/calls')
                ]);
                
                const clients = await clientsRes.json();
                const calls = await callsRes.json();
                
                const results = [];
                
                // Search clients
                clients.forEach(client => {
                    const searchText = `${client.name} ${client.email} ${client.clientKey}`.toLowerCase();
                    if (searchText.includes(query.toLowerCase())) {
                        results.push({
                            type: 'Client',
                            title: client.name,
                            subtitle: client.email,
                            action: () => window.location.href = `/client-profile.html?client=${client.clientKey}`
                        });
                    }
                });
                
                // Search calls
                calls.slice(0, 50).forEach(call => {
                    const searchText = `${call.phone} ${call.outcome || ''} ${call.status}`.toLowerCase();
                    if (searchText.includes(query.toLowerCase())) {
                        results.push({
                            type: 'Call',
                            title: call.phone,
                            subtitle: `${call.status} • ${call.outcome || 'No outcome'}`,
                            action: () => showSection('calls')
                        });
                    }
                });
                
                // Display results
                if (results.length > 0) {
                    resultsDiv.innerHTML = results.slice(0, 10).map(result => `
                        <div class="search-result-item" onclick="${result.action.toString().replace(/\n/g, ' ')}; document.getElementById('globalSearchResults').style.display='none';">
                            <div class="search-result-type">${result.type}</div>
                            <div class="search-result-title">${result.title}</div>
                            <div class="search-result-subtitle">${result.subtitle}</div>
                        </div>
                    `).join('');
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.innerHTML = '<div class="search-result-item" style="cursor: default;"><div class="search-result-subtitle">No results found</div></div>';
                    resultsDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Global search error:', error);
            }
        }
        
        // Close search results when clicking outside
        document.addEventListener('click', function(event) {
            const globalSearch = document.getElementById('globalSearch');
            const globalSearchResults = document.getElementById('globalSearchResults');
            
            if (!globalSearch.contains(event.target) && !globalSearchResults.contains(event.target)) {
                globalSearchResults.style.display = 'none';
            }
        });

        function searchCalls() {
            const query = document.getElementById('callSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#callsBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query) ? '' : 'none';
            });
        }

        function filterCalls() {
            const statusFilter = document.getElementById('callStatusFilter').value;
            const outcomeFilter = document.getElementById('callOutcomeFilter').value;
            const rows = document.querySelectorAll('#callsBody tr');
            
            rows.forEach(row => {
                const status = row.cells[2].textContent.toLowerCase();
                const outcome = row.cells[3].textContent.toLowerCase();
                
                let show = true;
                
                if (statusFilter && !status.includes(statusFilter)) {
                    show = false;
                }
                
                if (outcomeFilter && !outcome.includes(outcomeFilter)) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }

        // Bulk operations
        function selectAllClients() {
            const checkboxes = document.querySelectorAll('.client-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                selectedClients.add(checkbox.value);
            });
            updateBulkDeleteButton();
        }

        function toggleAllClients() {
            const selectAll = document.getElementById('selectAllClients');
            const checkboxes = document.querySelectorAll('.client-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedClients.add(checkbox.value);
                } else {
                    selectedClients.delete(checkbox.value);
                }
            });
            updateBulkDeleteButton();
        }

        function toggleClientSelection(clientKey) {
            if (selectedClients.has(clientKey)) {
                selectedClients.delete(clientKey);
            } else {
                selectedClients.add(clientKey);
            }
            updateBulkDeleteButton();
        }

        function updateBulkDeleteButton() {
            const bulkActionBtn = document.getElementById('bulkActionBtn');
            const selectionInfo = document.getElementById('selectionInfo');
            const selectionCount = document.getElementById('selectionCount');
            
            bulkActionBtn.disabled = selectedClients.size === 0;
            
            if (selectedClients.size > 0) {
                selectionInfo.style.display = 'block';
                selectionCount.textContent = selectedClients.size;
            } else {
                selectionInfo.style.display = 'none';
            }
        }
        
        function clearSelection() {
            selectedClients.clear();
            document.querySelectorAll('.client-checkbox').forEach(cb => cb.checked = false);
            updateBulkDeleteButton();
        }
        
        // Toggle dropdown menu
        document.addEventListener('click', function(event) {
            const bulkActionBtn = document.getElementById('bulkActionBtn');
            const bulkActionMenu = document.getElementById('bulkActionMenu');
            
            if (event.target === bulkActionBtn) {
                bulkActionMenu.style.display = bulkActionMenu.style.display === 'none' ? 'block' : 'none';
            } else if (!bulkActionMenu.contains(event.target)) {
                bulkActionMenu.style.display = 'none';
            }
        });
        
        async function bulkExportSelected() {
            if (selectedClients.size === 0) return;
            
            const clientKeys = Array.from(selectedClients);
            const tag = clientKeys.join(',');
            exportData('clients', 'csv', tag);
            bulkActionMenu.style.display = 'none';
        }
        
        async function bulkTagClients() {
            if (selectedClients.size === 0) return;
            
            const tag = prompt('Enter tag to add to selected clients:');
            if (tag) {
                alert(`Tag "${tag}" would be added to ${selectedClients.size} clients (feature coming soon)`);
            }
            bulkActionMenu.style.display = 'none';
        }
        
        async function bulkUpdateStatus() {
            if (selectedClients.size === 0) return;
            
            const status = prompt('Enter new status (active/inactive):');
            if (status) {
                alert(`Status "${status}" would be updated for ${selectedClients.size} clients (feature coming soon)`);
            }
            bulkActionMenu.style.display = 'none';
        }

        async function bulkDeleteClients() {
            if (selectedClients.size === 0) return;
            
            if (confirm(`Are you sure you want to delete ${selectedClients.size} clients? This action cannot be undone.`)) {
                try {
                    const items = Array.from(selectedClients).map(clientKey => ({ clientKey }));
                    const response = await fetch('/api/admin/bulk/clients', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ items, action: 'delete' })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`Successfully processed ${result.processed} clients`);
                        selectedClients.clear();
                        updateBulkDeleteButton();
                        if (socket && socket.connected) {
                            socket.emit('request-update', 'clients');
                        } else {
                            loadClients();
                        }
                    } else {
                        alert('Error performing bulk delete');
                    }
                } catch (error) {
                    console.error('Error performing bulk delete:', error);
                    alert('Error performing bulk delete');
                }
            }
        }

        // Export functions
        function exportData(type, format) {
            window.open(`/api/admin/export/${type}?format=${format}`, '_blank');
        }

        // Refresh all data
        function refreshAllData() {
            if (socket && socket.connected) {
                socket.emit('request-update', 'all');
            } else {
                loadOverview();
                loadClients();
                loadCalls();
                loadAnalytics();
                loadSystemHealth();
            }
        }

        // Mark notification as read
        async function markNotificationRead(notificationId) {
            try {
                const response = await fetch(`/api/admin/notifications/${notificationId}/read`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadNotifications();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            initWebSocket();
            
            // Load initial data
            setTimeout(() => {
                if (socket && socket.connected) {
                    socket.emit('request-update', 'all');
                } else {
                    loadOverview();
                }
            }, 1000);
        });
    </script>
</body>
</html>
