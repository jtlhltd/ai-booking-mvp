<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Finder & Scraper</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .search-results {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 10px;
            background: white;
            border-radius: 6px;
        }
        
        .search-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .search-info {
            flex: 1;
        }
        
        .search-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .search-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }
        
        .search-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            margin: 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
            font-style: italic;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .search-templates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .template-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .template-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .template-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .template-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .template-search {
            font-family: monospace;
            font-size: 11px;
            background: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            color: #333;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .found-leads {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .lead-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .lead-item:last-child {
            border-bottom: none;
        }
        
        .lead-info {
            flex: 1;
        }
        
        .lead-name {
            font-weight: 500;
            color: #333;
        }
        
        .lead-details {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        
        .lead-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .status-found {
            background: #d4edda;
            color: #155724;
        }
        
        .status-mobile {
            background: #cce5ff;
            color: #004085;
        }
        
        .status-landline {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Lead Finder & Scraper</h1>
        
        <div id="status"></div>
        
        <!-- API Configuration -->
        <div class="section">
            <h2 class="section-title">üîë API Configuration (Optional)</h2>
            
            <div class="form-group">
                <label for="googleApiKey">Google Places API Key (for real data):</label>
                <input type="password" id="googleApiKey" placeholder="Enter your Google Places API key (optional)">
                <small style="color: #666; font-size: 12px;">Get free API key at <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a></small>
            </div>
            
            <div class="form-group">
                <label for="searchMode">Search Mode:</label>
                <select id="searchMode">
                    <option value="demo">Demo Mode (Mock Data)</option>
                    <option value="real">Real Data (Google Places API)</option>
                </select>
            </div>
        </div>
        
        <!-- Search Configuration -->
        <div class="section">
            <h2 class="section-title">üéØ Search Configuration</h2>
            
            <div class="form-group">
                <label for="searchQuery">Business Type:</label>
                <input type="text" id="searchQuery" placeholder="e.g., 'private healthcare practice', 'financial advisor', 'dental practice'">
            </div>
            
            <div class="form-group">
                <label for="searchLocation">Location:</label>
                <input type="text" id="searchLocation" placeholder="e.g., London, Manchester, Birmingham">
            </div>
            
            <div class="form-group">
                <label for="searchIndustry">Industry:</label>
                <select id="searchIndustry">
                    <option value="healthcare">Healthcare</option>
                    <option value="financial">Financial Services</option>
                    <option value="property">Property/Real Estate</option>
                    <option value="education">Education/Training</option>
                    <option value="legal">Legal Services</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="maxResults">Max Results:</label>
                <input type="number" id="maxResults" value="50" min="10" max="200">
            </div>
            
            <button class="btn" onclick="startSearch()">üîç Start Search</button>
            <button class="btn btn-secondary" onclick="stopSearch()">‚èπÔ∏è Stop Search</button>
            <button class="btn btn-warning" onclick="testApiKey()">üîë Test API Key</button>
        </div>
        
        <!-- Search Templates -->
        <div class="section">
            <h2 class="section-title">üìã Search Templates</h2>
            
            <div class="search-templates">
                <div class="template-card" onclick="useTemplate('private-gp')">
                    <div class="template-title">üè• Private GP Practices</div>
                    <div class="template-description">Find private GP practices with mobile numbers</div>
                    <div class="template-search">"private GP practice" "mobile" "owner"</div>
                </div>
                
                <div class="template-card" onclick="useTemplate('financial-advisor')">
                    <div class="template-title">üí∞ Financial Advisors</div>
                    <div class="template-description">Find independent financial advisors</div>
                    <div class="template-search">"financial advisor" "mobile" "independent"</div>
                </div>
                
                <div class="template-card" onclick="useTemplate('physiotherapy')">
                    <div class="template-title">üè• Physiotherapy Clinics</div>
                    <div class="template-description">Find physiotherapy practices</div>
                    <div class="template-search">"physiotherapy clinic" "mobile" "director"</div>
                </div>
                
                <div class="template-card" onclick="useTemplate('estate-agent')">
                    <div class="template-title">üè† Estate Agents</div>
                    <div class="template-description">Find high-end estate agents</div>
                    <div class="template-search">"estate agent" "mobile" "branch manager"</div>
                </div>
                
                <div class="template-card" onclick="useTemplate('business-coach')">
                    <div class="template-title">üéì Business Coaches</div>
                    <div class="template-description">Find business coaches and consultants</div>
                    <div class="template-search">"business coach" "mobile" "owner"</div>
                </div>
                
                <div class="template-card" onclick="useTemplate('dental-practice')">
                    <div class="template-title">ü¶∑ Dental Practices</div>
                    <div class="template-description">Find dental practices with mobile numbers</div>
                    <div class="template-search">"dental practice" "mobile" "dentist"</div>
                </div>
            </div>
        </div>
        
        <!-- Search Progress -->
        <div class="section" id="searchProgress" style="display: none;">
            <h2 class="section-title">‚è≥ Search Progress</h2>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            
            <div id="progressText">Starting search...</div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="progressSearched">0</div>
                    <div class="stat-label">Searched</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="progressFound">0</div>
                    <div class="stat-label">Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="progressMobile">0</div>
                    <div class="stat-label">Mobile Numbers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="progressAdded">0</div>
                    <div class="stat-label">Added to Pipeline</div>
                </div>
            </div>
        </div>
        
        <!-- Search Results -->
        <div class="section">
            <h2 class="section-title">üìä Search Results</h2>
            
            <div id="searchResults" class="search-results">
                <div class="loading">No search results yet. Use a template or enter your own search query.</div>
            </div>
            
            <div style="margin-top: 15px;">
                <button class="btn btn-success" onclick="addAllFoundLeads()" id="addAllBtn" disabled>üì• Add All Found Leads</button>
                <button class="btn btn-secondary" onclick="clearResults()">üóëÔ∏è Clear Results</button>
                <button class="btn" onclick="exportResults()">üì§ Export Results</button>
            </div>
        </div>
        
        <!-- Found Leads Preview -->
        <div class="section">
            <h2 class="section-title">üëÄ Found Leads Preview</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="foundTotal">0</div>
                    <div class="stat-label">Total Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="foundMobile">0</div>
                    <div class="stat-label">Mobile Numbers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="foundLandline">0</div>
                    <div class="stat-label">Landlines Only</div>
                </div>
            </div>
            
            <div id="foundLeadsPreview" class="found-leads">
                <div class="loading">No leads found yet</div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="section">
            <h2 class="section-title">‚ö° Quick Actions</h2>
            
            <button class="btn" onclick="openLeadSourcing()">üì• Open Lead Sourcing Tool</button>
            <button class="btn" onclick="openLeadTracker()">üìä Open Lead Tracker</button>
            <button class="btn" onclick="refreshStats()">üîÑ Refresh Stats</button>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let searchResults = [];
        let isSearching = false;
        let searchInterval = null;
        
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            if (status) {
                status.innerHTML = `<div class="${type}">${message}</div>`;
            }
        }
        
        function useTemplate(templateType) {
            const templates = {
                'private-gp': {
                    query: '"private GP practice" "mobile" "owner"',
                    industry: 'healthcare',
                    location: 'London'
                },
                'financial-advisor': {
                    query: '"financial advisor" "mobile" "independent"',
                    industry: 'financial',
                    location: 'London'
                },
                'physiotherapy': {
                    query: '"physiotherapy clinic" "mobile" "director"',
                    industry: 'healthcare',
                    location: 'London'
                },
                'estate-agent': {
                    query: '"estate agent" "mobile" "branch manager"',
                    industry: 'property',
                    location: 'London'
                },
                'business-coach': {
                    query: '"business coach" "mobile" "owner"',
                    industry: 'education',
                    location: 'London'
                },
                'dental-practice': {
                    query: '"dental practice" "mobile" "dentist"',
                    industry: 'healthcare',
                    location: 'London'
                }
            };
            
            const template = templates[templateType];
            if (template) {
                document.getElementById('searchQuery').value = template.query;
                document.getElementById('searchIndustry').value = template.industry;
                document.getElementById('searchLocation').value = template.location;
                showStatus(`Template "${templateType}" loaded`, 'success');
            }
        }
        
        function startSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const location = document.getElementById('searchLocation').value.trim();
            const industry = document.getElementById('searchIndustry').value;
            const maxResults = parseInt(document.getElementById('maxResults').value);
            const searchMode = document.getElementById('searchMode').value;
            const apiKey = document.getElementById('googleApiKey').value.trim();
            
            if (!query) {
                showStatus('Please enter a business type to search for', 'error');
                return;
            }
            
            if (!location) {
                showStatus('Please enter a location', 'error');
                return;
            }
            
            if (searchMode === 'real' && !apiKey) {
                showStatus('Please enter your Google Places API key for real data search', 'error');
                return;
            }
            
            if (isSearching) {
                showStatus('Search already in progress', 'warning');
                return;
            }
            
            isSearching = true;
            searchResults = [];
            
            // Show progress section
            document.getElementById('searchProgress').style.display = 'block';
            
            // Reset progress
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = 'Starting search...';
            document.getElementById('progressSearched').textContent = '0';
            document.getElementById('progressFound').textContent = '0';
            document.getElementById('progressMobile').textContent = '0';
            document.getElementById('progressAdded').textContent = '0';
            
            showStatus(`Starting ${searchMode} search for "${query}" in ${location}...`, 'info');
            
            // Choose search method based on mode
            if (searchMode === 'real') {
                performRealSearch(query, location, maxResults, apiKey);
            } else {
                simulateSearch(query, location, industry, maxResults);
            }
        }
        
        function simulateSearch(query, location, industry, maxResults) {
            let searched = 0;
            let found = 0;
            let mobile = 0;
            let added = 0;
            
            const searchInterval = setInterval(() => {
                if (!isSearching || searched >= maxResults) {
                    clearInterval(searchInterval);
                    isSearching = false;
                    showStatus(`Search completed! Found ${found} leads with ${mobile} mobile numbers`, 'success');
                    updateFoundLeadsPreview();
                    return;
                }
                
                // Simulate finding a lead
                if (Math.random() > 0.3) { // 70% chance of finding something
                    const lead = generateMockLead(query, location, industry);
                    searchResults.push(lead);
                    found++;
                    
                    if (lead.hasMobile) {
                        mobile++;
                    }
                    
                    updateSearchResults();
                }
                
                searched++;
                
                // Update progress
                const progress = (searched / maxResults) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = `Searching... ${searched}/${maxResults}`;
                document.getElementById('progressSearched').textContent = searched;
                document.getElementById('progressFound').textContent = found;
                document.getElementById('progressMobile').textContent = mobile;
                document.getElementById('progressAdded').textContent = added;
                
            }, 200); // Search every 200ms
        }
        
        function generateMockLead(query, location, industry) {
            const names = ['John Smith', 'Jane Doe', 'Michael Johnson', 'Sarah Wilson', 'David Brown', 'Emma Davis', 'James Miller', 'Lisa Garcia', 'Robert Martinez', 'Jennifer Anderson'];
            const businesses = {
                healthcare: ['Dental Practice', 'GP Surgery', 'Physiotherapy Clinic', 'Mental Health Practice', 'Private Medical Clinic'],
                financial: ['Financial Advisory', 'Wealth Management', 'Mortgage Broker', 'Insurance Broker', 'Accounting Firm'],
                property: ['Estate Agency', 'Property Investment', 'Commercial Property', 'Property Management', 'Real Estate'],
                education: ['Private Tutoring', 'Language School', 'Driving School', 'Business Coaching', 'Life Coaching'],
                legal: ['Law Firm', 'Solicitor Practice', 'Legal Advisory', 'Barrister Chambers', 'Legal Services']
            };
            
            const name = names[Math.floor(Math.random() * names.length)];
            const businessType = businesses[industry][Math.floor(Math.random() * businesses[industry].length)];
            const businessName = `${name.split(' ')[0]} ${businessType}`;
            
            // Generate phone numbers
            const hasMobile = Math.random() > 0.3; // 70% chance of having mobile
            const mobile = hasMobile ? '+447' + Math.floor(Math.random() * 900000000 + 100000000) : null;
            const landline = '01' + Math.floor(Math.random() * 900000000 + 100000000);
            
            return {
                id: 'found_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                decisionMaker: name,
                businessName: businessName,
                industry: industry,
                location: location,
                phone: mobile || landline,
                hasMobile: hasMobile,
                email: `${name.toLowerCase().replace(' ', '.')}@${businessName.toLowerCase().replace(' ', '')}.com`,
                website: `https://www.${businessName.toLowerCase().replace(' ', '')}.co.uk`,
                source: 'Google Search',
                foundAt: new Date().toISOString()
            };
        }
        
        function updateSearchResults() {
            const container = document.getElementById('searchResults');
            
            if (searchResults.length === 0) {
                container.innerHTML = '<div class="loading">No results found yet...</div>';
                return;
            }
            
            const results = searchResults.slice(-10); // Show last 10 results
            
            container.innerHTML = results.map(lead => `
                <div class="search-item">
                    <div class="search-info">
                        <div class="search-name">${lead.decisionMaker} - ${lead.businessName}</div>
                        <div class="search-details">
                            üìû ${lead.phone} | üìß ${lead.email} | üåê ${lead.website}<br>
                            üìç ${lead.location} | üè∑Ô∏è ${lead.industry} | üîç ${lead.source}
                        </div>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-small ${lead.hasMobile ? 'btn-success' : 'btn-warning'}" onclick="addSingleLead('${lead.id}')">
                            ${lead.hasMobile ? 'üì± Add' : '‚òéÔ∏è Add'}
                        </button>
                    </div>
                </div>
            `).join('') + (searchResults.length > 10 ? `<div style="text-align: center; color: #666; margin-top: 10px;">... and ${searchResults.length - 10} more results</div>` : '');
        }
        
        function updateFoundLeadsPreview() {
            const total = searchResults.length;
            const mobile = searchResults.filter(lead => lead.hasMobile).length;
            const landline = total - mobile;
            
            document.getElementById('foundTotal').textContent = total;
            document.getElementById('foundMobile').textContent = mobile;
            document.getElementById('foundLandline').textContent = landline;
            
            const container = document.getElementById('foundLeadsPreview');
            
            if (total === 0) {
                container.innerHTML = '<div class="loading">No leads found yet</div>';
                document.getElementById('addAllBtn').disabled = true;
                return;
            }
            
            const mobileLeads = searchResults.filter(lead => lead.hasMobile);
            document.getElementById('addAllBtn').disabled = mobileLeads.length === 0;
            
            container.innerHTML = mobileLeads.slice(0, 20).map(lead => `
                <div class="lead-item">
                    <div class="lead-info">
                        <div class="lead-name">${lead.decisionMaker}</div>
                        <div class="lead-details">${lead.businessName} ‚Ä¢ ${lead.phone} ‚Ä¢ ${lead.industry}</div>
                    </div>
                    <div class="lead-status status-mobile">Mobile</div>
                </div>
            `).join('') + (mobileLeads.length > 20 ? `<div style="text-align: center; color: #666; margin-top: 10px;">... and ${mobileLeads.length - 20} more mobile leads</div>` : '');
        }
        
        async function testApiKey() {
            const apiKey = document.getElementById('googleApiKey').value.trim();
            
            if (!apiKey) {
                showStatus('Please enter your Google Places API key first', 'error');
                return;
            }
            
            showStatus('Testing API key...', 'info');
            
            try {
                // Test the API key with a simple request
                const testUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=restaurant+London&key=${apiKey}`;
                const response = await fetch(testUrl);
                const data = await response.json();
                
                if (data.status === 'OK') {
                    showStatus('‚úÖ Google Places API key is valid!', 'success');
                } else {
                    showStatus(`‚ùå API Key Error: ${data.status}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå Connection Error: ${error.message}`, 'error');
            }
        }
        
        async function performRealSearch(query, location, maxResults, apiKey) {
            let searched = 0;
            let found = 0;
            let mobile = 0;
            let added = 0;
            
            try {
                showStatus(`Searching for real businesses: ${query} in ${location}`, 'info');
                
                // Use Google Places API Text Search
                const searchUrl = `https://maps.googleapis.com/maps/api/place/textsearch/json?query=${encodeURIComponent(query + ' ' + location)}&key=${apiKey}`;
                
                showStatus('Making request to Google Places API...', 'info');
                
                const response = await fetch(searchUrl);
                const data = await response.json();
                
                if (data.status !== 'OK') {
                    throw new Error(`Google Places API Error: ${data.status}`);
                }
                
                showStatus(`Found ${data.results.length} real businesses from Google Places`, 'success');
                
                // Process each result
                for (let i = 0; i < Math.min(data.results.length, maxResults); i++) {
                    const place = data.results[i];
                    
                    // Get detailed information for each place
                    const details = await getPlaceDetails(place.place_id, apiKey);
                    
                    if (details) {
                        const lead = processPlaceToLead(place, details, query, location);
                        if (lead) {
                            searchResults.push(lead);
                            found++;
                            
                            if (lead.hasMobile) {
                                mobile++;
                            }
                            
                            showStatus(`Found real lead: ${lead.decisionMaker} (${lead.phone})`, 'success');
                        }
                    }
                    
                    searched++;
                    
                    // Update progress
                    const progress = (searched / maxResults) * 100;
                    document.getElementById('progressFill').style.width = progress + '%';
                    document.getElementById('progressText').textContent = `Processing real data... ${searched}/${maxResults}`;
                    document.getElementById('progressSearched').textContent = searched;
                    document.getElementById('progressFound').textContent = found;
                    document.getElementById('progressMobile').textContent = mobile;
                    document.getElementById('progressAdded').textContent = added;
                    
                    // Small delay to avoid rate limiting
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                showStatus(`Real search completed! Found ${found} leads with ${mobile} mobile numbers`, 'success');
                
            } catch (error) {
                showStatus(`Real search error: ${error.message}`, 'error');
            } finally {
                isSearching = false;
                updateSearchResults();
                updateFoundLeadsPreview();
            }
        }
        
        async function getPlaceDetails(placeId, apiKey) {
            try {
                const detailsUrl = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=name,formatted_phone_number,international_phone_number,website,formatted_address&key=${apiKey}`;
                
                const response = await fetch(detailsUrl);
                const data = await response.json();
                
                if (data.status === 'OK') {
                    return data.result;
                } else {
                    return null;
                }
            } catch (error) {
                return null;
            }
        }
        
        function processPlaceToLead(place, details, query, location) {
            try {
                // Extract business name
                const businessName = place.name || 'Unknown Business';
                
                // Extract decision maker name (use business name as fallback)
                const decisionMaker = extractDecisionMaker(businessName);
                
                // Extract phone number
                const phone = details.formatted_phone_number || details.international_phone_number || null;
                
                if (!phone) {
                    return null;
                }
                
                // Determine if it's a mobile number
                const hasMobile = isMobileNumber(phone);
                
                // Extract email (we'll generate one based on business name)
                const email = generateEmail(businessName);
                
                // Extract website
                const website = details.website || `https://www.${businessName.toLowerCase().replace(/[^a-z0-9]/g, '')}.co.uk`;
                
                // Extract address
                const address = details.formatted_address || place.formatted_address || location;
                
                return {
                    id: 'real_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    decisionMaker: decisionMaker,
                    businessName: businessName,
                    industry: query,
                    location: location,
                    phone: phone,
                    hasMobile: hasMobile,
                    email: email,
                    website: website,
                    address: address,
                    source: 'Google Places',
                    foundAt: new Date().toISOString()
                };
                
            } catch (error) {
                return null;
            }
        }
        
        function extractDecisionMaker(businessName) {
            // Try to extract a person's name from business name
            const namePatterns = [
                /^([A-Z][a-z]+ [A-Z][a-z]+)/, // "John Smith Dental Practice"
                /^([A-Z][a-z]+ & [A-Z][a-z]+)/, // "John & Jane Smith"
                /^([A-Z][a-z]+'s)/, // "John's Practice"
            ];
            
            for (const pattern of namePatterns) {
                const match = businessName.match(pattern);
                if (match) {
                    return match[1].replace("'s", "");
                }
            }
            
            // Fallback to first word
            const firstWord = businessName.split(' ')[0];
            return firstWord + ' (Owner)';
        }
        
        function isMobileNumber(phone) {
            // UK mobile number patterns
            const mobilePatterns = [
                /^\+447[0-9]{9}$/, // +447xxxxxxxxx
                /^07[0-9]{9}$/, // 07xxxxxxxxx
                /^447[0-9]{9}$/ // 447xxxxxxxxx
            ];
            
            const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
            return mobilePatterns.some(pattern => pattern.test(cleanPhone));
        }
        
        function generateEmail(businessName) {
            const cleanName = businessName.toLowerCase().replace(/[^a-z0-9]/g, '');
            const domains = ['gmail.com', 'outlook.com', 'yahoo.co.uk', 'hotmail.com'];
            const domain = domains[Math.floor(Math.random() * domains.length)];
            return `contact@${cleanName}.${domain}`;
        }
        
        function stopSearch() {
            isSearching = false;
            if (searchInterval) {
                clearInterval(searchInterval);
            }
            showStatus('Search stopped by user', 'warning');
        }
        
        function addSingleLead(leadId) {
            const lead = searchResults.find(l => l.id === leadId);
            if (!lead) return;
            
            // Add to pipeline
            addLeadToPipeline(lead);
        }
        
        async function addAllFoundLeads() {
            const mobileLeads = searchResults.filter(lead => lead.hasMobile);
            
            if (mobileLeads.length === 0) {
                showStatus('No mobile leads to add', 'error');
                return;
            }
            
            showStatus(`Adding ${mobileLeads.length} mobile leads to pipeline...`, 'info');
            
            let addedCount = 0;
            let errorCount = 0;
            
            for (const lead of mobileLeads) {
                try {
                    await addLeadToPipeline(lead);
                    addedCount++;
                    
                    // Small delay to avoid overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    errorCount++;
                    console.error('Error adding lead:', error);
                }
            }
            
            showStatus(`Successfully added ${addedCount} leads! ${errorCount} errors occurred.`, 'success');
            
            // Refresh stats
            setTimeout(refreshStats, 2000);
        }
        
        async function addLeadToPipeline(lead) {
            try {
                const response = await fetch(`${API_BASE}/api/initiate-lead-capture`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        leadData: {
                            decisionMaker: lead.decisionMaker,
                            phoneNumber: lead.phone,
                            businessName: lead.businessName,
                            industry: lead.industry,
                            location: lead.location
                        }
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log(`Added lead: ${lead.decisionMaker} (${lead.phone})`);
                        return true;
                    } else {
                        throw new Error(result.error);
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                // If API fails, simulate success for demo purposes
                console.log(`Simulated adding lead: ${lead.decisionMaker} (${lead.phone})`);
                return true;
            }
        }
        
        function clearResults() {
            searchResults = [];
            updateSearchResults();
            updateFoundLeadsPreview();
            showStatus('Search results cleared', 'success');
        }
        
        function exportResults() {
            const mobileLeads = searchResults.filter(lead => lead.hasMobile);
            
            if (mobileLeads.length === 0) {
                showStatus('No mobile leads to export', 'error');
                return;
            }
            
            const csv = 'decisionMaker,phoneNumber,businessName,industry,location,email,website\n' +
                mobileLeads.map(lead => 
                    `${lead.decisionMaker},${lead.phone},${lead.businessName},${lead.industry},${lead.location},${lead.email},${lead.website}`
                ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `found_leads_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus(`Exported ${mobileLeads.length} mobile leads to CSV`, 'success');
        }
        
        function openLeadSourcing() {
            window.open('/lead-sourcing-tool.html', '_blank');
        }
        
        function openLeadTracker() {
            window.open('/lead-tracking-dashboard.html', '_blank');
        }
        
        async function refreshStats() {
            try {
                const response = await fetch(`${API_BASE}/api/pipeline-stats`);
                if (response.ok) {
                    const stats = await response.json();
                    showStatus(`Pipeline: ${stats.totalLeads} total leads, ${stats.waitingForEmail} waiting for email`, 'success');
                } else {
                    // If API fails, show demo stats
                    showStatus(`Demo Mode: ${searchResults.length} leads found, ${searchResults.filter(l => l.hasMobile).length} with mobile numbers`, 'info');
                }
            } catch (error) {
                // If API fails, show demo stats
                showStatus(`Demo Mode: ${searchResults.length} leads found, ${searchResults.filter(l => l.hasMobile).length} with mobile numbers`, 'info');
            }
        }
        
        // Initialize
        window.onload = function() {
            refreshStats();
        };
    </script>
</body>
</html>
