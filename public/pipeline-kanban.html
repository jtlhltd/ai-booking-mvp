<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Pipeline - Kanban Board</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        .header {
            background: #ffffff;
            border-radius: 8px;
            padding: 24px 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e5e5e5;
        }

        .header h1 {
            color: #1a1a1a;
            font-size: 1.75rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        .stats {
            display: flex;
            gap: 20px;
        }

        .stat-card {
            background: #ffffff;
            color: #1a1a1a;
            padding: 16px 24px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid #e5e5e5;
            min-width: 120px;
        }

        .stat-card .value {
            font-size: 1.75rem;
            font-weight: 600;
            color: #000000;
        }

        .stat-card .label {
            font-size: 0.75rem;
            color: #666666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .pipeline-board {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 20px;
        }

        .stage-column {
            background: #ffffff;
            border-radius: 6px;
            padding: 16px;
            min-width: 300px;
            max-width: 300px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e5e5;
        }

        .stage-header {
            border-bottom: 1px solid #e5e5e5;
            padding-bottom: 12px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stage-header h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1a1a1a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stage-count {
            background: #f5f5f5;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #666666;
        }

        .lead-card {
            background: #ffffff;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: move;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            border: 1px solid #e5e5e5;
            border-left: 3px solid #999999;
        }

        .lead-card:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-color: #d0d0d0;
        }

        .lead-card.priority-high {
            border-left-color: #1a1a1a;
        }

        .lead-card.priority-medium {
            border-left-color: #666666;
        }

        .lead-card.priority-low {
            border-left-color: #999999;
        }

        .lead-name {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 6px;
            font-size: 0.875rem;
        }

        .lead-info {
            font-size: 0.75rem;
            color: #666666;
            margin-bottom: 4px;
        }

        .lead-score {
            display: inline-block;
            background: #f5f5f5;
            color: #1a1a1a;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.6875rem;
            font-weight: 600;
            margin-top: 8px;
            border: 1px solid #e5e5e5;
        }

        .drag-over {
            background: #f9f9f9;
            border: 2px dashed #999999;
        }

        .dragging {
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666666;
            font-size: 0.875rem;
        }

        .empty-stage {
            text-align: center;
            padding: 40px 20px;
            color: #999999;
            font-size: 0.75rem;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .pipeline-board {
                flex-direction: column;
            }

            .stage-column {
                min-width: 100%;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Sales Pipeline</h1>
            <div class="stats">
                <div class="stat-card">
                    <div class="value" id="totalLeads">0</div>
                    <div class="label">Total Leads</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="conversionRate">0%</div>
                    <div class="label">Conversion Rate</div>
                </div>
            </div>
        </div>

        <div id="pipelineBoard" class="pipeline-board">
            <div class="loading">Loading pipeline...</div>
        </div>
    </div>

    <script>
        const socket = io();
        let pipelineData = null;

        // Load pipeline data
        async function loadPipeline() {
            try {
                const response = await fetch('/api/admin/pipeline');
                pipelineData = await response.json();
                renderPipeline();
                
                // Update stats
                document.getElementById('totalLeads').textContent = pipelineData.totalLeads;
                document.getElementById('conversionRate').textContent = pipelineData.conversionRate + '%';
            } catch (error) {
                console.error('Error loading pipeline:', error);
                document.getElementById('pipelineBoard').innerHTML = '<div class="loading">Error loading pipeline</div>';
            }
        }

        // Render pipeline board
        function renderPipeline() {
            const board = document.getElementById('pipelineBoard');
            board.innerHTML = '';

            pipelineData.stages.forEach(stage => {
                const column = document.createElement('div');
                column.className = 'stage-column';
                column.style.borderTopColor = stage.color;
                column.dataset.stageId = stage.id;
                
                column.innerHTML = `
                    <div class="stage-header" style="border-color: ${stage.color}">
                        <h3>${stage.name}</h3>
                        <span class="stage-count">${stage.count}</span>
                    </div>
                    <div class="stage-content" data-stage="${stage.id}">
                        ${stage.leads.length === 0 ? '<div class="empty-stage">No leads</div>' : ''}
                    </div>
                `;

                // Add leads to column
                const content = column.querySelector('.stage-content');
                stage.leads.forEach(lead => {
                    const card = createLeadCard(lead);
                    content.appendChild(card);
                });

                // Make droppable
                makeDroppable(column);

                board.appendChild(column);
            });
        }

        // Create lead card
        function createLeadCard(lead) {
            const card = document.createElement('div');
            card.className = `lead-card priority-${lead.priority || 'medium'}`;
            card.draggable = true;
            card.dataset.leadId = lead.id;
            
            const clientName = lead.client_name || 'Unknown Client';
            const industry = lead.industry || 'Unknown';
            const callCount = lead.call_count || 0;
            
            card.innerHTML = `
                <div class="lead-name">${lead.name || 'Unnamed Lead'}</div>
                <div class="lead-info">üìû ${lead.phone}</div>
                <div class="lead-info">üè¢ ${clientName}</div>
                <div class="lead-info">üìà ${callCount} calls</div>
                <div class="lead-score">Score: ${lead.score || 0}</div>
            `;

            // Make draggable
            makeDraggable(card);

            return card;
        }

        // Make card draggable
        function makeDraggable(card) {
            card.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', card.dataset.leadId);
                card.classList.add('dragging');
            });

            card.addEventListener('dragend', (e) => {
                card.classList.remove('dragging');
            });
        }

        // Make column droppable
        function makeDroppable(column) {
            const stageContent = column.querySelector('.stage-content');
            
            stageContent.addEventListener('dragover', (e) => {
                e.preventDefault();
                stageContent.classList.add('drag-over');
            });

            stageContent.addEventListener('dragleave', (e) => {
                stageContent.classList.remove('drag-over');
            });

            stageContent.addEventListener('drop', async (e) => {
                e.preventDefault();
                stageContent.classList.remove('drag-over');
                
                const leadId = e.dataTransfer.getData('text/plain');
                const targetStage = column.dataset.stageId;
                
                // Update lead stage
                await updateLeadStage(leadId, targetStage);
            });
        }

        // Update lead stage
        async function updateLeadStage(leadId, targetStage) {
            try {
                const response = await fetch(`/api/admin/pipeline/lead/${leadId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stage: targetStage })
                });

                if (response.ok) {
                    // Reload pipeline
                    await loadPipeline();
                }
            } catch (error) {
                console.error('Error updating lead stage:', error);
            }
        }

        // Listen for real-time updates
        socket.on('pipeline-update', (data) => {
            console.log('Pipeline update:', data);
            loadPipeline();
        });

        // Initial load
        loadPipeline();

        // Auto-refresh every 30 seconds
        setInterval(loadPipeline, 30000);
    </script>
</body>
</html>
