# Cursor Rules — Vapi AI-Booking-MVP

## Scope & Safety
- Modify ONLY what’s necessary for the task. Minimal diffs.
- Do NOT refactor unrelated areas or reformat whole files.
- Preserve existing behavior for other tenants and all existing logs.
- Keep all new helpers tiny and self-contained, placed near existing helpers.
- No new env vars unless explicitly requested; prefer existing config/DB fields.

## Coding Conventions
- Node 20. CommonJS or ESM: keep consistent with current file.
- Logging: Use the repo’s existing structured logs. Do NOT remove logs.
  - Prefer these tags exactly: 
    - `[INBOUND SMS]` `[LEAD OPT-IN YES]` `[LEAD OPT-IN START]` `[LEAD OPT-OUT STOP]`
    - `[AUTO-CALL TRIGGER]` `[TENANT RESOLVE OK]` `[TENANT RESOLVE AMBIGUOUS]` `[TENANT RESOLVE FAIL]`
    - `[IDEMPOTENT SKIP]` `[TENANT CHECK]` `[CHANGE]`
- Phone normalization: use `normalizePhoneE164(input, 'GB')`. Keep ALL returns inside the helper.

## Multi-Tenant Guardrails
- Tenant resolution precedence:
  1) `X-Client-Key` header (if present)
  2) Exact `To` match vs. tenant `sms.fromNumber` (E.164)
  3) `MessagingServiceSid` match
  - Log success/ambiguous/fail with the tags above and continue only on success.
  - Twilio webhook must always 200 OK (even on failures) with no side-effects on fail.

## Tests & Acceptance
- Add/adjust only lightweight tests/comments or admin diagnostics.
- Provide a short acceptance checklist (inputs, expected logs, outputs, side-effects).
- Whenever you add behavior, also specify a quick PowerShell/HTTP smoke test.

## Commits & Changelog
- Use **Conventional Commits**:
  - `feat(inbound): …` `fix(tenant): …` `chore(admin): …` `refactor(logs): …`
- ALWAYS update `CHANGELOG.md` under `## [Unreleased]` with a one-line summary.
- Prefer: commit → push → (Render auto-deploy) → run smoke test.

## Forbidden
- No broad rewrites, no mass linting, no package upgrades, no schema changes unless task requests it.
- No secrets in code or logs. Respect existing auth guards for `/admin/*` routes.

